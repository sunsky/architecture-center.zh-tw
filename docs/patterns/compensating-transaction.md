---
title: 補償交易模式
titleSuffix: Cloud Design Patterns
description: 復原由一系列步驟執行的工作，這些步驟共同定義最終一致的作業。
keywords: 設計模式
author: dragon119
ms.date: 06/23/2017
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: 5cefef36b7c763324de2e962d47509b1d1b2c968
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58242989"
---
# <a name="compensating-transaction-pattern"></a><span data-ttu-id="8b92a-104">補償交易模式</span><span class="sxs-lookup"><span data-stu-id="8b92a-104">Compensating Transaction pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="8b92a-105">如果一或多個步驟失敗，請復原由一系列步驟執行的工作，這些步驟共同定義最終的一致作業。</span><span class="sxs-lookup"><span data-stu-id="8b92a-105">Undo the work performed by a series of steps, which together define an eventually consistent operation, if one or more of the steps fail.</span></span> <span data-ttu-id="8b92a-106">依照最終一致性模型來執行的作業，經常可在實作複雜商業程序和工作流程的雲端裝載應用程式中發現。</span><span class="sxs-lookup"><span data-stu-id="8b92a-106">Operations that follow the eventual consistency model are commonly found in cloud-hosted applications that implement complex business processes and workflows.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="8b92a-107">內容和問題</span><span class="sxs-lookup"><span data-stu-id="8b92a-107">Context and problem</span></span>

<span data-ttu-id="8b92a-108">在雲端中執行的應用程式經常會修改資料。</span><span class="sxs-lookup"><span data-stu-id="8b92a-108">Applications running in the cloud frequently modify data.</span></span> <span data-ttu-id="8b92a-109">此資料可能散佈在保存於不同地理位置的各種不同資料來源。</span><span class="sxs-lookup"><span data-stu-id="8b92a-109">This data might be spread across various data sources held in different geographic locations.</span></span> <span data-ttu-id="8b92a-110">為了避免分散式環境中出現競爭並改善效能，應用程式不應嘗試提供強式交易一致性。</span><span class="sxs-lookup"><span data-stu-id="8b92a-110">To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency.</span></span> <span data-ttu-id="8b92a-111">相反地，應用程式應實作最終一致性。</span><span class="sxs-lookup"><span data-stu-id="8b92a-111">Rather, the application should implement eventual consistency.</span></span> <span data-ttu-id="8b92a-112">在此模型中，一般商業作業包含一系列個別的步驟。</span><span class="sxs-lookup"><span data-stu-id="8b92a-112">In this model, a typical business operation consists of a series of separate steps.</span></span> <span data-ttu-id="8b92a-113">執行這些步驟時，系統狀態整體看來可能會不一致，但當作業完成並執行所有步驟之後，系統應會再次變得一致。</span><span class="sxs-lookup"><span data-stu-id="8b92a-113">While these steps are being performed, the overall view of the system state might be inconsistent, but when the operation has completed and all of the steps have been executed the system should become consistent again.</span></span>

> <span data-ttu-id="8b92a-114">[資料一致性入門](https://msdn.microsoft.com/library/dn589800.aspx) \(英文\) 提供為什麼分散式交易不能縮放自如，以及最終一致性模型原則的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="8b92a-114">The [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) provides information about why distributed transactions don't scale well, and the principles of the eventual consistency model.</span></span>

<span data-ttu-id="8b92a-115">最終一致性模型的挑戰之一是如何處理失敗的步驟。</span><span class="sxs-lookup"><span data-stu-id="8b92a-115">A challenge in the eventual consistency model is how to handle a step that has failed.</span></span> <span data-ttu-id="8b92a-116">在此情況下，可能必須復原作業中所有先前步驟完成的所有工作。</span><span class="sxs-lookup"><span data-stu-id="8b92a-116">In this case it might be necessary to undo all of the work completed by the previous steps in the operation.</span></span> <span data-ttu-id="8b92a-117">不過，因為應用程式的其他並行執行個體可能已變更該資料，所以無法直接復原資料。</span><span class="sxs-lookup"><span data-stu-id="8b92a-117">However, the data can't simply be rolled back because other concurrent instances of the application might have changed it.</span></span> <span data-ttu-id="8b92a-118">即使在資料未由並行執行個體變更的情況下，復原步驟也不只是還原為原始狀態。</span><span class="sxs-lookup"><span data-stu-id="8b92a-118">Even in cases where the data hasn't been changed by a concurrent instance, undoing a step might not simply be a matter of restoring the original state.</span></span> <span data-ttu-id="8b92a-119">可能必須套用各種不同的商務特有規則 (請參閱「範例」一節所述的旅遊網站)。</span><span class="sxs-lookup"><span data-stu-id="8b92a-119">It might be necessary to apply various business-specific rules (see the travel website described in the Example section).</span></span>

<span data-ttu-id="8b92a-120">如果實作最終一致性的作業橫跨數個異質資料存放區，復原作業中的步驟將需要依序造訪每個資料存放區。</span><span class="sxs-lookup"><span data-stu-id="8b92a-120">If an operation that implements eventual consistency spans several heterogeneous data stores, undoing the steps in the operation will require visiting each data store in turn.</span></span> <span data-ttu-id="8b92a-121">在每個資料存放區中執行的工作必須可靠地復原，才能防止系統留有不一致之處。</span><span class="sxs-lookup"><span data-stu-id="8b92a-121">The work performed in every data store must be undone reliably to prevent the system from remaining inconsistent.</span></span>

<span data-ttu-id="8b92a-122">並非受到實作最終一致性的作業影響的所有資料都會保留在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="8b92a-122">Not all data affected by an operation that implements eventual consistency might be held in a database.</span></span> <span data-ttu-id="8b92a-123">在服務導向架構 (SOA) 環境中，作業會叫用服務中的動作並造成該服務的狀態變更。</span><span class="sxs-lookup"><span data-stu-id="8b92a-123">In a service oriented architecture (SOA) environment an operation could invoke an action in a service, and cause a change in the state held by that service.</span></span> <span data-ttu-id="8b92a-124">若要復原作業，也必須復原此狀態變更。</span><span class="sxs-lookup"><span data-stu-id="8b92a-124">To undo the operation, this state change must also be undone.</span></span> <span data-ttu-id="8b92a-125">這可能涉及再次叫用服務，以及執行另一個動作以反轉第一個動作的效果。</span><span class="sxs-lookup"><span data-stu-id="8b92a-125">This can involve invoking the service again and performing another action that reverses the effects of the first.</span></span>

## <a name="solution"></a><span data-ttu-id="8b92a-126">解決方法</span><span class="sxs-lookup"><span data-stu-id="8b92a-126">Solution</span></span>

<span data-ttu-id="8b92a-127">解決方式就是實作補償交易。</span><span class="sxs-lookup"><span data-stu-id="8b92a-127">The solution is to implement a compensating transaction.</span></span> <span data-ttu-id="8b92a-128">補償交易中的步驟必須將原始作業中的步驟效果復原。</span><span class="sxs-lookup"><span data-stu-id="8b92a-128">The steps in a compensating transaction must undo the effects of the steps in the original operation.</span></span> <span data-ttu-id="8b92a-129">因為補償交易會覆寫應用程式之其他並行執行個體所做的變更，所以這種方法可能無法以作業之初的系統狀態取代目前的狀態。</span><span class="sxs-lookup"><span data-stu-id="8b92a-129">A compensating transaction might not be able to simply replace the current state with the state the system was in at the start of the operation because this approach could overwrite changes made by other concurrent instances of an application.</span></span> <span data-ttu-id="8b92a-130">相反地，必須採用考慮到並行執行個體所完成之任何工作的智慧型程序。</span><span class="sxs-lookup"><span data-stu-id="8b92a-130">Instead, it must be an intelligent process that takes into account any work done by concurrent instances.</span></span> <span data-ttu-id="8b92a-131">此程序通常是應用程式特有，受到原始作業所執行工作的本質驅動。</span><span class="sxs-lookup"><span data-stu-id="8b92a-131">This process will usually be application specific, driven by the nature of the work performed by the original operation.</span></span>

<span data-ttu-id="8b92a-132">常見的方法是使用工作流程來實作需要補償的最終一致性作業。</span><span class="sxs-lookup"><span data-stu-id="8b92a-132">A common approach is to use a workflow to implement an eventually consistent operation that requires compensation.</span></span> <span data-ttu-id="8b92a-133">系統會隨著原始作業不斷進行，記錄每個步驟和能如何復原該步驟所執行工作的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="8b92a-133">As the original operation proceeds, the system records information about each step and how the work performed by that step can be undone.</span></span> <span data-ttu-id="8b92a-134">如果作業在任何時間點失敗，工作流程會倒轉回到已經完成的步驟，並執行可反轉每個步驟的工作。</span><span class="sxs-lookup"><span data-stu-id="8b92a-134">If the operation fails at any point, the workflow rewinds back through the steps it's completed and performs the work that reverses each step.</span></span> <span data-ttu-id="8b92a-135">請注意，補償交易可能不必依照原始作業的順序反向復原，而且能平行執行一些復原步驟。</span><span class="sxs-lookup"><span data-stu-id="8b92a-135">Note that a compensating transaction might not have to undo the work in the exact reverse order of the original operation, and it might be possible to perform some of the undo steps in parallel.</span></span>

> <span data-ttu-id="8b92a-136">這種方法類似於 [Clemens Vasters 部落格](https://vasters.com/clemensv/2012/09/01/Sagas.aspx) \(英文\) 中所述的 Sagas 策略。</span><span class="sxs-lookup"><span data-stu-id="8b92a-136">This approach is similar to the Sagas strategy discussed in [Clemens Vasters’ blog](https://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span></span>

<span data-ttu-id="8b92a-137">補償交易也是最終一致性作業，而且也可能會失敗。</span><span class="sxs-lookup"><span data-stu-id="8b92a-137">A compensating transaction is also an eventually consistent operation and it could also fail.</span></span> <span data-ttu-id="8b92a-138">系統應能夠在失敗時恢復補償交易並繼續。</span><span class="sxs-lookup"><span data-stu-id="8b92a-138">The system should be able to resume the compensating transaction at the point of failure and continue.</span></span> <span data-ttu-id="8b92a-139">因為可能需要重複失敗的步驟，所以應將補償交易中的步驟定義為等冪命令。</span><span class="sxs-lookup"><span data-stu-id="8b92a-139">It might be necessary to repeat a step that's failed, so the steps in a compensating transaction should be defined as idempotent commands.</span></span> <span data-ttu-id="8b92a-140">如需詳細資訊，請參閱 Jonathan Oliver 部落格上的[等冪模式](https://blog.jonathanoliver.com/idempotency-patterns/) \(英文\)。</span><span class="sxs-lookup"><span data-stu-id="8b92a-140">For more information, see [Idempotency Patterns](https://blog.jonathanoliver.com/idempotency-patterns/) on Jonathan Oliver’s blog.</span></span>

<span data-ttu-id="8b92a-141">在某些情況下，可能無法從失敗的步驟復原，除了手動介入，別無他法。</span><span class="sxs-lookup"><span data-stu-id="8b92a-141">In some cases it might not be possible to recover from a step that has failed except through manual intervention.</span></span> <span data-ttu-id="8b92a-142">在這些情況下，系統應會引發警示，並儘可能提供失敗原因的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="8b92a-142">In these situations the system should raise an alert and provide as much information as possible about the reason for the failure.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="8b92a-143">問題和考量</span><span class="sxs-lookup"><span data-stu-id="8b92a-143">Issues and considerations</span></span>

<span data-ttu-id="8b92a-144">當您決定如何實作此模式時，請考慮下列幾點：</span><span class="sxs-lookup"><span data-stu-id="8b92a-144">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="8b92a-145">要判斷實作最終一致性之作業中的步驟何時失敗，可能並不容易。</span><span class="sxs-lookup"><span data-stu-id="8b92a-145">It might not be easy to determine when a step in an operation that implements eventual consistency has failed.</span></span> <span data-ttu-id="8b92a-146">步驟可能不會立即失敗，而是造成後續步驟無法執行。</span><span class="sxs-lookup"><span data-stu-id="8b92a-146">A step might not fail immediately, but instead could block.</span></span> <span data-ttu-id="8b92a-147">可能必須實作某種形式的逾時機制。</span><span class="sxs-lookup"><span data-stu-id="8b92a-147">It might be necessary to implement some form of time-out mechanism.</span></span>

<span data-ttu-id="8b92a-148">- 補償邏輯並不容易一般化。</span><span class="sxs-lookup"><span data-stu-id="8b92a-148">-Compensation logic isn't easily generalized.</span></span> <span data-ttu-id="8b92a-149">補償交易是應用程式特有。</span><span class="sxs-lookup"><span data-stu-id="8b92a-149">A compensating transaction is application specific.</span></span> <span data-ttu-id="8b92a-150">全賴應用程式有足夠的資訊，才能復原失敗作業中每個步驟的效果。</span><span class="sxs-lookup"><span data-stu-id="8b92a-150">It relies on the application having sufficient information to be able to undo the effects of each step in a failed operation.</span></span>

<span data-ttu-id="8b92a-151">您應該將補償交易中的步驟定義為等冪命令。</span><span class="sxs-lookup"><span data-stu-id="8b92a-151">You should define the steps in a compensating transaction as idempotent commands.</span></span> <span data-ttu-id="8b92a-152">這可在補償交易本身失敗時，重複執行步驟。</span><span class="sxs-lookup"><span data-stu-id="8b92a-152">This enables the steps to be repeated if the compensating transaction itself fails.</span></span>

<span data-ttu-id="8b92a-153">處理原始作業中步驟的基礎結構和補償交易都必須具有復原功能。</span><span class="sxs-lookup"><span data-stu-id="8b92a-153">The infrastructure that handles the steps in the original operation, and the compensating transaction, must be resilient.</span></span> <span data-ttu-id="8b92a-154">它不得遺失補償失敗步驟所需的資訊，也必須可靠地監視補償邏輯的進度。</span><span class="sxs-lookup"><span data-stu-id="8b92a-154">It must not lose the information required to compensate for a failing step, and it must be able to reliably monitor the progress of the compensation logic.</span></span>

<span data-ttu-id="8b92a-155">補償交易不一定會讓系統中的資料回到原始作業之初的狀態。</span><span class="sxs-lookup"><span data-stu-id="8b92a-155">A compensating transaction doesn't necessarily return the data in the system to the state it was in at the start of the original operation.</span></span> <span data-ttu-id="8b92a-156">相反地，它會補償該步驟在作業失敗之前已順利完成執行的工作。</span><span class="sxs-lookup"><span data-stu-id="8b92a-156">Instead, it compensates for the work performed by the steps that completed successfully before the operation failed.</span></span>

<span data-ttu-id="8b92a-157">補償交易中步驟的順序不一定要和原始作業中的步驟完全相反。</span><span class="sxs-lookup"><span data-stu-id="8b92a-157">The order of the steps in the compensating transaction doesn't necessarily have to be the exact opposite of the steps in the original operation.</span></span> <span data-ttu-id="8b92a-158">例如，某個資料存放區對於不一致的情況可能會比另一個資料存放區更敏感，因此補償交易中的步驟應該先復原此存放區的變更。</span><span class="sxs-lookup"><span data-stu-id="8b92a-158">For example, one data store might be more sensitive to inconsistencies than another, and so the steps in the compensating transaction that undo the changes to this store should occur first.</span></span>

<span data-ttu-id="8b92a-159">在完成作業所需的每個資源放置短期逾時型鎖定，並事先取得這些資源，有助於提升整體活動成功的可能性。</span><span class="sxs-lookup"><span data-stu-id="8b92a-159">Placing a short-term timeout-based lock on each resource that's required to complete an operation, and obtaining these resources in advance, can help increase the likelihood that the overall activity will succeed.</span></span> <span data-ttu-id="8b92a-160">應只有在取得所有資源之後，才執行工作。</span><span class="sxs-lookup"><span data-stu-id="8b92a-160">The work should be performed only after all the resources have been acquired.</span></span> <span data-ttu-id="8b92a-161">所有動作都必須在鎖定到期之前完成。</span><span class="sxs-lookup"><span data-stu-id="8b92a-161">All actions must be finalized before the locks expire.</span></span>

<span data-ttu-id="8b92a-162">請考慮使用比平常更寬鬆的重試邏輯，以將會觸發補償交易的失敗減至最少。</span><span class="sxs-lookup"><span data-stu-id="8b92a-162">Consider using retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction.</span></span> <span data-ttu-id="8b92a-163">如果實作最終一致性的作業中有步驟失敗，請嘗試將該失敗視為暫時性例外狀況來處理，並重複執行該步驟。</span><span class="sxs-lookup"><span data-stu-id="8b92a-163">If a step in an operation that implements eventual consistency fails, try handling the failure as a transient exception and repeat the step.</span></span> <span data-ttu-id="8b92a-164">只有在步驟不斷失敗或永久失敗時，才停止該作業並起始補償交易。</span><span class="sxs-lookup"><span data-stu-id="8b92a-164">Only stop the operation and initiate a compensating transaction if a step fails repeatedly or irrecoverably.</span></span>

> <span data-ttu-id="8b92a-165">實作補償交易的多項挑戰和實作最終一致性的挑戰相同。</span><span class="sxs-lookup"><span data-stu-id="8b92a-165">Many of the challenges of implementing a compensating transaction are the same as those with implementing eventual consistency.</span></span> <span data-ttu-id="8b92a-166">如需實作最終一致性的詳細資訊，請參閱[資料一致性入門](https://msdn.microsoft.com/library/dn589800.aspx) \(英文\) 中的「實作最終一致性的考量」一節。</span><span class="sxs-lookup"><span data-stu-id="8b92a-166">See the section Considerations for Implementing Eventual Consistency in the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for more information.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="8b92a-167">使用此模式的時機</span><span class="sxs-lookup"><span data-stu-id="8b92a-167">When to use this pattern</span></span>

<span data-ttu-id="8b92a-168">只針對失敗時必須復原的作業使用此模式。</span><span class="sxs-lookup"><span data-stu-id="8b92a-168">Use this pattern only for operations that must be undone if they fail.</span></span> <span data-ttu-id="8b92a-169">設計解決方案時，請盡量避免採用複雜的補償交易。</span><span class="sxs-lookup"><span data-stu-id="8b92a-169">If possible, design solutions to avoid the complexity of requiring compensating transactions.</span></span>

## <a name="example"></a><span data-ttu-id="8b92a-170">範例</span><span class="sxs-lookup"><span data-stu-id="8b92a-170">Example</span></span>

<span data-ttu-id="8b92a-171">旅遊網站可讓客戶預訂行程。</span><span class="sxs-lookup"><span data-stu-id="8b92a-171">A travel website lets customers book itineraries.</span></span> <span data-ttu-id="8b92a-172">單一行程可能包含一系列航班和旅館。</span><span class="sxs-lookup"><span data-stu-id="8b92a-172">A single itinerary might comprise a series of flights and hotels.</span></span> <span data-ttu-id="8b92a-173">從西雅圖前往倫敦再到巴黎的客戶，建立行程時會執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="8b92a-173">A customer traveling from Seattle to London and then on to Paris could perform the following steps when creating an itinerary:</span></span>

1. <span data-ttu-id="8b92a-174">預訂從西雅圖飛往倫敦的 F1 航班座位。</span><span class="sxs-lookup"><span data-stu-id="8b92a-174">Book a seat on flight F1 from Seattle to London.</span></span>
2. <span data-ttu-id="8b92a-175">預訂從倫敦飛往巴黎的 F2 航班座位。</span><span class="sxs-lookup"><span data-stu-id="8b92a-175">Book a seat on flight F2 from London to Paris.</span></span>
3. <span data-ttu-id="8b92a-176">預訂從巴黎飛往西雅圖的 F3 航班座位。</span><span class="sxs-lookup"><span data-stu-id="8b92a-176">Book a seat on flight F3 from Paris to Seattle.</span></span>
4. <span data-ttu-id="8b92a-177">在倫敦的 H1 旅館訂房。</span><span class="sxs-lookup"><span data-stu-id="8b92a-177">Reserve a room at hotel H1 in London.</span></span>
5. <span data-ttu-id="8b92a-178">在巴黎的 H2 旅館訂房。</span><span class="sxs-lookup"><span data-stu-id="8b92a-178">Reserve a room at hotel H2 in Paris.</span></span>

<span data-ttu-id="8b92a-179">雖然每個步驟都是個別的動作，但這些步驟會構成最終一致性作業。</span><span class="sxs-lookup"><span data-stu-id="8b92a-179">These steps constitute an eventually consistent operation, although each step is a separate action.</span></span> <span data-ttu-id="8b92a-180">因此，系統不但會執行這些步驟，也必須記錄復原每個步驟所需的反向作業，以在客戶決定取消行程時執行。</span><span class="sxs-lookup"><span data-stu-id="8b92a-180">Therefore, as well as performing these steps, the system must also record the counter operations necessary to undo each step in case the customer decides to cancel the itinerary.</span></span> <span data-ttu-id="8b92a-181">執行計數器作業所需的步驟，能以補償交易形式執行。</span><span class="sxs-lookup"><span data-stu-id="8b92a-181">The steps necessary to perform the counter operations can then run as a compensating transaction.</span></span>

<span data-ttu-id="8b92a-182">請注意，可能不會使用和原始步驟完全相反的順序來進行補償交易中的步驟，而且補償交易中每個步驟的邏輯都必須考慮到任何商務特有規則。</span><span class="sxs-lookup"><span data-stu-id="8b92a-182">Notice that the steps in the compensating transaction might not be the exact opposite of the original steps, and the logic in each step in the compensating transaction must take into account any business-specific rules.</span></span> <span data-ttu-id="8b92a-183">例如，取消航班訂位可能無法全額退還客戶已支付的任何款項。</span><span class="sxs-lookup"><span data-stu-id="8b92a-183">For example, unbooking a seat on a flight might not entitle the customer to a complete refund of any money paid.</span></span> <span data-ttu-id="8b92a-184">下圖說明產生補償交易以將長時間執行以預訂旅遊行程的交易復原。</span><span class="sxs-lookup"><span data-stu-id="8b92a-184">The figure illustrates generating a compensating transaction to undo a long-running transaction to book a travel itinerary.</span></span>

![產生補償交易以將長時間執行以預訂旅遊行程的交易復原](./_images/compensating-transaction-diagram.png)

> [!NOTE]
> <span data-ttu-id="8b92a-186">視您如何為每個步驟設計補償邏輯而定，可能可以平行執行補償交易中的步驟。</span><span class="sxs-lookup"><span data-stu-id="8b92a-186">It might be possible for the steps in the compensating transaction to be performed in parallel, depending on how you've designed the compensating logic for each step.</span></span>

<span data-ttu-id="8b92a-187">在許多商務解決方案中，單一步驟失敗時，不一定需要使用補償交易來復原系統。</span><span class="sxs-lookup"><span data-stu-id="8b92a-187">In many business solutions, failure of a single step doesn't always necessitate rolling the system back by using a compensating transaction.</span></span> <span data-ttu-id="8b92a-188">例如，&mdash;在旅遊網站案例中的 F1、F2 及 F3 航班訂位之後&mdash;如果客戶無法在 H1 旅館訂房，最好能為客戶提供同一城市但不同旅館的房間，而不是取消航班訂位。</span><span class="sxs-lookup"><span data-stu-id="8b92a-188">For example, if&mdash;after having booked flights F1, F2, and F3 in the travel website scenario&mdash;the customer is unable to reserve a room at hotel H1, it's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights.</span></span> <span data-ttu-id="8b92a-189">客戶仍可以決定取消 (此時，補償交易會執行並復原對 F1、F2 及 F3 航班的訂位)，但此決策應由客戶決定，而不是系統。</span><span class="sxs-lookup"><span data-stu-id="8b92a-189">The customer can still decide to cancel (in which case the compensating transaction runs and undoes the bookings made on flights F1, F2, and F3), but this decision should be made by the customer rather than by the system.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="8b92a-190">相關的模式和指導方針</span><span class="sxs-lookup"><span data-stu-id="8b92a-190">Related patterns and guidance</span></span>

<span data-ttu-id="8b92a-191">實作此模式時，下列模式和指導方針可能也相關：</span><span class="sxs-lookup"><span data-stu-id="8b92a-191">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="8b92a-192">[資料一致性入門](https://msdn.microsoft.com/library/dn589800.aspx)。</span><span class="sxs-lookup"><span data-stu-id="8b92a-192">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="8b92a-193">補償交易模式通常用來復原實作最終一致性模型的作業。</span><span class="sxs-lookup"><span data-stu-id="8b92a-193">The Compensating Transaction pattern is often used to undo operations that implement the eventual consistency model.</span></span> <span data-ttu-id="8b92a-194">此入門提供最終一致性優缺點的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="8b92a-194">This primer provides information on the benefits and tradeoffs of eventual consistency.</span></span>

- <span data-ttu-id="8b92a-195">[Scheduler-Agent-Supervisor 模式](./scheduler-agent-supervisor.md)。</span><span class="sxs-lookup"><span data-stu-id="8b92a-195">[Scheduler-Agent-Supervisor pattern](./scheduler-agent-supervisor.md).</span></span> <span data-ttu-id="8b92a-196">描述如何實作使用分散式服務與資源執行商務作業且具復原功能的系統。</span><span class="sxs-lookup"><span data-stu-id="8b92a-196">Describes how to implement resilient systems that perform business operations that use distributed services and resources.</span></span> <span data-ttu-id="8b92a-197">有時候，可能有必要使用補償交易來復原由作業所執行的工作。</span><span class="sxs-lookup"><span data-stu-id="8b92a-197">Sometimes, it might be necessary to undo the work performed by an operation by using a compensating transaction.</span></span>

- <span data-ttu-id="8b92a-198">[重試模式](./retry.md)。</span><span class="sxs-lookup"><span data-stu-id="8b92a-198">[Retry pattern](./retry.md).</span></span> <span data-ttu-id="8b92a-199">執行補償交易可能所費不貲，而遵循重試模式實作重試失敗作業的有效原則，可以將此一必要降至最低。</span><span class="sxs-lookup"><span data-stu-id="8b92a-199">Compensating transactions can be expensive to perform, and it might be possible to minimize their use by implementing an effective policy of retrying failing operations by following the Retry pattern.</span></span>
