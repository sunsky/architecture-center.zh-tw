---
title: Azure 服務的復原檢查清單
titleSuffix: Azure Design Review Framework
description: 檢查清單，提供各種 Azure 服務的復原指南。
author: petertaylor9999
ms.date: 11/26/2018
ms.custom: resiliency, checklist
ms.openlocfilehash: e1fb780cf9f54a5078cc5d3c6b597b351f93e05e
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2019
ms.locfileid: "54112663"
---
# <a name="resiliency-checklist-for-specific-azure-services"></a><span data-ttu-id="81a45-103">特定 Azure 服務的復原檢查清單</span><span class="sxs-lookup"><span data-stu-id="81a45-103">Resiliency checklist for specific Azure services</span></span>

<span data-ttu-id="81a45-104">復原是指系統從失敗中復原並繼續運作的能力，且是[軟體品質要素](../guide/pillars.md)的其中一項。</span><span class="sxs-lookup"><span data-stu-id="81a45-104">Resiliency is the ability of a system to recover from failures and continue to function, and is one of the [pillars of software quality](../guide/pillars.md).</span></span> <span data-ttu-id="81a45-105">每一種技術都有它自己的特定失敗模式，您必須在設計和實作應用程式時加以考量。</span><span class="sxs-lookup"><span data-stu-id="81a45-105">Every technology has its own particular failure modes, which you must consider when designing and implementing your application.</span></span> <span data-ttu-id="81a45-106">針對特定 Azure 服務使用此檢查清單來檢閱復原考量。</span><span class="sxs-lookup"><span data-stu-id="81a45-106">Use this checklist to review the resiliency considerations for specific Azure services.</span></span> <span data-ttu-id="81a45-107">同時檢閱[一般復原檢查清單](./resiliency.md)。</span><span class="sxs-lookup"><span data-stu-id="81a45-107">Also review the [general resiliency checklist](./resiliency.md).</span></span>

## <a name="app-service"></a><span data-ttu-id="81a45-108">App Service 方案</span><span class="sxs-lookup"><span data-stu-id="81a45-108">App Service</span></span>

<span data-ttu-id="81a45-109">**使用標準或進階層。**</span><span class="sxs-lookup"><span data-stu-id="81a45-109">**Use Standard or Premium tier.**</span></span> <span data-ttu-id="81a45-110">這些服務層可支援預備位置和自動化備份。</span><span class="sxs-lookup"><span data-stu-id="81a45-110">These tiers support staging slots and automated backups.</span></span> <span data-ttu-id="81a45-111">如需詳細資訊，請參閱 [Azure App Service 方案深入概觀](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)</span><span class="sxs-lookup"><span data-stu-id="81a45-111">For more information, see [Azure App Service plans in-depth overview](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)</span></span>

<span data-ttu-id="81a45-112">**避免相應增加或相應減少。**</span><span class="sxs-lookup"><span data-stu-id="81a45-112">**Avoid scaling up or down.**</span></span> <span data-ttu-id="81a45-113">請改為選取在一般負載下符合您效能需求的服務層和執行個體大小，然後[相應放大](/azure/app-service-web/web-sites-scale/)執行個體來處理流量的變更。</span><span class="sxs-lookup"><span data-stu-id="81a45-113">Instead, select a tier and instance size that meet your performance requirements under typical load, and then [scale out](/azure/app-service-web/web-sites-scale/) the instances to handle changes in traffic volume.</span></span> <span data-ttu-id="81a45-114">相應增加和減少可能會觸發應用程式重新啟動。</span><span class="sxs-lookup"><span data-stu-id="81a45-114">Scaling up and down may trigger an application restart.</span></span>

<span data-ttu-id="81a45-115">**將組態儲存為應用程式設定。**</span><span class="sxs-lookup"><span data-stu-id="81a45-115">**Store configuration as app settings.**</span></span> <span data-ttu-id="81a45-116">使用應用程式設定，將組態設定保留為應用程式設定。</span><span class="sxs-lookup"><span data-stu-id="81a45-116">Use app settings to hold configuration settings as app settings.</span></span> <span data-ttu-id="81a45-117">在您的 Resource Manager 範本 中或使用 PowerShell 來定義設定，以便您在更可靠的自動化部署 / 更新程序中套用它們。</span><span class="sxs-lookup"><span data-stu-id="81a45-117">Define the settings in your Resource Manager templates, or using PowerShell, so that you can apply them as part of an automated deployment / update process, which is more reliable.</span></span> <span data-ttu-id="81a45-118">如需詳細資訊，請參閱[在 Azure App Service 中設定 Web 應用程式](/azure/app-service-web/web-sites-configure/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-118">For more information, see [Configure web apps in Azure App Service](/azure/app-service-web/web-sites-configure/).</span></span>

<span data-ttu-id="81a45-119">**為生產和測試環境建立不同的 App Service 方案。**</span><span class="sxs-lookup"><span data-stu-id="81a45-119">**Create separate App Service plans for production and test.**</span></span> <span data-ttu-id="81a45-120">請勿使用生產部署上的位置進行測試。</span><span class="sxs-lookup"><span data-stu-id="81a45-120">Don't use slots on your production deployment for testing.</span></span>  <span data-ttu-id="81a45-121">相同 App Service 方案中的所有應用程式會共用相同的 VM 執行個體。</span><span class="sxs-lookup"><span data-stu-id="81a45-121">All apps within the same App Service plan share the same VM instances.</span></span> <span data-ttu-id="81a45-122">如果您將生產和測試部署放在相同的方案中，可能會對生產部署造成負面影響。</span><span class="sxs-lookup"><span data-stu-id="81a45-122">If you put production and test deployments in the same plan, it can negatively affect the production deployment.</span></span> <span data-ttu-id="81a45-123">例如，負載測試可能會使實際作用的生產網站降級。</span><span class="sxs-lookup"><span data-stu-id="81a45-123">For example, load tests might degrade the live production site.</span></span> <span data-ttu-id="81a45-124">透過將測試部署放在不同方案內，您可以使其與生產版本隔離。</span><span class="sxs-lookup"><span data-stu-id="81a45-124">By putting test deployments into a separate plan, you isolate them from the production version.</span></span>

<span data-ttu-id="81a45-125">**分隔 Web 應用程式與 Web API。**</span><span class="sxs-lookup"><span data-stu-id="81a45-125">**Separate web apps from web APIs.**</span></span> <span data-ttu-id="81a45-126">如果您的解決方案具有 Web 前端與 Web API，請考慮將它們分解成個別的 App Service 應用程式。</span><span class="sxs-lookup"><span data-stu-id="81a45-126">If your solution has both a web front-end and a web API, consider decomposing them into separate App Service apps.</span></span> <span data-ttu-id="81a45-127">此設計可讓您更輕鬆地依照工作負載來分解解決方案。</span><span class="sxs-lookup"><span data-stu-id="81a45-127">This design makes it easier to decompose the solution by workload.</span></span> <span data-ttu-id="81a45-128">您可以在個別的 App Service 方案中執行 Web 應用程式與 API，以便獨立調整其規模。</span><span class="sxs-lookup"><span data-stu-id="81a45-128">You can run the web app and the API in separate App Service plans, so they can be scaled independently.</span></span> <span data-ttu-id="81a45-129">如果您一開始不需要這種程度的延展性，可以將應用程式部署到相同的方案中，之後有需要時再將它們移到別的方案。</span><span class="sxs-lookup"><span data-stu-id="81a45-129">If you don't need that level of scalability at first, you can deploy the apps into the same plan, and move them into separate plans later, if needed.</span></span>

<span data-ttu-id="81a45-130">**避免使用 App Service 備份功能來備份 Azure SQL 資料庫。**</span><span class="sxs-lookup"><span data-stu-id="81a45-130">**Avoid using the App Service backup feature to back up Azure SQL databases.**</span></span> <span data-ttu-id="81a45-131">請改用 [SQL Database 自動化備份][sql-backup]。</span><span class="sxs-lookup"><span data-stu-id="81a45-131">Instead, use [SQL Database automated backups][sql-backup].</span></span> <span data-ttu-id="81a45-132">App Service 備份會將資料庫匯出至 SQL .bacpac 檔案，這會使用 DTU。</span><span class="sxs-lookup"><span data-stu-id="81a45-132">App Service backup exports the database to a SQL .bacpac file, which costs DTUs.</span></span>

<span data-ttu-id="81a45-133">**部署到預備位置。**</span><span class="sxs-lookup"><span data-stu-id="81a45-133">**Deploy to a staging slot.**</span></span> <span data-ttu-id="81a45-134">建立預備的部署位置。</span><span class="sxs-lookup"><span data-stu-id="81a45-134">Create a deployment slot for staging.</span></span> <span data-ttu-id="81a45-135">將應用程式更新部署到預備位置，並先確認部署，再將它交換至生產環境。</span><span class="sxs-lookup"><span data-stu-id="81a45-135">Deploy application updates to the staging slot, and verify the deployment before swapping it into production.</span></span> <span data-ttu-id="81a45-136">這可降低生產環境使用不正確更新的可能性。</span><span class="sxs-lookup"><span data-stu-id="81a45-136">This reduces the chance of a bad update in production.</span></span> <span data-ttu-id="81a45-137">也可確保所有執行個體在交換至生產環境之前就已準備就緒。</span><span class="sxs-lookup"><span data-stu-id="81a45-137">It also ensures that all instances are warmed up before being swapped into production.</span></span> <span data-ttu-id="81a45-138">許多應用程式都有重要的暖機和冷啟動時間。</span><span class="sxs-lookup"><span data-stu-id="81a45-138">Many applications have a significant warmup and cold-start time.</span></span> <span data-ttu-id="81a45-139">如需詳細資訊，請參閱[針對 Azure App Service 中的 Web 應用程式設定預備環境](/azure/app-service-web/web-sites-staged-publishing/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-139">For more information, see [Set up staging environments for web apps in Azure App Service](/azure/app-service-web/web-sites-staged-publishing/).</span></span>

<span data-ttu-id="81a45-140">**建立部署位置來保存上一個已知良好 (LKG) 的部署。**</span><span class="sxs-lookup"><span data-stu-id="81a45-140">**Create a deployment slot to hold the last-known-good (LKG) deployment.**</span></span> <span data-ttu-id="81a45-141">當您將更新部署到生產環境時，請將先前的生產部署移到 LKG 位置。</span><span class="sxs-lookup"><span data-stu-id="81a45-141">When you deploy an update to production, move the previous production deployment into the LKG slot.</span></span> <span data-ttu-id="81a45-142">這可讓您更輕鬆地復原錯誤的部署。</span><span class="sxs-lookup"><span data-stu-id="81a45-142">This makes it easier to roll back a bad deployment.</span></span> <span data-ttu-id="81a45-143">如果您之後發現問題，您可以快速地還原至 LKG 版本。</span><span class="sxs-lookup"><span data-stu-id="81a45-143">If you discover a problem later, you can quickly revert to the LKG version.</span></span> <span data-ttu-id="81a45-144">如需詳細資訊，請參閱[基本 Web 應用程式](../reference-architectures/app-service-web-app/basic-web-app.md)。</span><span class="sxs-lookup"><span data-stu-id="81a45-144">For more information, see [Basic web application](../reference-architectures/app-service-web-app/basic-web-app.md).</span></span>

<span data-ttu-id="81a45-145">**啟用診斷記錄**，包括應用程式記錄和 Web 伺服器記錄。</span><span class="sxs-lookup"><span data-stu-id="81a45-145">**Enable diagnostics logging**, including application logging and web server logging.</span></span> <span data-ttu-id="81a45-146">記錄作業對監視和診斷而言都很重要。</span><span class="sxs-lookup"><span data-stu-id="81a45-146">Logging is important for monitoring and diagnostics.</span></span> <span data-ttu-id="81a45-147">請參閱[在 Azure App Service 中針對 Web 應用程式啟用診斷記錄功能](/azure/app-service-web/web-sites-enable-diagnostic-log/)</span><span class="sxs-lookup"><span data-stu-id="81a45-147">See [Enable diagnostics logging for web apps in Azure App Service](/azure/app-service-web/web-sites-enable-diagnostic-log/)</span></span>

<span data-ttu-id="81a45-148">**記錄至 Blob 儲存體。**</span><span class="sxs-lookup"><span data-stu-id="81a45-148">**Log to blob storage.**</span></span> <span data-ttu-id="81a45-149">這可讓您更輕鬆地收集和分析資料。</span><span class="sxs-lookup"><span data-stu-id="81a45-149">This makes it easier to collect and analyze the data.</span></span>

<span data-ttu-id="81a45-150">**為記錄建立個別的儲存體帳戶。**</span><span class="sxs-lookup"><span data-stu-id="81a45-150">**Create a separate storage account for logs.**</span></span> <span data-ttu-id="81a45-151">記錄和應用程式資料不可使用相同儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="81a45-151">Don't use the same storage account for logs and application data.</span></span> <span data-ttu-id="81a45-152">這有助於防止記錄作業降低應用程式效能。</span><span class="sxs-lookup"><span data-stu-id="81a45-152">This helps to prevent logging from reducing application performance.</span></span>

<span data-ttu-id="81a45-153">**監視效能。**</span><span class="sxs-lookup"><span data-stu-id="81a45-153">**Monitor performance.**</span></span> <span data-ttu-id="81a45-154">使用 [New Relic](https://newrelic.com/) 或 [Application Insights](/azure/application-insights/app-insights-overview/) 等效能監視服務，來監視負載下的應用程式效能和行為。</span><span class="sxs-lookup"><span data-stu-id="81a45-154">Use a performance monitoring service such as [New Relic](https://newrelic.com/) or [Application Insights](/azure/application-insights/app-insights-overview/) to monitor application performance and behavior under load.</span></span>  <span data-ttu-id="81a45-155">效能監視可讓您即時深入解析應用程式。</span><span class="sxs-lookup"><span data-stu-id="81a45-155">Performance monitoring gives you real-time insight into the application.</span></span> <span data-ttu-id="81a45-156">它可讓您診斷問題並執行失敗的根本原因分析。</span><span class="sxs-lookup"><span data-stu-id="81a45-156">It enables you to diagnose issues and perform root-cause analysis of failures.</span></span>

## <a name="application-gateway"></a><span data-ttu-id="81a45-157">應用程式閘道</span><span class="sxs-lookup"><span data-stu-id="81a45-157">Application Gateway</span></span>

<span data-ttu-id="81a45-158">**佈建至少兩個執行個體。**</span><span class="sxs-lookup"><span data-stu-id="81a45-158">**Provision at least two instances.**</span></span> <span data-ttu-id="81a45-159">部署具有至少兩個執行個體的應用程式閘道。</span><span class="sxs-lookup"><span data-stu-id="81a45-159">Deploy Application Gateway with at least two instances.</span></span> <span data-ttu-id="81a45-160">單一執行個體為單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="81a45-160">A single instance is a single point of failure.</span></span> <span data-ttu-id="81a45-161">使用兩個或多個執行個體，可提供備援和延展性。</span><span class="sxs-lookup"><span data-stu-id="81a45-161">Use two or more instances for redundancy and scalability.</span></span> <span data-ttu-id="81a45-162">為了符合 [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway) 的資格，您必須佈建兩個或更多中型或大型執行個體。</span><span class="sxs-lookup"><span data-stu-id="81a45-162">In order to qualify for the [SLA](https://azure.microsoft.com/support/legal/sla/application-gateway), you must provision two or more medium or larger instances.</span></span>

## <a name="cosmos-db"></a><span data-ttu-id="81a45-163">Cosmos DB</span><span class="sxs-lookup"><span data-stu-id="81a45-163">Cosmos DB</span></span>

<span data-ttu-id="81a45-164">**跨區域複寫資料庫。**</span><span class="sxs-lookup"><span data-stu-id="81a45-164">**Replicate the database across regions.**</span></span> <span data-ttu-id="81a45-165">Cosmos DB 可讓您將任意數目的 Azure 區域與 Cosmos DB 資料庫帳戶產生關聯。</span><span class="sxs-lookup"><span data-stu-id="81a45-165">Cosmos DB allows you to associate any number of Azure regions with a Cosmos DB database account.</span></span> <span data-ttu-id="81a45-166">Cosmos DB 資料庫可以有一個寫入區域和多個唯讀區域。</span><span class="sxs-lookup"><span data-stu-id="81a45-166">A Cosmos DB database can have one write region and multiple read regions.</span></span> <span data-ttu-id="81a45-167">如果寫入區域發生失敗，您可以從另一個複本進行讀取。</span><span class="sxs-lookup"><span data-stu-id="81a45-167">If there is a failure in the write region, you can read from another replica.</span></span> <span data-ttu-id="81a45-168">用戶端 SDK 會自動處理此作業。</span><span class="sxs-lookup"><span data-stu-id="81a45-168">The Client SDK handles this automatically.</span></span> <span data-ttu-id="81a45-169">您也可以將寫入區域容錯移轉到另一個區域。</span><span class="sxs-lookup"><span data-stu-id="81a45-169">You can also fail over the write region to another region.</span></span> <span data-ttu-id="81a45-170">如需詳細資訊，請參閱[如何使用 Azure Cosmos DB 在全域散發資料](/azure/cosmos-db/distribute-data-globally)。</span><span class="sxs-lookup"><span data-stu-id="81a45-170">For more information, see [How to distribute data globally with Azure Cosmos DB](/azure/cosmos-db/distribute-data-globally).</span></span>

## <a name="event-hubs"></a><span data-ttu-id="81a45-171">事件中樞</span><span class="sxs-lookup"><span data-stu-id="81a45-171">Event Hubs</span></span>

<span data-ttu-id="81a45-172">**使用檢查點**。</span><span class="sxs-lookup"><span data-stu-id="81a45-172">**Use checkpoints**.</span></span>  <span data-ttu-id="81a45-173">事件取用者應以預先定義的間隔將其目前位置寫入永續性儲存體。</span><span class="sxs-lookup"><span data-stu-id="81a45-173">An event consumer should write its current position to persistent storage at some predefined interval.</span></span> <span data-ttu-id="81a45-174">這樣一來，如果取用者遇到錯誤 (例如，取用者毀損或主機失敗)，則新的執行個體可以從最後記錄的位置繼續讀取。</span><span class="sxs-lookup"><span data-stu-id="81a45-174">That way, if the consumer experiences a fault (for example, the consumer crashes, or the host fails), then a new instance can resume reading the stream from the last recorded position.</span></span> <span data-ttu-id="81a45-175">如需詳細資訊，請參閱[事件取用者](/azure/event-hubs/event-hubs-features#event-consumers)。</span><span class="sxs-lookup"><span data-stu-id="81a45-175">For more information, see [Event consumers](/azure/event-hubs/event-hubs-features#event-consumers).</span></span>

<span data-ttu-id="81a45-176">**處理重複的訊息。**</span><span class="sxs-lookup"><span data-stu-id="81a45-176">**Handle duplicate messages.**</span></span> <span data-ttu-id="81a45-177">如果事件取用者失敗，訊息處理會從最後一個記錄檢查點繼續。</span><span class="sxs-lookup"><span data-stu-id="81a45-177">If an event consumer fails, message processing is resumed from the last recorded checkpoint.</span></span> <span data-ttu-id="81a45-178">在最後一個檢查點之後處理的任何訊息會再次處理。</span><span class="sxs-lookup"><span data-stu-id="81a45-178">Any messages that were already processed after the last checkpoint will be processed again.</span></span> <span data-ttu-id="81a45-179">因此，您的訊息處理邏輯必須是等冪，或應用程式必須能夠刪除重複訊息。</span><span class="sxs-lookup"><span data-stu-id="81a45-179">Therefore, your message processing logic must be idempotent, or the application must be able to deduplicate messages.</span></span>

<span data-ttu-id="81a45-180">**處理例外狀況。**</span><span class="sxs-lookup"><span data-stu-id="81a45-180">**Handle exceptions.**.</span></span> <span data-ttu-id="81a45-181">事件取用者通常會處理迴圈中的一批訊息。</span><span class="sxs-lookup"><span data-stu-id="81a45-181">An event consumer typically processes a batch of messages in a loop.</span></span> <span data-ttu-id="81a45-182">您應該處理此處理迴圈中的例外狀況，以避免在單一訊息造成例外狀況時遺失整個批次的訊息。</span><span class="sxs-lookup"><span data-stu-id="81a45-182">You should handle exceptions within this processing loop to avoid losing an entire batch of messages if a single message causes an exception.</span></span>

<span data-ttu-id="81a45-183">**使用無效信件佇列。**</span><span class="sxs-lookup"><span data-stu-id="81a45-183">**Use a dead-letter queue.**</span></span> <span data-ttu-id="81a45-184">如果處理訊息導致非暫時性失敗，請將訊息放置到無效信件佇列，以便追蹤狀態。</span><span class="sxs-lookup"><span data-stu-id="81a45-184">If processing a message results in a non-transient failure, put the message onto a dead-letter queue, so that you can track the status.</span></span> <span data-ttu-id="81a45-185">根據這種案例，您可能會在稍後重試訊息、套用補償交易，或採取其他動作。</span><span class="sxs-lookup"><span data-stu-id="81a45-185">Depending on the scenario, you might retry the message later, apply a compensating transaction, or take some other action.</span></span> <span data-ttu-id="81a45-186">請注意，事件中樞沒有任何內建無效信件佇列功能。</span><span class="sxs-lookup"><span data-stu-id="81a45-186">Note that Event Hubs does not have any built-in dead-letter queue functionality.</span></span> <span data-ttu-id="81a45-187">您可以使用 Azure 佇列儲存體或服務匯流排來實作無效信件佇列，或使用 Azure Functions 或其他事件處理機制。</span><span class="sxs-lookup"><span data-stu-id="81a45-187">You can use Azure Queue Storage or Service Bus to implement a dead-letter queue, or use Azure Functions or some other eventing mechanism.</span></span>

<span data-ttu-id="81a45-188">**藉由容錯移轉至次要事件中樞命名空間來實作災害復原。**</span><span class="sxs-lookup"><span data-stu-id="81a45-188">**Implement disaster recovery by failing over to a secondary Event Hubs namespace.**</span></span> <span data-ttu-id="81a45-189">如需詳細資訊，請參閱 [Azure 事件中樞地理災害復原](/azure/event-hubs/event-hubs-geo-dr)。</span><span class="sxs-lookup"><span data-stu-id="81a45-189">For more information, see [Azure Event Hubs Geo-disaster recovery](/azure/event-hubs/event-hubs-geo-dr).</span></span>

## <a name="redis-cache"></a><span data-ttu-id="81a45-190">Redis 快取</span><span class="sxs-lookup"><span data-stu-id="81a45-190">Redis Cache</span></span>

<span data-ttu-id="81a45-191">**設定異地複寫**。</span><span class="sxs-lookup"><span data-stu-id="81a45-191">**Configure Geo-replication**.</span></span> <span data-ttu-id="81a45-192">異地複寫提供一個機制，可供連結兩個高階層 Azure Redis 快取執行個體。</span><span class="sxs-lookup"><span data-stu-id="81a45-192">Geo-replication provides a mechanism for linking two Premium tier Azure Redis Cache instances.</span></span> <span data-ttu-id="81a45-193">寫入主要快取中的資料會複寫至次要唯讀快取。</span><span class="sxs-lookup"><span data-stu-id="81a45-193">Data written to the primary cache is replicated to a secondary read-only cache.</span></span> <span data-ttu-id="81a45-194">如需詳細資訊，請參閱[如何設定 Azure Redis 快取的異地複寫](/azure/redis-cache/cache-how-to-geo-replication)</span><span class="sxs-lookup"><span data-stu-id="81a45-194">For more information, see [How to configure Geo-replication for Azure Redis Cache](/azure/redis-cache/cache-how-to-geo-replication)</span></span>

<span data-ttu-id="81a45-195">**設定資料永續性。**</span><span class="sxs-lookup"><span data-stu-id="81a45-195">**Configure data persistence.**</span></span> <span data-ttu-id="81a45-196">Redis 永續性可讓您保存儲存在 Redis 中的資料。</span><span class="sxs-lookup"><span data-stu-id="81a45-196">Redis persistence allows you to persist data stored in Redis.</span></span> <span data-ttu-id="81a45-197">您也可以擷取快照和備份資料，以在硬體失敗時載入。</span><span class="sxs-lookup"><span data-stu-id="81a45-197">You can also take snapshots and back up the data, which you can load in case of a hardware failure.</span></span> <span data-ttu-id="81a45-198">如需詳細資訊，請參閱 [如何設定進階 Azure Redis 快取的資料永續性](/azure/redis-cache/cache-how-to-premium-persistence)</span><span class="sxs-lookup"><span data-stu-id="81a45-198">For more information, see [How to configure data persistence for a Premium Azure Redis Cache](/azure/redis-cache/cache-how-to-premium-persistence)</span></span>

<span data-ttu-id="81a45-199">若您將 Redis 快取當作暫存資料快取而非持續性存放區，這些建議可能不適用。</span><span class="sxs-lookup"><span data-stu-id="81a45-199">If you are using Redis Cache as a temporary data cache and not as a persistent store, these recommendations may not apply.</span></span>

## <a name="search"></a><span data-ttu-id="81a45-200">Search</span><span class="sxs-lookup"><span data-stu-id="81a45-200">Search</span></span>

<span data-ttu-id="81a45-201">**佈建一個以上的複本。**</span><span class="sxs-lookup"><span data-stu-id="81a45-201">**Provision more than one replica.**</span></span> <span data-ttu-id="81a45-202">使用至少兩個複本可提供讀取高可用性，或者使用三個複本可提供讀寫高可用性。</span><span class="sxs-lookup"><span data-stu-id="81a45-202">Use at least two replicas for read high-availability, or three for read-write high-availability.</span></span>

<span data-ttu-id="81a45-203">**設定多區域部署的索引子。**</span><span class="sxs-lookup"><span data-stu-id="81a45-203">**Configure indexers for multi-region deployments.**</span></span> <span data-ttu-id="81a45-204">如果您有多區域部署，請考慮索引連續性的選項。</span><span class="sxs-lookup"><span data-stu-id="81a45-204">If you have a multi-region deployment, consider your options for continuity in indexing.</span></span>

- <span data-ttu-id="81a45-205">如果資料來源已在異地複寫，您通常應將每個區域性 Azure 搜尋服務的每個索引子指向其本機資料來源複本。</span><span class="sxs-lookup"><span data-stu-id="81a45-205">If the data source is geo-replicated, you should generally point each indexer of each regional Azure Search service to its local data source replica.</span></span> <span data-ttu-id="81a45-206">不過，該方法不建議用於儲存在 Azure SQL Database 中的大型資料集。</span><span class="sxs-lookup"><span data-stu-id="81a45-206">However, that approach is not recommended for large datasets stored in Azure SQL Database.</span></span> <span data-ttu-id="81a45-207">原因是 Azure 搜尋服務無法從次要 SQL Database 複本 (只能從主要複本) 執行增量編製索引。</span><span class="sxs-lookup"><span data-stu-id="81a45-207">The reason is that Azure Search cannot perform incremental indexing from secondary SQL Database replicas, only from primary replicas.</span></span> <span data-ttu-id="81a45-208">請改為將所有索引子指向主要複本。</span><span class="sxs-lookup"><span data-stu-id="81a45-208">Instead, point all indexers to the primary replica.</span></span> <span data-ttu-id="81a45-209">在容錯移轉之後，指著位於新主要複本的 Azure 搜尋服務索引子。</span><span class="sxs-lookup"><span data-stu-id="81a45-209">After a failover, point the Azure Search indexers at the new primary replica.</span></span>

- <span data-ttu-id="81a45-210">如果資料來源並未異地複寫，請指著位於相同資料來源的多個索引子，如此一來，多個區域中的 Azure 搜尋服務就能持續且獨立地從資料來源編製索引。</span><span class="sxs-lookup"><span data-stu-id="81a45-210">If the data source is not geo-replicated, point multiple indexers at the same data source, so that Azure Search services in multiple regions continuously and independently index from the data source.</span></span> <span data-ttu-id="81a45-211">如需詳細資訊，請參閱 [Azure 搜尋服務效能和最佳化考量][search-optimization]。</span><span class="sxs-lookup"><span data-stu-id="81a45-211">For more information, see [Azure Search performance and optimization considerations][search-optimization].</span></span>

## <a name="service-bus"></a><span data-ttu-id="81a45-212">服務匯流排</span><span class="sxs-lookup"><span data-stu-id="81a45-212">Service Bus</span></span>

<span data-ttu-id="81a45-213">**將進階層使用於生產工作負載**。</span><span class="sxs-lookup"><span data-stu-id="81a45-213">**Use Premium tier for production workloads**.</span></span> <span data-ttu-id="81a45-214">[服務匯流排進階傳訊](/azure/service-bus-messaging/service-bus-premium-messaging)提供專用和保留的處理資源和記憶體容量，以支援可預測的效能和輸送量。</span><span class="sxs-lookup"><span data-stu-id="81a45-214">[Service Bus Premium Messaging](/azure/service-bus-messaging/service-bus-premium-messaging) provides dedicated and reserved processing resources, and memory capacity to support predictable performance and throughput.</span></span> <span data-ttu-id="81a45-215">進階傳訊層也可讓您存取僅一開始適用於進階客戶的新功能。</span><span class="sxs-lookup"><span data-stu-id="81a45-215">Premium Messaging tier also gives you access to new features that are available only to premium customers at first.</span></span> <span data-ttu-id="81a45-216">您可以根據預期的工作負載決定傳訊單位數目。</span><span class="sxs-lookup"><span data-stu-id="81a45-216">You can decide the number of messaging units based on expected workloads.</span></span>

<span data-ttu-id="81a45-217">**處理重複的訊息**。</span><span class="sxs-lookup"><span data-stu-id="81a45-217">**Handle duplicate messages**.</span></span> <span data-ttu-id="81a45-218">如果發行者在傳送訊息後立即失敗，或遭遇網路或系統問題，則可能因錯誤而無法記錄訊息已傳遞，並可能將相同的訊息傳送到系統兩次。</span><span class="sxs-lookup"><span data-stu-id="81a45-218">If a publisher fails immediately after sending a message, or experiences network or system issues, it may erroneously fail to record that the message was delivered, and may send the same message to the system twice.</span></span> <span data-ttu-id="81a45-219">服務匯流排可藉由啟用重複偵測來處理此問題。</span><span class="sxs-lookup"><span data-stu-id="81a45-219">Service Bus can handle this issue by enabling duplicate detection.</span></span> <span data-ttu-id="81a45-220">如需詳細資訊，請參閱[重複偵測](/azure/service-bus-messaging/duplicate-detection)。</span><span class="sxs-lookup"><span data-stu-id="81a45-220">For more information, see [Duplicate detection](/azure/service-bus-messaging/duplicate-detection).</span></span>

<span data-ttu-id="81a45-221">**處理例外狀況**。</span><span class="sxs-lookup"><span data-stu-id="81a45-221">**Handle exceptions**.</span></span> <span data-ttu-id="81a45-222">發生使用者錯誤、設定錯誤或其他錯誤時，傳訊 API 會產生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="81a45-222">Messaging APIs generate exceptions when a user error, configuration error, or other error occurs.</span></span> <span data-ttu-id="81a45-223">用戶端程式碼 (傳送者和接收者) 應在其程式碼中處理這些例外狀況。</span><span class="sxs-lookup"><span data-stu-id="81a45-223">The client code (senders and receivers) should handle these exceptions in their code.</span></span> <span data-ttu-id="81a45-224">這在批次處理時尤其重要，因為例外狀況處理可用來避免遺失整個批次的訊息。</span><span class="sxs-lookup"><span data-stu-id="81a45-224">This is especially important in batch processing, where exception handling can be used to avoid losing an entire batch of messages.</span></span> <span data-ttu-id="81a45-225">如需詳細資訊，請參閱[服務匯流排傳訊例外狀況](/azure/service-bus-messaging/service-bus-messaging-exceptions)。</span><span class="sxs-lookup"><span data-stu-id="81a45-225">For more information, see [Service Bus messaging exceptions](/azure/service-bus-messaging/service-bus-messaging-exceptions).</span></span>

<span data-ttu-id="81a45-226">**重試原則**。</span><span class="sxs-lookup"><span data-stu-id="81a45-226">**Retry policy**.</span></span> <span data-ttu-id="81a45-227">服務匯流排可讓您挑選最適合您應用程式的重試原則。</span><span class="sxs-lookup"><span data-stu-id="81a45-227">Service Bus allows you to pick the best retry policy for your applications.</span></span> <span data-ttu-id="81a45-228">預設原則是最多允許重試 9 次，並等候 30 秒，但可進一步調整。</span><span class="sxs-lookup"><span data-stu-id="81a45-228">The default policy is to allow 9 maximum retry attempts, and wait for 30 seconds but this can be further adjusted.</span></span> <span data-ttu-id="81a45-229">如需詳細資訊，請參閱[重試原則 – 服務匯流排](/azure/architecture/best-practices/retry-service-specific#service-bus)。</span><span class="sxs-lookup"><span data-stu-id="81a45-229">For more information, see [Retry policy – Service Bus](/azure/architecture/best-practices/retry-service-specific#service-bus).</span></span>

<span data-ttu-id="81a45-230">**使用無效信件佇列**。</span><span class="sxs-lookup"><span data-stu-id="81a45-230">**Use a dead-letter queue**.</span></span> <span data-ttu-id="81a45-231">在多次重試之後，如果無法處理訊息或傳遞給任何接收者，該訊息就會移至無效信件佇列。</span><span class="sxs-lookup"><span data-stu-id="81a45-231">If a message cannot be processed or delivered to any receiver after multiple retries, it is moved to a dead letter queue.</span></span> <span data-ttu-id="81a45-232">實作從無效信件佇列讀取訊息、加以檢查，然後補救問題的程序。</span><span class="sxs-lookup"><span data-stu-id="81a45-232">Implement a process to read messages from the dead letter queue, inspect them, and remediate the problem.</span></span> <span data-ttu-id="81a45-233">視案例而定，您可能會按現況重試訊息、進行變更並重試，或捨棄該訊息。</span><span class="sxs-lookup"><span data-stu-id="81a45-233">Depending on the scenario, you might retry the message as-is, make changes and retry, or discard the message.</span></span> <span data-ttu-id="81a45-234">如需詳細資訊，請參閱[服務匯流排寄不出的信件佇列的概觀](/azure/service-bus-messaging/service-bus-dead-letter-queues)。</span><span class="sxs-lookup"><span data-stu-id="81a45-234">For more information, see [Overview of Service Bus dead-letter queues](/azure/service-bus-messaging/service-bus-dead-letter-queues).</span></span>

<span data-ttu-id="81a45-235">**使用異地災害復原**。</span><span class="sxs-lookup"><span data-stu-id="81a45-235">**Use Geo-Disaster Recovery**.</span></span> <span data-ttu-id="81a45-236">如果整個 Azure 區域或資料中心因為災害而無法使用，地理災害復原可確保資料處理會繼續在不同的區域或資料中心運作。</span><span class="sxs-lookup"><span data-stu-id="81a45-236">Geo-disaster recovery ensures that data processing continues to operate in a different region or datacenter if an entire Azure region or datacenter becomes unavailable due to a disaster.</span></span> <span data-ttu-id="81a45-237">如需詳細資訊，請參閱 [Azure 服務匯流排地理災害復原](/azure/service-bus-messaging/service-bus-geo-dr)。</span><span class="sxs-lookup"><span data-stu-id="81a45-237">For more information, see [Azure Service Bus Geo-disaster recovery](/azure/service-bus-messaging/service-bus-geo-dr).</span></span>

## <a name="storage"></a><span data-ttu-id="81a45-238">儲存體</span><span class="sxs-lookup"><span data-stu-id="81a45-238">Storage</span></span>

<span data-ttu-id="81a45-239">**對於應用程式資料，請使用讀取權限異地備援儲存體 (RA-GRS)。**</span><span class="sxs-lookup"><span data-stu-id="81a45-239">**For application data, use read-access geo-redundant storage (RA-GRS).**</span></span> <span data-ttu-id="81a45-240">RA-GRS 儲存體會將資料複寫到次要區域，並提供從次要區域的唯讀存取權。</span><span class="sxs-lookup"><span data-stu-id="81a45-240">RA-GRS storage replicates the data to a secondary region, and provides read-only access from the secondary region.</span></span> <span data-ttu-id="81a45-241">如果主要區域發生儲存體中斷，應用程式可以從次要區域讀取資料。</span><span class="sxs-lookup"><span data-stu-id="81a45-241">If there is a storage outage in the primary region, the application can read the data from the secondary region.</span></span> <span data-ttu-id="81a45-242">如需詳細資訊，請參閱 [Azure 儲存體複寫](/azure/storage/storage-redundancy/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-242">For more information, see [Azure Storage replication](/azure/storage/storage-redundancy/).</span></span>

<span data-ttu-id="81a45-243">**若為 VM 磁碟，請使用受控磁碟。**</span><span class="sxs-lookup"><span data-stu-id="81a45-243">**For VM disks, use Managed Disks.**</span></span> <span data-ttu-id="81a45-244">[受控磁碟][managed-disks]可為可用性設定組中的 VM 提供更高的可靠性，因為磁碟彼此充分隔離，以避免單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="81a45-244">[Managed Disks][managed-disks] provide better reliability for VMs in an availability set, because the disks are sufficiently isolated from each other to avoid single points of failure.</span></span> <span data-ttu-id="81a45-245">此外，受控磁碟不受儲存體帳戶中建立之 VHD 的 IOPS 限制所約束。</span><span class="sxs-lookup"><span data-stu-id="81a45-245">Also, Managed Disks aren't subject to the IOPS limits of VHDs created in a storage account.</span></span> <span data-ttu-id="81a45-246">如需詳細資訊，請參閱[管理 Azure 中 Windows 虛擬機器的可用性][vm-manage-availability]。</span><span class="sxs-lookup"><span data-stu-id="81a45-246">For more information, see [Manage the availability of Windows virtual machines in Azure][vm-manage-availability].</span></span>

<span data-ttu-id="81a45-247">**若為佇列儲存體，請在另一個區域中建立備份佇列。**</span><span class="sxs-lookup"><span data-stu-id="81a45-247">**For Queue storage, create a backup queue in another region.**</span></span> <span data-ttu-id="81a45-248">對於佇列儲存體，唯讀複本的用途有限，因為您無法將項目排入佇列或從佇列中清除。</span><span class="sxs-lookup"><span data-stu-id="81a45-248">For Queue storage, a read-only replica has limited use, because you can't queue or dequeue items.</span></span> <span data-ttu-id="81a45-249">請改為在其他區域的儲存體帳戶中建立備份佇列。</span><span class="sxs-lookup"><span data-stu-id="81a45-249">Instead, create a backup queue in a storage account in another region.</span></span> <span data-ttu-id="81a45-250">如果發生儲存體中斷，應用程式可以使用備份佇列，直到主要區域再次變為可使用為止。</span><span class="sxs-lookup"><span data-stu-id="81a45-250">If there is a storage outage, the application can use the backup queue, until the primary region becomes available again.</span></span> <span data-ttu-id="81a45-251">這樣一來，應用程式仍然可以處理新的要求。</span><span class="sxs-lookup"><span data-stu-id="81a45-251">That way, the application can still process new requests.</span></span>

## <a name="sql-database"></a><span data-ttu-id="81a45-252">SQL Database</span><span class="sxs-lookup"><span data-stu-id="81a45-252">SQL Database</span></span>

<span data-ttu-id="81a45-253">**使用標準或進階層。**</span><span class="sxs-lookup"><span data-stu-id="81a45-253">**Use Standard or Premium tier.**</span></span> <span data-ttu-id="81a45-254">這些服務層提供較長的時間點還原週期 (35 天)。</span><span class="sxs-lookup"><span data-stu-id="81a45-254">These tiers provide a longer point-in-time restore period (35 days).</span></span> <span data-ttu-id="81a45-255">如需詳細資訊，請參閱 [SQL Database 選項和效能](/azure/sql-database/sql-database-service-tiers/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-255">For more information, see [SQL Database options and performance](/azure/sql-database/sql-database-service-tiers/).</span></span>

<span data-ttu-id="81a45-256">**啟用 SQL Database 稽核。**</span><span class="sxs-lookup"><span data-stu-id="81a45-256">**Enable SQL Database auditing.**</span></span> <span data-ttu-id="81a45-257">稽核可以用來診斷惡意攻擊或人為錯誤。</span><span class="sxs-lookup"><span data-stu-id="81a45-257">Auditing can be used to diagnose malicious attacks or human error.</span></span> <span data-ttu-id="81a45-258">如需詳細資訊，請參閱 [開始使用 SQL 資料庫稽核](/azure/sql-database/sql-database-auditing-get-started/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-258">For more information, see [Get started with SQL database auditing](/azure/sql-database/sql-database-auditing-get-started/).</span></span>

<span data-ttu-id="81a45-259">**使用作用中異地複寫** 使用作用中異地複寫在不同區域中建立可讀取的次要複本。</span><span class="sxs-lookup"><span data-stu-id="81a45-259">**Use Active Geo-Replication** Use Active Geo-Replication to create a readable secondary in a different region.</span></span>  <span data-ttu-id="81a45-260">如果您的主要資料庫失敗，或只需要離線，請執行手動容錯移轉至次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="81a45-260">If your primary database fails, or simply needs to be taken offline, perform a manual failover to the secondary database.</span></span>  <span data-ttu-id="81a45-261">在您容錯移轉前，次要資料庫會維持唯讀狀態。</span><span class="sxs-lookup"><span data-stu-id="81a45-261">Until you fail over, the secondary database remains read-only.</span></span>  <span data-ttu-id="81a45-262">如需詳細資訊，請參閱 [SQL Database 作用中異地複寫](/azure/sql-database/sql-database-geo-replication-overview/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-262">For more information, see [SQL Database Active Geo-Replication](/azure/sql-database/sql-database-geo-replication-overview/).</span></span>

<span data-ttu-id="81a45-263">**使用分區化。**</span><span class="sxs-lookup"><span data-stu-id="81a45-263">**Use sharding.**</span></span> <span data-ttu-id="81a45-264">請考慮使用分區化來水平分割資料庫。</span><span class="sxs-lookup"><span data-stu-id="81a45-264">Consider using sharding to partition the database horizontally.</span></span> <span data-ttu-id="81a45-265">分區化可提供容錯隔離。</span><span class="sxs-lookup"><span data-stu-id="81a45-265">Sharding can provide fault isolation.</span></span> <span data-ttu-id="81a45-266">如需詳細資訊，請參閱[使用 Azure SQL Database 相應放大](/azure/sql-database/sql-database-elastic-scale-introduction/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-266">For more information, see [Scaling out with Azure SQL Database](/azure/sql-database/sql-database-elastic-scale-introduction/).</span></span>

<span data-ttu-id="81a45-267">**使用時間點還原從人為錯誤中復原。**</span><span class="sxs-lookup"><span data-stu-id="81a45-267">**Use point-in-time restore to recover from human error.**</span></span>  <span data-ttu-id="81a45-268">時間點還原會使您的資料庫回到較早的時間點。</span><span class="sxs-lookup"><span data-stu-id="81a45-268">Point-in-time restore returns your database to an earlier point in time.</span></span> <span data-ttu-id="81a45-269">如需詳細資訊，請參閱[使用自動化資料庫備份來復原 Azure SQL Database][sql-restore]。</span><span class="sxs-lookup"><span data-stu-id="81a45-269">For more information, see [Recover an Azure SQL database using automated database backups][sql-restore].</span></span>

<span data-ttu-id="81a45-270">**使用異地還原從服務中斷中復原。**</span><span class="sxs-lookup"><span data-stu-id="81a45-270">**Use geo-restore to recover from a service outage.**</span></span> <span data-ttu-id="81a45-271">異地還原可從異地備援備份還原資料庫。</span><span class="sxs-lookup"><span data-stu-id="81a45-271">Geo-restore restores a database from a geo-redundant backup.</span></span>  <span data-ttu-id="81a45-272">如需詳細資訊，請參閱[使用自動化資料庫備份來復原 Azure SQL Database][sql-restore]。</span><span class="sxs-lookup"><span data-stu-id="81a45-272">For more information, see [Recover an Azure SQL database using automated database backups][sql-restore].</span></span>

## <a name="sql-data-warehouse"></a><span data-ttu-id="81a45-273">SQL 資料倉儲</span><span class="sxs-lookup"><span data-stu-id="81a45-273">SQL Data Warehouse</span></span>

<span data-ttu-id="81a45-274">**請勿停用異地備份。**</span><span class="sxs-lookup"><span data-stu-id="81a45-274">**Do not disable geo-backup.**</span></span> <span data-ttu-id="81a45-275">根據預設，Microsoft Azure SQL 資料倉儲每 24 小時會完整備份您的資料以進行災害復原。</span><span class="sxs-lookup"><span data-stu-id="81a45-275">By default, SQL Data Warehouse takes a full backup of your data every 24 hours for disaster recovery.</span></span> <span data-ttu-id="81a45-276">建議您不要關閉這項功能。</span><span class="sxs-lookup"><span data-stu-id="81a45-276">It is not recommended to turn this feature off.</span></span> <span data-ttu-id="81a45-277">如需詳細資訊，請參閱[異地備份](/azure/sql-data-warehouse/backup-and-restore#geo-backups)。</span><span class="sxs-lookup"><span data-stu-id="81a45-277">For more information, see [Geo-backups](/azure/sql-data-warehouse/backup-and-restore#geo-backups).</span></span>

## <a name="sql-server-running-in-a-vm"></a><span data-ttu-id="81a45-278">在虛擬機器中執行的 SQL Server</span><span class="sxs-lookup"><span data-stu-id="81a45-278">SQL Server running in a VM</span></span>

<span data-ttu-id="81a45-279">**複寫資料庫。**</span><span class="sxs-lookup"><span data-stu-id="81a45-279">**Replicate the database.**</span></span> <span data-ttu-id="81a45-280">使用 SQL Server Always On 可用性群組來複寫資料庫。</span><span class="sxs-lookup"><span data-stu-id="81a45-280">Use SQL Server Always On Availability Groups to replicate the database.</span></span> <span data-ttu-id="81a45-281">如果有一個 SQL Server 執行個體失敗，可提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="81a45-281">Provides high availability if one SQL Server instance fails.</span></span> <span data-ttu-id="81a45-282">如需詳細資訊，請參閱[執行適用於多層式架構的 Windows VM](../reference-architectures/virtual-machines-windows/n-tier.md)</span><span class="sxs-lookup"><span data-stu-id="81a45-282">For more information, see [Run Windows VMs for an N-tier application](../reference-architectures/virtual-machines-windows/n-tier.md)</span></span>

<span data-ttu-id="81a45-283">**備份資料庫**。</span><span class="sxs-lookup"><span data-stu-id="81a45-283">**Back up the database**.</span></span> <span data-ttu-id="81a45-284">如果您已經使用 [Azure 備份](/azure/backup/)來備份您的 VM，請考慮使用 [Azure 備份來備份採用 DPM 的 SQL Server 工作負載](/azure/backup/backup-azure-backup-sql/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-284">If you are already using [Azure Backup](/azure/backup/) to back up your VMs, consider using [Azure Backup for SQL Server workloads using DPM](/azure/backup/backup-azure-backup-sql/).</span></span> <span data-ttu-id="81a45-285">使用此方法，組織有一個備份管理員角色以及 VM 和 SQL Server 的整合復原程序。</span><span class="sxs-lookup"><span data-stu-id="81a45-285">With this approach, there is one backup administrator role for the organization and a unified recovery procedure for VMs and SQL Server.</span></span> <span data-ttu-id="81a45-286">否則，使用 [SQL Server 受控備份至 Microsoft Azure](https://msdn.microsoft.com/library/dn449496.aspx)。</span><span class="sxs-lookup"><span data-stu-id="81a45-286">Otherwise, use [SQL Server Managed Backup to Microsoft Azure](https://msdn.microsoft.com/library/dn449496.aspx).</span></span>

## <a name="traffic-manager"></a><span data-ttu-id="81a45-287">流量管理員</span><span class="sxs-lookup"><span data-stu-id="81a45-287">Traffic Manager</span></span>

<span data-ttu-id="81a45-288">**執行手動容錯回復。**</span><span class="sxs-lookup"><span data-stu-id="81a45-288">**Perform manual failback.**</span></span> <span data-ttu-id="81a45-289">在流量管理員容錯移轉之後，執行手動容錯回復，而非自動容錯回復。</span><span class="sxs-lookup"><span data-stu-id="81a45-289">After a Traffic Manager failover, perform manual failback, rather than automatically failing back.</span></span> <span data-ttu-id="81a45-290">在容錯回復之前，確認所有應用程式子系統的狀況良好。</span><span class="sxs-lookup"><span data-stu-id="81a45-290">Before failing back, verify that all application subsystems are healthy.</span></span>  <span data-ttu-id="81a45-291">或者，您可以建立應用程式會在資料中心之間來回翻轉的情況。</span><span class="sxs-lookup"><span data-stu-id="81a45-291">Otherwise, you can create a situation where the application flips back and forth between data centers.</span></span> <span data-ttu-id="81a45-292">如需詳細資訊，請參閱[在多個區域中執行 VM 以獲得高可用性](../reference-architectures/virtual-machines-windows/multi-region-application.md)。</span><span class="sxs-lookup"><span data-stu-id="81a45-292">For more information, see [Run VMs in multiple regions for high availability](../reference-architectures/virtual-machines-windows/multi-region-application.md).</span></span>

<span data-ttu-id="81a45-293">**建立健康情況探查端點。**</span><span class="sxs-lookup"><span data-stu-id="81a45-293">**Create a health probe endpoint.**</span></span> <span data-ttu-id="81a45-294">建立可報告應用程式整體健康情況的自訂端點。</span><span class="sxs-lookup"><span data-stu-id="81a45-294">Create a custom endpoint that reports on the overall health of the application.</span></span> <span data-ttu-id="81a45-295">如有任何重要的路徑失敗 (不只是前端)，這可讓流量管理員進行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="81a45-295">This enables Traffic Manager to fail over if any critical path fails, not just the front end.</span></span> <span data-ttu-id="81a45-296">如有任何重要的相依性處於狀況不良或無法連線，則端點應傳回 HTTP 錯誤碼。</span><span class="sxs-lookup"><span data-stu-id="81a45-296">The endpoint should return an HTTP error code if any critical dependency is unhealthy or unreachable.</span></span> <span data-ttu-id="81a45-297">然而，不會回報不重要服務的錯誤。</span><span class="sxs-lookup"><span data-stu-id="81a45-297">Don't report errors for non-critical services, however.</span></span> <span data-ttu-id="81a45-298">否則，健康情況探查可能觸發容錯移轉，若不需要，則會建立誤判。</span><span class="sxs-lookup"><span data-stu-id="81a45-298">Otherwise, the health probe might trigger failover when it's not needed, creating false positives.</span></span> <span data-ttu-id="81a45-299">如需詳細資訊，請參閱[流量管理員端點監視和容錯移轉](/azure/traffic-manager/traffic-manager-monitoring/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-299">For more information, see [Traffic Manager endpoint monitoring and failover](/azure/traffic-manager/traffic-manager-monitoring/).</span></span>

## <a name="virtual-machines"></a><span data-ttu-id="81a45-300">虛擬機器</span><span class="sxs-lookup"><span data-stu-id="81a45-300">Virtual Machines</span></span>

<span data-ttu-id="81a45-301">**避免在單一 VM 上執行生產工作負載。**</span><span class="sxs-lookup"><span data-stu-id="81a45-301">**Avoid running a production workload on a single VM.**</span></span> <span data-ttu-id="81a45-302">單一 VM 部署不適合進行計劃性或非計劃性維護。</span><span class="sxs-lookup"><span data-stu-id="81a45-302">A single VM deployment is not resilient to planned or unplanned maintenance.</span></span> <span data-ttu-id="81a45-303">請改為將多個 VM 放入一個可用性集合或 [VM 擴展集](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/)中 (前面是負載平衡器)。</span><span class="sxs-lookup"><span data-stu-id="81a45-303">Instead, put multiple VMs in an availability set or [VM scale set](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview/), with a load balancer in front.</span></span>

<span data-ttu-id="81a45-304">**在佈建 VM 時指定可用性設定組。**</span><span class="sxs-lookup"><span data-stu-id="81a45-304">**Specify an availability set when you provision the VM.**</span></span> <span data-ttu-id="81a45-305">目前沒有任何方法可在佈建 VM 之後，將 VM 新增至可用性設定組。</span><span class="sxs-lookup"><span data-stu-id="81a45-305">Currently, there is no way to add a VM to an availability set after the VM is provisioned.</span></span> <span data-ttu-id="81a45-306">當您將新的 VM 新增至現有的可用性設定時，務必為此 VM 建立 NIC，然後將此 NIC 新增至負載平衡器上的後端位址集區。</span><span class="sxs-lookup"><span data-stu-id="81a45-306">When you add a new VM to an existing availability set, make sure to create a NIC for the VM, and add the NIC to the back-end address pool on the load balancer.</span></span> <span data-ttu-id="81a45-307">否則，負載平衡器不會將網路流量傳送到該 VM。</span><span class="sxs-lookup"><span data-stu-id="81a45-307">Otherwise, the load balancer won't route network traffic to that VM.</span></span>

<span data-ttu-id="81a45-308">**將每個應用程式層放在不同的可用性設定組中。**</span><span class="sxs-lookup"><span data-stu-id="81a45-308">**Put each application tier into a separate Availability Set.**</span></span> <span data-ttu-id="81a45-309">在多層式架構應用程式中，請勿將不同層的 VM 放在相同的可用性設定組中。</span><span class="sxs-lookup"><span data-stu-id="81a45-309">In an N-tier application, don't put VMs from different tiers into the same availability set.</span></span> <span data-ttu-id="81a45-310">可用性設定組中的 VM 會置於各個容錯網域 (FD) 與更新網域 (UD) 中。</span><span class="sxs-lookup"><span data-stu-id="81a45-310">VMs in an availability set are placed across fault domains (FDs) and update domains (UD).</span></span> <span data-ttu-id="81a45-311">不過，若要取得 FD 和 UD 的備援優勢，可用性設定組中的每個 VM 必須能夠處理相同的用戶端要求。</span><span class="sxs-lookup"><span data-stu-id="81a45-311">However, to get the redundancy benefit of FDs and UDs, every VM in the availability set must be able to handle the same client requests.</span></span>

<span data-ttu-id="81a45-312">**使用 Azure Site Recovery 複寫 VM。**</span><span class="sxs-lookup"><span data-stu-id="81a45-312">**Replicate VMs using Azure Site Recovery.**</span></span> <span data-ttu-id="81a45-313">使用 [Site Recovery][site-recovery] 複寫 Azure VM 時，所有 VM 磁碟會持續以非同步方式複寫至目標區域。</span><span class="sxs-lookup"><span data-stu-id="81a45-313">When you replicate Azure VMs using [Site Recovery][site-recovery], all the VM disks are continuously replicated to the target region asynchronously.</span></span> <span data-ttu-id="81a45-314">每隔幾分鐘就會建立一次復原點。</span><span class="sxs-lookup"><span data-stu-id="81a45-314">The recovery points are created every few minutes.</span></span> <span data-ttu-id="81a45-315">據此，您將獲得以分鐘為單位的復原點目標 (RPO)。</span><span class="sxs-lookup"><span data-stu-id="81a45-315">This gives you a Recovery Point Objective (RPO) in the order of minutes.</span></span> <span data-ttu-id="81a45-316">您可以依需求執行不限次數的災害復原演練，而不會影響生產應用程式或進行中的複寫。</span><span class="sxs-lookup"><span data-stu-id="81a45-316">You can conduct disaster recovery drills as many times as you want, without impacting the production application or the ongoing replication.</span></span> <span data-ttu-id="81a45-317">如需詳細資訊，請參閱[執行 Azure 的災害復原演練][site-recovery-test]。</span><span class="sxs-lookup"><span data-stu-id="81a45-317">For more information, see [Run a disaster recovery drill to Azure][site-recovery-test].</span></span>

<span data-ttu-id="81a45-318">**根據效能需求選擇正確的 VM 大小。**</span><span class="sxs-lookup"><span data-stu-id="81a45-318">**Choose the right VM size based on performance requirements.**</span></span> <span data-ttu-id="81a45-319">將現有的工作負載移至 Azure 時，從最符合您內部部署伺服器的 VM 大小開始。</span><span class="sxs-lookup"><span data-stu-id="81a45-319">When moving an existing workload to Azure, start with the VM size that's the closest match to your on-premises servers.</span></span> <span data-ttu-id="81a45-320">然後根據 CPU、記憶體和 IOPS 測量您的實際工作負載效能，並視需要調整大小。</span><span class="sxs-lookup"><span data-stu-id="81a45-320">Then measure the performance of your actual workload with respect to CPU, memory, and disk IOPS, and adjust the size if needed.</span></span> <span data-ttu-id="81a45-321">這有助於確保應用程式如預期般在雲端環境中運作。</span><span class="sxs-lookup"><span data-stu-id="81a45-321">This helps to ensure the application behaves as expected in a cloud environment.</span></span> <span data-ttu-id="81a45-322">此外，如果您需要多個 NIC，請留意每個大小的 NIC 限制。</span><span class="sxs-lookup"><span data-stu-id="81a45-322">Also, if you need multiple NICs, be aware of the NIC limit for each size.</span></span>

<span data-ttu-id="81a45-323">**對 VHD 使用受控磁碟。**</span><span class="sxs-lookup"><span data-stu-id="81a45-323">**Use Managed Disks for VHDs.**</span></span> <span data-ttu-id="81a45-324">[受控磁碟][managed-disks]可為可用性設定組中的 VM 提供更高的可靠性，因為磁碟彼此充分隔離，以避免單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="81a45-324">[Managed Disks][managed-disks] provide better reliability for VMs in an availability set, because the disks are sufficiently isolated from each other to avoid single points of failure.</span></span> <span data-ttu-id="81a45-325">此外，受控磁碟不受儲存體帳戶中建立之 VHD 的 IOPS 限制所約束。</span><span class="sxs-lookup"><span data-stu-id="81a45-325">Also, Managed Disks aren't subject to the IOPS limits of VHDs created in a storage account.</span></span> <span data-ttu-id="81a45-326">如需詳細資訊，請參閱[管理 Azure 中 Windows 虛擬機器的可用性][vm-manage-availability]。</span><span class="sxs-lookup"><span data-stu-id="81a45-326">For more information, see [Manage the availability of Windows virtual machines in Azure][vm-manage-availability].</span></span>

<span data-ttu-id="81a45-327">**將應用程式安裝在資料磁碟上，而非作業系統磁碟上。**</span><span class="sxs-lookup"><span data-stu-id="81a45-327">**Install applications on a data disk, not the OS disk.**</span></span> <span data-ttu-id="81a45-328">否則，您可能會達到磁碟大小限制。</span><span class="sxs-lookup"><span data-stu-id="81a45-328">Otherwise, you may reach the disk size limit.</span></span>

<span data-ttu-id="81a45-329">**使用 Azure 備份來備份 VM。**</span><span class="sxs-lookup"><span data-stu-id="81a45-329">**Use Azure Backup to back up VMs.**</span></span> <span data-ttu-id="81a45-330">備份可防止資料意外遺失。</span><span class="sxs-lookup"><span data-stu-id="81a45-330">Backups protect against accidental data loss.</span></span> <span data-ttu-id="81a45-331">如需詳細資訊，請參閱[使用復原服務保存庫來保護 Azure VM](/azure/backup/backup-azure-vms-first-look-arm/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-331">For more information, see [Protect Azure VMs with a recovery services vault](/azure/backup/backup-azure-vms-first-look-arm/).</span></span>

<span data-ttu-id="81a45-332">**啟用診斷記錄**，包括基本健康情況計量、基礎結構記錄及[開機診斷][boot-diagnostics]。</span><span class="sxs-lookup"><span data-stu-id="81a45-332">**Enable diagnostic logs**, including basic health metrics, infrastructure logs, and [boot diagnostics][boot-diagnostics].</span></span> <span data-ttu-id="81a45-333">如果您的 VM 進入無法開機的狀態，開機診斷能協助您診斷開機失敗。</span><span class="sxs-lookup"><span data-stu-id="81a45-333">Boot diagnostics can help you diagnose a boot failure if your VM gets into a non-bootable state.</span></span> <span data-ttu-id="81a45-334">如需詳細資訊，請參閱 [Azure Diagnostic Logs 概觀][diagnostics-logs]。</span><span class="sxs-lookup"><span data-stu-id="81a45-334">For more information, see [Overview of Azure Diagnostic Logs][diagnostics-logs].</span></span>

<span data-ttu-id="81a45-335">**使用 AzureLogCollector 擴充功能。**</span><span class="sxs-lookup"><span data-stu-id="81a45-335">**Use the AzureLogCollector extension.**</span></span> <span data-ttu-id="81a45-336">(僅限 Windows VM。)這項擴充功能可彙總 Azure 平台記錄，並將其上傳至 Azure 儲存體，而不需操作人員從遠端登入 VM。</span><span class="sxs-lookup"><span data-stu-id="81a45-336">(Windows VMs only.) This extension aggregates Azure platform logs and uploads them to Azure storage, without the operator remotely logging into the VM.</span></span> <span data-ttu-id="81a45-337">如需詳細資訊，請參閱 [AzureLogCollector 擴充功能](/azure/virtual-machines/virtual-machines-windows-log-collector-extension/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)。</span><span class="sxs-lookup"><span data-stu-id="81a45-337">For more information, see [AzureLogCollector Extension](/azure/virtual-machines/virtual-machines-windows-log-collector-extension/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span>

## <a name="virtual-network"></a><span data-ttu-id="81a45-338">虛擬網路</span><span class="sxs-lookup"><span data-stu-id="81a45-338">Virtual Network</span></span>

<span data-ttu-id="81a45-339">**若要允許或封鎖公用 IP 位址，請將 NSG 新增至子網路。**</span><span class="sxs-lookup"><span data-stu-id="81a45-339">**To whitelist or block public IP addresses, add an NSG to the subnet.**</span></span> <span data-ttu-id="81a45-340">封鎖來自惡意使用者的存取，或只允許有權存取應用程式的使用者存取。</span><span class="sxs-lookup"><span data-stu-id="81a45-340">Block access from malicious users, or allow access only from users who have privilege to access the application.</span></span>

<span data-ttu-id="81a45-341">**建立自訂健康情況探查。**</span><span class="sxs-lookup"><span data-stu-id="81a45-341">**Create a custom health probe.**</span></span> <span data-ttu-id="81a45-342">Load Balancer 健康情況探查可以測試 HTTP 或 TCP。</span><span class="sxs-lookup"><span data-stu-id="81a45-342">Load Balancer Health Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="81a45-343">如果 VM 執行 HTTP 伺服器，則 HTTP 探查是比 TCP 探查更佳的健康狀態指標。</span><span class="sxs-lookup"><span data-stu-id="81a45-343">If a VM runs an HTTP server, the HTTP probe is a better indicator of health status than a TCP probe.</span></span> <span data-ttu-id="81a45-344">對於 HTTP 探查，使用可報告應用程式整體健康情況 (包括所有重要相依性) 的自訂端點。</span><span class="sxs-lookup"><span data-stu-id="81a45-344">For an HTTP probe, use a custom endpoint that reports the overall health of the application, including all critical dependencies.</span></span> <span data-ttu-id="81a45-345">如需詳細資訊，請參閱 [Azure Load Balancer 概觀](/azure/load-balancer/load-balancer-overview/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-345">For more information, see [Azure Load Balancer overview](/azure/load-balancer/load-balancer-overview/).</span></span>

<span data-ttu-id="81a45-346">**封鎖健康情況探查。**</span><span class="sxs-lookup"><span data-stu-id="81a45-346">**Don't block the health probe.**</span></span> <span data-ttu-id="81a45-347">Load Balancer 健康情況探查會從已知的 IP 位址 168.63.129.16 傳送。</span><span class="sxs-lookup"><span data-stu-id="81a45-347">The Load Balancer Health probe is sent from a known IP address, 168.63.129.16.</span></span> <span data-ttu-id="81a45-348">請勿在任何防火牆原則或網路安全性群組 (NSG) 規則中封鎖往返此 IP 的流量。</span><span class="sxs-lookup"><span data-stu-id="81a45-348">Don't block traffic to or from this IP in any firewall policies or network security group (NSG) rules.</span></span> <span data-ttu-id="81a45-349">封鎖健康情況探查，可能會導致負載平衡器從循環中移除 VM。</span><span class="sxs-lookup"><span data-stu-id="81a45-349">Blocking the health probe would cause the load balancer to remove the VM from rotation.</span></span>

<span data-ttu-id="81a45-350">**啟用 Azure Load Balancer 記錄功能。**</span><span class="sxs-lookup"><span data-stu-id="81a45-350">**Enable Load Balancer logging.**</span></span> <span data-ttu-id="81a45-351">記錄會顯示後端有多少個 VM 因為探查回應失敗而不接收網路流量。</span><span class="sxs-lookup"><span data-stu-id="81a45-351">The logs show how many VMs on the back-end are not receiving network traffic due to failed probe responses.</span></span> <span data-ttu-id="81a45-352">如需詳細資訊，請參閱 [Azure Load Balancer 的記錄分析](/azure/load-balancer/load-balancer-monitor-log/)。</span><span class="sxs-lookup"><span data-stu-id="81a45-352">For more information, see [Log analytics for Azure Load Balancer](/azure/load-balancer/load-balancer-monitor-log/).</span></span>

<!-- links -->
[boot-diagnostics]: https://azure.microsoft.com/blog/boot-diagnostics-for-virtual-machines-v2/
[diagnostics-logs]: /azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs/
[managed-disks]: /azure/storage/storage-managed-disks-overview
[search-optimization]: /azure/search/search-performance-optimization/
[site-recovery]: /azure/site-recovery/
[site-recovery-test]: /azure/site-recovery/site-recovery-test-failover-to-azure
[sql-backup]: /azure/sql-database/sql-database-automated-backups/
[sql-restore]: /azure/sql-database/sql-database-recovery-using-backups/
[vm-manage-availability]: /azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set
