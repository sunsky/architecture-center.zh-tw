---
title: 設計可靠的 Azure 應用程式
description: 使 Azure 應用程式可靠且高度可用的簡介
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.custom: ''
ms.openlocfilehash: 16c1daeed9b1d79f33051eb69571f1574bf9be4d
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59644003"
---
# <a name="designing-reliable-azure-applications"></a>設計可靠的 Azure 應用程式

在雲端中建置可靠的應用程式不同於傳統應用程式的開發。 儘管您在過去可能已購買更高階的硬體來相應增加，但在雲端環境中，您應進行相應放大而不是相應增加。 此目標不是試著完全避免失敗，而是將單一故障元件的影響降至最低。

可靠的應用程式應具備：

- 從失敗中順利**復原**的能力，而且在完整復原之前，這些應用程式能在停機時間最短和資料遺失最少的情況下繼續運作。
- **高可用性 (HA)**，可依據設計訴求在健全狀態下執行，並且沒有重大的停機時間。

了解這些項目如何一起運作及如何影響成本，都是建置可靠應用程式的要素。 這可協助您判斷可接受的停機時間是多久、您業務的潛在成本有多少，以及在復原期間有哪些功能是必要的。

本文會提供簡短概觀，講述如何將可靠性建置到 Azure 應用程式設計程序的每個步驟中。 每一節都包含深入文章的連結，說明如何將可靠性整合至程序中的特定步驟。 如果您想知道個別 Azure 服務的可靠性考量，請檢閱[特定 Azure 服務的復原檢查清單](../checklist/resiliency-per-service.md)。

## <a name="build-for-reliability"></a>針對可靠性進行建置

本節將描述建置可靠 Azure 應用程式的六個步驟。 每個步驟都會連結至進一步定義程序和詞彙的區段。

1. [**定義需求。**](#define-requirements) 根據細分的工作負載和業務需求，開發可用性和復原需求。
1. [**使用建構式最佳做法。**](#use-architectural-best-practices) 遵循經過證實的作法、識別架構中可能的失敗點，以及決定應用程式如何回應失敗。
1. [**透過模擬及強制容錯移轉進行測試。**](#test-with-simulations-and-forced-failovers) 模擬錯誤、觸發強制容錯移轉及測試偵測，並從這些失敗中復原。
1. [**持續部署應用程式。**](#deploy-the-application-consistently) 使用可靠且重複的程序發行至生產環境。
1. [**監視應用程式健康情況。**](#monitor-application-health) 偵測失敗、監視潛在問題的指標，以及評估應用程式的健康情況。
1. [**回應失敗和災害。**](#respond-to-failures-and-disasters) 識別發生失敗的時間，並依據已建立的策略來決定處理方式。

## <a name="define-requirements"></a>定義需求

識別您的業務需求，並建置可靠性計劃來因應這些需求。 請考慮下列：

- **識別工作負載和使用方式。** 「工作負載」是指不同的功能或工作，可根據商務邏輯和資料儲存體需求，以邏輯方式與其他工作區隔。 每個工作負載在可用性、延展性、資料一致性和災害復原方面，都有不同的需求。
- **使用模式的規劃。** 「使用模式」在需求中也扮演重要角色。 用來識別重要和非重要期間的需求差異。 例如，報稅應用程式不能在報稅期限的期間失敗。 若要確保執行時間不中斷，應在數個區域間規劃備援，以因應其中一個區域失敗的狀況。 相反地，若要在非重要期間降低成本，您可以在單一區域中執行應用程式。
- **建立可用性計量&mdash; 平均復原時間 (MTTR) 和平均失敗時間 (MTBF)。** MTTR 是失敗後還原元件所需的平均時間。 MTBF 現在是合理預期元件可在兩次中斷之間持續執行的時間。 您可以使用這些量值來決定要新增備援的區域，以及決定客戶的服務等級協定 (SLA)。  
- **建立復原計量&mdash; 復原時間目標和復原點目標 (RPO)。** RTO 是應用程式在事件發生之後可能無法使用的最大可接受時間。 RPO 是在災害期間可接受的最大資料遺失時間長度。 若要衍生這些值，請進行風險評估，並確定您了解組織發生停機或資料遺失時的風險與成本。
    > [!NOTE]
    > 針對「任何」具可用性設定的元件，如果其 MTTR 超過系統 RTO，則系統中的失敗可能會導致無法接受的業務中斷。 也就是，您無法在定義的 RTO 內還原系統。
- **決定工作負載的可用性目標。** 若要確保應用程式架構符合您的業務需求，請定義每個工作負載的目標 SLA。 除了應用程式相依性之外，還需包含符合可用性需求的成本與複雜度。
- **了解服務等級協定。** 在 Azure 中，SLA 會描述 Microsoft 對執行時間與連線能力的承諾。 如果特定服務的 SLA 是 99.95%，則您可以預期 99.95% 的時間皆可提供服務。  

    為您方案中的每個工作負載定義您自己的目標 SLA，即可判斷架構是否符合業務需求。 例如，如果工作負載需要 99.99% 的執行時間，但需依附 99.9 % SLA 的服務，則該服務就不能是系統中的單一失敗點。

若要深入了解如何開發可靠應用程式的需求，請參閱[開發可復原 Azure 應用程式的需求](./requirements.md)。

## <a name="use-architectural-best-practices"></a>使用建構式最佳做法

在建構階段上，專注於實作符合您業務需求的做法、識別失敗點，以及最小化失敗的範圍。

- **執行失敗模式分析 (FMA)。** FMA 會在設計階段早期將復原能力內建到應用程式。 這可協助您識別應用程式可能會遇到的失敗、每一個失敗的潛在影響，以及可能的復原策略。
- **建立備援計劃。** 每個工作負載所需的備援層級皆取決於您的業務需求，以及影響應用程式整體成本的因素。 
- **延展性設計。** 雲端應用程式必須能根據使用量變化進行調整。 一開始使用獨立的元件，並盡可能將應用程式設定為自動回應負載變更。 設計時應考慮到調整限制，以便未來可輕鬆地進行延展。
- **訂用帳戶和服務需求的規劃。** 您可能需要額外的訂用帳戶來佈建足以符合您業務需求的資源，像是用於儲存體、連線和輸送量等等的資源。 
- **使用負載平衡功能來分配要求。** 負載平衡功能可藉由從循環中移除狀況不良的執行個體，將應用程式的要求分配至狀況良好的服務執行個體。
- **實作復原策略。** *復原*是系統從失敗中復原並繼續運作的能力。 實作[復原設計模式](../patterns/category/resiliency.md)，例如在可能的情況下隔離重要資源、使用補償交易及執行非同步作業。
- **將可用性需求建置到設計中。** 「可用性」是系統正常運作並執行作業的時間比例。 採取步驟來確保應用程式可用性符合您的服務等級協定。 例如，避免單一失敗點、根據服務等級目標來細分工作負載，以及對大量使用者進行節流。
- **管理資料。** 如何儲存、備份和複寫資料相當重要。

  - **選擇您應用程式資料適用的複寫方法。** 應用程式資料會儲存在各種資料存放區，而且可能有不同的可用性需求。 評估每種資料存放區類型的複寫方法和位置，以確保其符合您的需求。
  - **記載和測試您的容錯移轉和容錯回復程序。** 清楚記載容錯移轉到新資料存放區的指示，並定期進行測試，以確定這些指示正確且易於遵循。
  - **保護您的資料。** 定期備份和驗證資料，並確定沒有單一使用者帳戶可存取生產和備份資料。
  - **資料復原的規劃。** 確定您為資料復原時間提供的備份和複寫策略符合服務層級需求。 需可處理您應用程式使用的所有資料類型，包括參考資料和資料庫。

如需如何建構可靠應用程式的詳細資訊，請參閱[建構 Azure 應用程式的復原能力和可用性](./architect.md)。

## <a name="test-with-simulations-and-forced-failovers"></a>透過模擬及強制容錯移轉進行測試

若要測試可靠性，必須評估端對端工作負載在失敗情況下的執行方式，而這只會間歇性發生。

- **藉由觸發或模擬實際失敗情形來測試常見的失敗案例。** 使用錯誤插入式測試來測試常見案例 (包括失敗的組合) 和復原時間。
- **識別只在負載下發生的失敗。** 使用生產資料或盡可能最接近生產資料的綜合資料，針對尖峰負載進行測試，以查看應用程式在實際狀況下的行為。
- **執行災害復原演練。** 制定災害復原計劃，並定期測試以確保其正常運作。
- **執行容錯移轉和容錯回復測試。** 確保您應用程式的相依服務以正確的順序容錯移轉及容錯回復。
- **執行模擬測試。** 測試現實生活案例可以彰顯必須解決的問題。 這些案例必須可控制，而且不會干擾到業務。 將模擬測試計劃告知管理部門。
- **測試健康情況探查。** 為負載平衡器和流量管理員設定健康情況探查，以檢查重要的系統元件。 進行測試，以確保這些元件可適當地回應。
- **測試監視系統。** 確保監視系統能夠確實回報重要資訊及精確的資料，以協助找出潛在的問題。
- **在測試案例中包含第三方服務。** 除了測試復原能力外，也測試因為第三方服務中斷導致的失敗點。

測試是反覆的程序。 測試應用程式、測量結果、分析及解決任何失敗，並重複此程序。

如需有關測試應用程式可靠性的詳細資訊，請參閱[測試 Azure 應用程式的復原能力和可用性](./testing.md)。

## <a name="deploy-the-application-consistently"></a>持續部署應用程式

「部署」包括佈建 Azure 資源、部署應用程式的程式碼，以及套用組態集。 更新可能需要這三個工作或這些工作的子集。

一旦應用程式部署到生產環境後，更新就會成為可能的錯誤來源。 針對可預測且可重複的部署程序，將其錯誤發生率降至最低。

- **自動執行應用程式的部署程序。** 盡可能自動化多個程序。
- **設計您的發行程序，以最大化可用性。** 如果您的發行程序要求服務在部署期間離線，您的應用程式將無法使用，直到服務重新上線為止。 充分運用平台的預備和實際執行功能。 使用藍綠部署或 Canary 版本來部署更新，以便在發生失敗時，您可以快速復原更新。
- **具備部署回復計劃。** 設計復原程序，以在部署失敗時，回到上一個已知良好的版本並將停機時間縮到最短。
- **記錄和稽核部署。** 如果您使用分段部署技術，您的應用程式會有一個以上的版本在生產環境中執行。 實作強固的記錄策略，儘可能擷取較多的版本特有資訊。
- **記載應用程式發行程序。** 明確定義和記載您的發行程序，並確保它可供整個營運小組使用。

如需有關應用程式可靠性及部署的詳細資訊，請參閱[部署 Azure 應用程式的復原能力和可用性](./deploy.md)。

## <a name="monitor-application-health"></a>監視應用程式健康情況

在您應用程式中實作監視和警示的最佳做法，讓您可以偵測失敗並向操作人員發出警示，以進行修正。

- **實作健康情況探查並檢查功能。** 定期從應用程式外部執行探查，以識別低落的應用程式健康情況和效能。
- **檢查長時間執行的工作流程。** 及早攔截問題可以減少復原復整個工作流程或執行多個補償交易的需求。
- **維護應用程式記錄。**

  - 記錄生產環境中和服務界限上的應用程式。
  - 使用語意和非同步記錄。
  - 將應用程式記錄檔與稽核記錄分開。

- **評估遠端呼叫統計資料，並與應用程式小組共用資料。** 若要讓作業小組可即時檢視應用程式的健康情況，可總結遠端呼叫計量，例如第 99 個和第 95 個百分位數中的延遲、輸送量和錯誤。 對計量執行統計分析，以發現在每個百分位數內發生的錯誤。
- **追蹤一段適當時間範圍內的暫時性例外狀況和重試數目。** 例外狀況隨著時間遞增的趨勢，表示服務有問題而且可能失敗。
- **設定預先警告系統。** 找出應用程式健康情況的關鍵效能指標 (KPI)，例如暫時性例外狀況和遠端呼叫延遲，並且為每個指標設定適當的閾值。 達到臨界值時，傳送警示給營運小組。
- **在 Azure 訂用帳戶限制內運作。** Azure 訂用帳戶對某些資源類型有所限制，例如資源群組、核心及儲存體帳戶的數目。 監看您對資源類型的使用方式。
- **監視第三方服務。** 記錄您的叫用作業，並使用唯一識別碼將其與您應用程式的健康情況和診斷記錄建立關聯。
- **訓練多個操作人員來監視應用程式並執行手動復原步驟。** 確保至少都有一個經過訓練的操作人員在工作崗位上。

如需有關監視應用程式可靠性的詳細資訊，請參閱[監視 Azure 應用程式健康情況](./monitoring.md)。

## <a name="respond-to-failures-and-disasters"></a>回應失敗和災害

建立復原計劃，並確定其涵蓋資料還原、網路中斷、相依服務失敗和全區域服務中斷。 在您的復原策略中，請考量到 VM、儲存體、資料庫和其他 Azure 平台服務。

- **Azure 支援互動的規劃。** 在產生需求之前，建立連絡 Azure 支援服務的程序。
- **記錄並測試災害復原計畫。** 撰寫災害復原計劃，以反映應用程式失敗的業務影響。 盡量自動化多個復原程序，並記錄任何手動步驟。 定期測試您的災害復原程序來驗證和改善計劃。
- **必要時進行手動容錯移轉。** 某些系統無法自動容錯移轉，而需要手動容錯移轉。 如果應用程式容錯移轉到次要區域，請執行作業整備測試。 確認主要區域狀況良好，且可再次接收流量後，才能執行容錯回復。 判斷效能變差的應用程式功能是哪一個，以及應用程式會如何將暫時性問題告知使用者。
- **針對應用程式失敗做好準備。** 針對一系列的失敗 (包括自動處理的錯誤) 做好準備，像是導致功能變差的失敗，以及造成應用程式無法使用的失敗。 應用程式應將暫時性問題告知使用者。
- **從資料損毀中復原。** 如果資料存放區中發生失敗，當存放區再次可用時，檢查是否有資料不一致的情況，特別是在已複寫資料時。 從備份還原損毀的資料。
- **從網路中斷中復原。** 您可以使用快取資料，在本機執行效能變差的應用程式功能。 如果沒有快取資料，請考慮讓應用程式停機或容錯移轉至另一個區域。 將資料儲存在替代位置，直到恢復連線為止。
- **從相依服務失敗中復原。** 判斷哪些功能仍然可用，以及應用程式應該如何回應。
- **從全區域服務中斷復原。** 全區域服務中斷的情況並不常見，但您應具備解決此問題的策略，特別是針對重要的應用程式。 您可以將應用程式重新部署到另一個區域或轉散發流量。

如需有關如何回應失敗和災害復原的詳細資訊，請參閱 [Azure 應用程式的失敗和災害復原](./disaster-recovery.md)。

## <a name="next-steps"></a>後續步驟

> [!div class="nextstepaction"]
> [開發可復原應用程式的需求](./requirements.md)
