---
title: Azure Databricks 使用 Azure 監視器的效能疑難排解
titleSuffix: ''
description: 使用 Azure Databricks 中的效能問題進行疑難排解的 Grafana 儀表板
author: petertaylor9999
ms.date: 04/02/2019
ms.topic: ''
ms.service: ''
ms.subservice: ''
ms.openlocfilehash: 49ec63d0c45ab388ca83b3ab0562428327539619
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/18/2019
ms.locfileid: "59740369"
---
# <a name="troubleshoot-performance-bottlenecks-in-azure-databricks"></a>疑難排解在 Azure Databricks 中的效能瓶頸

本文說明如何在 Azure Databricks 上的 Spark 作業中找出效能瓶頸時，用以監視儀表板。

[Azure Databricks](/azure/azure-databricks/)已[Apache Spark](https://spark.apache.org/)– 基礎分析服務，可讓您更快速開發並部署巨量資料分析變得更加容易。 監視和疑難排解效能問題時，重要作業系統生產 Azure Databricks 工作負載。 若要識別常見效能問題，最好使用監視根據遙測資料的視覺效果。

## <a name="prerequisites"></a>必要條件

若要設定本文中所示的 Grafana 儀表板：

- 設定您的 Databricks 叢集，以將遙測傳送至 Log Analytics 工作區中，使用 Azure Databricks 監視程式庫。 如需詳細資訊，請參閱 <<c0> [ 若要將計量傳送至 Azure 監視器設定 Azure Databricks](./configure-cluster.md)。

- 虛擬機器中部署 Grafana。 請參閱[使用儀表板，以視覺化方式檢視 Azure Databricks 計量](./dashboards.md)。

部署 Grafana 儀表板包含一組的時間序列視覺效果。 每個圖表會的 Apache Spark 作業，相關的度量的作業，以及每個階段所組成的工作階段的時間序列圖。

## <a name="azure-databricks-performance-overview"></a>Azure Databricks 效能概觀

Azure Databricks 是以 Apache Spark，這是一般用途的分散式運算系統為基礎。 應用程式程式碼，稱為**作業**，協調叢集管理員的 Apache Spark 叢集上執行。 一般情況下，作業是計算的最高層級單位。 工作代表完成的作業執行的 Spark 應用程式。 一般的作業包括從來源讀取資料、 套用資料轉換，並將結果寫入至儲存體或另一個目的地。

工作可分成**階段**。 作業播放階段循序，表示後面的階段中必須等候較早的階段，才能完成。 階段包含群組的相同**任務**，可以平行執行的 Spark 叢集的多個節點上。 工作是執行的最細微的資料子集上進行單位。

下節說明一些適用於效能疑難排解的儀表板視覺效果。

## <a name="job-and-stage-latency"></a>工作和階段延遲

此作業完成之前啟動時，作業延遲是從工作執行的持續時間。 它會顯示為工作執行每個叢集和應用程式識別碼的百分位數，以允許極端值的視覺效果。 下圖顯示作業歷程記錄的第 90 個百分位數，達到 50 秒，即使第 50 個百分位數一致的方式是大約 10 秒鐘左右。

![顯示作業的延遲圖表](./_images/grafana-job-latency.png)

請調查叢集和應用程式，查看尖峰延遲的作業執行。 一旦識別出叢集和應用程式具有高延遲，移至調查階段延遲。

若要讓極端值的視覺效果，階段延遲也會顯示為百分位數。 階段延遲分散的叢集、 應用程式，以及階段名稱。 識別圖形中要判斷哪些工作持有回階段完成的工作延遲尖峰。

![顯示階段延遲圖表](./_images/grafana-stage-latency.png)

叢集輸送量圖形顯示工作、 階段和每分鐘完成的工作的數目。 這可協助您了解階段和每個作業的工作數目相對方面的工作負載。 您可以看到每分鐘的作業數目範圍介於 2 到 6，雖然階段數大約 12 &ndash; 24 每分鐘。

![圖形顯示叢集輸送量](./_images/grafana-cluster-throughput.png)

## <a name="sum-of-task-execution-latency"></a>工作執行延遲的總和

此視覺效果會顯示每個主機叢集上執行的工作執行延遲的總和。 您可以使用此圖表來偵測在叢集或每個執行程式的工作 misallocation 因為主應用程式變慢而執行速度變慢的工作。 下圖中，大部分的主機會有約 30 秒的總和。 不過，兩個主機有大約 10 分鐘，將滑鼠停留的總和。 主機執行速度很慢或會如每個執行程式的工作數目。

![圖形顯示加總的每個主機的工作執行](./_images/grafana-sum-task-exec.png)

每個執行程式的工作數目會顯示，兩個執行程式會指派的工作，數目不相稱造成瓶頸。

![圖形來表示每個執行程式的工作](./_images/grafana-tasks-per-exec.png)

## <a name="task-metrics-per-stage"></a>工作計量，每個階段

工作計量視覺效果提供工作執行的成本細分。 您可以使用它所花費的相對的時間，請參閱上工作，例如序列化和還原序列化。 這項資料可能會顯示最佳化的機會&mdash;例如，藉由使用[將變數廣播](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables)以避免傳送資料。 工作計量也會顯示工作的隨機資料大小和隨機讀取和寫入次數。 如果這些值很高，這表示在網路之間是移動大量資料。

另一個工作計量是排程器的延遲，排程工作所花費的。 在理想情況下，這個值應該是低相較於執行程式計算時間，這是時間花在實際執行工作。

下圖所示的排程器的延遲時間 (3.7 s)，超過執行程式運算時間 (1.1 s)。 這表示更多的時間花在等候比執行實際的工作排程的工作。

![顯示每個階段的工作計量圖表](./_images/grafana-metrics-per-stage.png)

在此情況下，問題被因太多的資料分割，而造成的額外負荷很多。 減少資料分割數目降低的排程器的延遲時間。 下圖所示，大部分的時間是花費在執行工作。

![顯示每個階段的工作計量圖表](./_images/grafana-metrics-per-stage2.png)

## <a name="streaming-throughput-and-latency"></a>串流的輸送量和延遲

串流處理輸送量直接相關結構化串流。 有兩個重要的計量資料流的輸送量相關聯：每秒的第二個和處理資料列的輸入資料列。 如果每秒的輸入資料列 outpaces 每秒處理的資料列，則表示串流處理系統落後。 此外，如果輸入的資料來自事件中樞或 Kafka，然後每秒的輸入資料列應該跟在後端的資料擷取率。

兩個工作可以有類似的叢集輸送量，但非常不同的串流度量。 下列螢幕擷取畫面顯示兩個不同的工作負載。 也就是類似叢集的輸送量 （工作、 階段和工作每分鐘）。 但第二次執行會處理 12,000 資料列/秒與 4,000 資料列/秒。

![圖形顯示選串流輸送量](./_images/grafana-streaming-throughput.png)

串流處理能力通常是較佳的商務計量比叢集輸送量，因為它會測量所處理的資料記錄數目。

## <a name="resource-consumption-per-executor"></a>每個執行程式的資源耗用量

這些計量有助於了解每個執行程式執行的工作。

**百分比計量**測量執行程式執行了多少時間花費在各種項目，表示為與整體的執行程式計算時間花費的時間比例。 計量為：

- %序列化時間
- %還原序列化時間
- %Cpu 執行程式的時間
- JVM 時間 %

這些視覺效果顯示多少每個這些度量佔整體的執行程式處理。

![顯示百分比計量圖表](./_images/grafana-percentage.png)

**隨機播放計量**度量相關資料要跳過整個執行程式。

- 隨機 I/O
- 隨機記憶體
- 檔案系統使用量
- 磁碟使用量

## <a name="common-performance-bottlenecks"></a>常見的效能瓶頸

在 Spark 中的兩個常見效能瓶頸*落後的執行緒執行的工作*並*非最佳的隨機分割區計數*。

### <a name="task-stragglers"></a>工作落後的執行緒執行

中的工作階段會循序執行，以封鎖後續階段的早期階段。 如果一項工作執行隨機分割區的速度比其他工作，在叢集中的所有工作必須都等候趕上之前可以在結束階段緩慢的工作。 這種情形，原因如下：

1. 主機群組的執行速度很慢。 徵兆：高的工作、 階段或作業延遲和輸送量低的叢集。 不會平均分散工作延遲，每部主機的總和。 不過，資源耗用量會平均分散執行程式。

1. 工作必須耗費資源的彙總來執行 （資料扭曲）。 徵兆：高的工作、 階段，或作業和低的叢集的輸送量，但延遲每部主機的總和會平均分散。 資源耗用量會平均分散執行程式。

1. 如果資料分割的大小不相等，較大的磁碟分割可能會導致 （扭曲的磁碟分割） 的不平衡的工作執行。 徵兆：執行程式資源耗用量很高，相較於在叢集上執行其他執行程式。 在該執行程式上執行的所有工作將執行速度過慢，並保存在管線中的階段執行。 這些階段會稱為 「*預備阻礙*。

### <a name="non-optimal-shuffle-partition-count"></a>非最佳的隨機分割區計數

結構化串流查詢，在工作指派給一個執行程式會是叢集的資源密集型作業。 如果隨機資料不是理想的大小，工作延遲數量會在輸送量和延遲造成負面影響。 如果有太少的分割區，叢集中的核心將會是使用量過低會導致處理效率低落。 相反地，如果有太多資料分割，是管理的大量負擔少量的工作。

使用資源消耗度量扭曲的磁碟分割和 misallocation 的叢集上執行的程式進行疑難排解。 如果資料分割已扭曲，相較於在叢集上執行其他執行程式即將提升執行程式的資源。

例如下, 圖顯示所要跳過前兩個執行程式上使用的記憶體是 90 X 大於其他執行程式：

![顯示百分比計量圖表](./_images/grafana-shuffle-memory.png)