---
title: 針對混合式 VPN 連線進行疑難排解
titleSuffix: Azure Reference Architectures
description: 對內部部署網路與 Azure 之間的連線進行疑難排解。
author: telmosampaio
ms.date: 10/08/2018
ms.topic: article
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: networking
ms.openlocfilehash: 2140c67f23f11c355b286b28653d243b4adf8c73
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58243829"
---
# <a name="troubleshoot-a-hybrid-vpn-connection"></a><span data-ttu-id="011de-103">針對混合式 VPN 連線進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="011de-103">Troubleshoot a hybrid VPN connection</span></span>

<span data-ttu-id="011de-104">本文提供了對內部部署網路與 Azure 之間的 VPN 閘道連線進行疑難排解的一些提示。</span><span class="sxs-lookup"><span data-stu-id="011de-104">This article gives some tips for troubleshooting a VPN gateway connection between an on-premises network and Azure.</span></span> <span data-ttu-id="011de-105">如需針對常見 VPN 相關錯誤進行疑難排解的一般資訊，請參閱[針對常見 VPN 相關錯誤進行移難排解][troubleshooting-vpn-errors]。</span><span class="sxs-lookup"><span data-stu-id="011de-105">For general information on troubleshooting common VPN-related errors, see [Troubleshooting common VPN related errors][troubleshooting-vpn-errors].</span></span>

## <a name="verify-the-vpn-appliance-is-functioning-correctly"></a><span data-ttu-id="011de-106">驗證 VPN 設備是否正常運作</span><span class="sxs-lookup"><span data-stu-id="011de-106">Verify the VPN appliance is functioning correctly</span></span>

<span data-ttu-id="011de-107">下列建議有助於判斷您的內部部署 VPN 設備是否正常運作。</span><span class="sxs-lookup"><span data-stu-id="011de-107">The following recommendations are useful for determining if your on-premises VPN appliance is functioning correctly.</span></span>

<span data-ttu-id="011de-108">**請查看 VPN 設備產生的任何記錄，以檢查是否有錯誤或失敗。**</span><span class="sxs-lookup"><span data-stu-id="011de-108">**Check any log files generated by the VPN appliance for errors or failures.**</span></span> <span data-ttu-id="011de-109">這可協助您判斷 VPN 設備是否正確運作。</span><span class="sxs-lookup"><span data-stu-id="011de-109">This will help you determine if the VPN appliance is functioning correctly.</span></span> <span data-ttu-id="011de-110">此資訊的位置會因為您的設備不同而有所差異。</span><span class="sxs-lookup"><span data-stu-id="011de-110">The location of this information will vary according to your appliance.</span></span> <span data-ttu-id="011de-111">例如，如果您在 Windows Server 2012 上使用 RRAS，您可以使用下列 PowerShell 命令來顯示 RRAS 服務的錯誤事件資訊：</span><span class="sxs-lookup"><span data-stu-id="011de-111">For example, if you are using RRAS on Windows Server 2012, you can use the following PowerShell command to display error event information for the RRAS service:</span></span>

```PowerShell
Get-EventLog -LogName System -EntryType Error -Source RemoteAccess | Format-List -Property *
```

<span data-ttu-id="011de-112">每個項目的「訊息」屬性會提供錯誤的描述。</span><span class="sxs-lookup"><span data-stu-id="011de-112">The *Message* property of each entry provides a description of the error.</span></span> <span data-ttu-id="011de-113">一些常見的範例包括：</span><span class="sxs-lookup"><span data-stu-id="011de-113">Some common examples are:</span></span>

- <span data-ttu-id="011de-114">無法連線，可能是由於在 RRAS VPN 網路介面設定中為 Azure VPN 閘道指定了不正確的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="011de-114">Inability to connect, possibly due to an incorrect IP address specified for the Azure VPN gateway in the RRAS VPN network interface configuration.</span></span>

  ```console
  EventID            : 20111
  MachineName        : on-premises-vm
  Data               : {41, 3, 0, 0}
  Index              : 14231
  Category           : (0)
  CategoryNumber     : 0
  EntryType          : Error
  Message            : RoutingDomainID- {00000000-0000-0000-0000-000000000000}: A demand dial connection to the remote
                          interface AzureGateway on port VPN2-4 was successfully initiated but failed to complete
                          successfully because of the  following error: The network connection between your computer and
                          the VPN server could not be established because the remote server is not responding. This could
                          be because one of the network devices (for example, firewalls, NAT, routers, and so on) between your computer
                          and the remote server is not configured to allow VPN connections. Please contact your
                          Administrator or your service provider to determine which device may be causing the problem.
  Source             : RemoteAccess
  ReplacementStrings : {{00000000-0000-0000-0000-000000000000}, AzureGateway, VPN2-4, The network connection between
                          your computer and the VPN server could not be established because the remote server is not
                          responding. This could be because one of the network devices (for example, firewalls, NAT, routers, and so on)
                          between your computer and the remote server is not configured to allow VPN connections. Please
                          contact your Administrator or your service provider to determine which device may be causing the
                          problem.}
  InstanceId         : 20111
  TimeGenerated      : 3/18/2016 1:26:02 PM
  TimeWritten        : 3/18/2016 1:26:02 PM
  UserName           :
  Site               :
  Container          :
  ```

- <span data-ttu-id="011de-115">在 RRAS VPN 的網路介面設定中指定了錯誤的共用金鑰。</span><span class="sxs-lookup"><span data-stu-id="011de-115">The wrong shared key being specified in the RRAS VPN network interface configuration.</span></span>

  ```console
  EventID            : 20111
  MachineName        : on-premises-vm
  Data               : {233, 53, 0, 0}
  Index              : 14245
  Category           : (0)
  CategoryNumber     : 0
  EntryType          : Error
  Message            : RoutingDomainID- {00000000-0000-0000-0000-000000000000}: A demand dial connection to the remote
                          interface AzureGateway on port VPN2-4 was successfully initiated but failed to complete
                          successfully because of the  following error: Internet key exchange (IKE) authentication credentials are unacceptable.

  Source             : RemoteAccess
  ReplacementStrings : {{00000000-0000-0000-0000-000000000000}, AzureGateway, VPN2-4, IKE authentication credentials are
                          unacceptable.
                          }
  InstanceId         : 20111
  TimeGenerated      : 3/18/2016 1:34:22 PM
  TimeWritten        : 3/18/2016 1:34:22 PM
  UserName           :
  Site               :
  Container          :
  ```

<span data-ttu-id="011de-116">您也可以使用下列 PowerShell 命令，取得嘗試透過 RRAS 服務連線的相關事件記錄資訊：</span><span class="sxs-lookup"><span data-stu-id="011de-116">You can also obtain event log information about attempts to connect through the RRAS service using the following PowerShell command:</span></span>

```powershell
Get-EventLog -LogName Application -Source RasClient | Format-List -Property *
```

<span data-ttu-id="011de-117">在連線失敗的事件中，此記錄會包含看起來類似下列的錯誤：</span><span class="sxs-lookup"><span data-stu-id="011de-117">In the event of a failure to connect, this log will contain errors that look similar to the following:</span></span>

```console
EventID            : 20227
MachineName        : on-premises-vm
Data               : {}
Index              : 4203
Category           : (0)
CategoryNumber     : 0
EntryType          : Error
Message            : CoId={B4000371-A67F-452F-AA4C-3125AA9CFC78}: The user SYSTEM dialed a connection named
                        AzureGateway that has failed. The error code returned on failure is 809.
Source             : RasClient
ReplacementStrings : {{B4000371-A67F-452F-AA4C-3125AA9CFC78}, SYSTEM, AzureGateway, 809}
InstanceId         : 20227
TimeGenerated      : 3/18/2016 1:29:21 PM
TimeWritten        : 3/18/2016 1:29:21 PM
UserName           :
Site               :
Container          :
```

## <a name="verify-connectivity"></a><span data-ttu-id="011de-118">驗證連線能力</span><span class="sxs-lookup"><span data-stu-id="011de-118">Verify connectivity</span></span>

<span data-ttu-id="011de-119">**請檢查 VPN 閘道之間的連線和路由。**</span><span class="sxs-lookup"><span data-stu-id="011de-119">**Verify connectivity and routing across the VPN gateway.**</span></span> <span data-ttu-id="011de-120">VPN 設備可能沒有正確地透過 Azure VPN 閘道路由流量。</span><span class="sxs-lookup"><span data-stu-id="011de-120">The VPN appliance may not be correctly routing traffic through the Azure VPN Gateway.</span></span> <span data-ttu-id="011de-121">請使用 [PsPing][psping] 等工具來檢查 VPN 閘道之間的連線和路由。</span><span class="sxs-lookup"><span data-stu-id="011de-121">Use a tool such as [PsPing][psping] to verify connectivity and routing across the VPN gateway.</span></span> <span data-ttu-id="011de-122">例如，若要測試內部部署機器是否能連線至位於 VNet 上的 Web 伺服器，請執行下列命令 (使用 Web 伺服器的位址取代 `<<web-server-address>>`)：</span><span class="sxs-lookup"><span data-stu-id="011de-122">For example, to test connectivity from an on-premises machine to a web server located on the VNet, run the following command (replacing `<<web-server-address>>` with the address of the web server):</span></span>

```console
PsPing -t <<web-server-address>>:80
```

<span data-ttu-id="011de-123">如果內部部署機器可以將流量路由至 Web 伺服器，您應該會看到類似下列的輸出：</span><span class="sxs-lookup"><span data-stu-id="011de-123">If the on-premises machine can route traffic to the web server, you should see output similar to the following:</span></span>

```console
D:\PSTools>psping -t 10.20.0.5:80

PsPing v2.01 - PsPing - ping, latency, bandwidth measurement utility
Copyright (C) 2012-2014 Mark Russinovich
Sysinternals - www.sysinternals.com

TCP connect to 10.20.0.5:80:
Infinite iterations (warmup 1) connecting test:
Connecting to 10.20.0.5:80 (warmup): 6.21ms
Connecting to 10.20.0.5:80: 3.79ms
Connecting to 10.20.0.5:80: 3.44ms
Connecting to 10.20.0.5:80: 4.81ms

    Sent = 3, Received = 3, Lost = 0 (0% loss),
    Minimum = 3.44ms, Maximum = 4.81ms, Average = 4.01ms
```

<span data-ttu-id="011de-124">如果內部部署機器無法與指定的目的地通訊，您會看到像這樣的訊息：</span><span class="sxs-lookup"><span data-stu-id="011de-124">If the on-premises machine cannot communicate with the specified destination, you will see messages like this:</span></span>

```console
D:\PSTools>psping -t 10.20.1.6:80

PsPing v2.01 - PsPing - ping, latency, bandwidth measurement utility
Copyright (C) 2012-2014 Mark Russinovich
Sysinternals - www.sysinternals.com

TCP connect to 10.20.1.6:80:
Infinite iterations (warmup 1) connecting test:
Connecting to 10.20.1.6:80 (warmup): This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80: This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80: This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80: This operation returned because the timeout period expired.
Connecting to 10.20.1.6:80:
    Sent = 3, Received = 0, Lost = 3 (100% loss),
    Minimum = 0.00ms, Maximum = 0.00ms, Average = 0.00ms
```

<span data-ttu-id="011de-125">**請確認內部部署防火牆允許 VPN 流量通過且正確的連接埠已開啟。**</span><span class="sxs-lookup"><span data-stu-id="011de-125">**Verify that the on-premises firewall allows VPN traffic to pass and that the correct ports are opened.**</span></span>

<span data-ttu-id="011de-126">**請確認內部部署 VPN 設備使用的加密方法與 Azure VPN 閘道相容。**</span><span class="sxs-lookup"><span data-stu-id="011de-126">**Verify that the on-premises VPN appliance uses an encryption method that is compatible with the Azure VPN gateway.**</span></span> <span data-ttu-id="011de-127">針對原則型路由，Azure VPN 閘道支援 AES256、AES128 和 3DES 加密演算法。</span><span class="sxs-lookup"><span data-stu-id="011de-127">For policy-based routing, the Azure VPN gateway supports the AES256, AES128, and 3DES encryption algorithms.</span></span> <span data-ttu-id="011de-128">路由型閘道支援 AES256 和 3DES。</span><span class="sxs-lookup"><span data-stu-id="011de-128">Route-based gateways support AES256 and 3DES.</span></span> <span data-ttu-id="011de-129">如需詳細資訊，請參閱[關於 VPN 裝置和站對站 VPN 閘道連線的 IPsec/IKE 參數][vpn-appliance]。</span><span class="sxs-lookup"><span data-stu-id="011de-129">For more information, see [About VPN devices and IPsec/IKE parameters for Site-to-Site VPN Gateway connections][vpn-appliance].</span></span>

## <a name="check-for-problems-with-the-azure-vpn-gateway"></a><span data-ttu-id="011de-130">檢查與 Azure VPN 閘道的問題</span><span class="sxs-lookup"><span data-stu-id="011de-130">Check for problems with the Azure VPN gateway</span></span>

<span data-ttu-id="011de-131">下列建議有助於判斷 Azure VPN 閘道是否有問題：</span><span class="sxs-lookup"><span data-stu-id="011de-131">The following recommendations are useful for determining if there is a problem with the Azure VPN gateway:</span></span>

<span data-ttu-id="011de-132">**檢查 Azure VPN 閘道診斷記錄，以查看是否有潛在問題。**</span><span class="sxs-lookup"><span data-stu-id="011de-132">**Examine Azure VPN gateway diagnostic logs for potential issues.**</span></span> <span data-ttu-id="011de-133">請參閱[逐步說明：擷取 Azure Resource Manager VNET 閘道診斷記錄][gateway-diagnostic-logs]。</span><span class="sxs-lookup"><span data-stu-id="011de-133">See [Step-by-Step: Capturing Azure Resource Manager VNET Gateway Diagnostic Logs][gateway-diagnostic-logs].</span></span>

<span data-ttu-id="011de-134">**確認 Azure VPN 閘道與內部部署 VPN 設備是使用相同的共用驗證金鑰進行設定。**</span><span class="sxs-lookup"><span data-stu-id="011de-134">**Verify that the Azure VPN gateway and on-premises VPN appliance are configured with the same shared authentication key.**</span></span> <span data-ttu-id="011de-135">您可以使用下列 Azure CLI 命令，檢視 Azure VPN 閘道所儲存的共用金鑰：</span><span class="sxs-lookup"><span data-stu-id="011de-135">You can view the shared key stored by the Azure VPN gateway using the following Azure CLI command:</span></span>

```azurecli
azure network vpn-connection shared-key show <<resource-group>> <<vpn-connection-name>>
```

<span data-ttu-id="011de-136">您可以使用適用於您內部部署 VPN 設備的命令，來顯示該設備上設定的共用金鑰。</span><span class="sxs-lookup"><span data-stu-id="011de-136">Use the command appropriate for your on-premises VPN appliance to show the shared key configured for that appliance.</span></span>

<span data-ttu-id="011de-137">確認持有 Azure VPN 閘道的 GatewaySubnet 子網路沒有與 NSG 建立關聯。</span><span class="sxs-lookup"><span data-stu-id="011de-137">Verify that the *GatewaySubnet* subnet holding the Azure VPN gateway is not associated with an NSG.</span></span>

<span data-ttu-id="011de-138">您可使用下列 Azure CLI 命令檢視子網路詳細資料：</span><span class="sxs-lookup"><span data-stu-id="011de-138">You can view the subnet details using the following Azure CLI command:</span></span>

```azurecli
azure network vnet subnet show -g <<resource-group>> -e <<vnet-name>> -n GatewaySubnet
```

<span data-ttu-id="011de-139">請確定沒有名為「網路安全性群組識別碼」的資料欄位。</span><span class="sxs-lookup"><span data-stu-id="011de-139">Ensure there is no data field named *Network Security Group ID*.</span></span> <span data-ttu-id="011de-140">下列範例會示範具有指派 NSG (VPN-Gateway-Group) 的 GatewaySubnet 執行個體結果。</span><span class="sxs-lookup"><span data-stu-id="011de-140">The following example shows the results for an instance of the *GatewaySubnet* that has an assigned NSG (*VPN-Gateway-Group*).</span></span> <span data-ttu-id="011de-141">如果您有對此 NSG 定義任何規則，此動作可能會使得閘道無法正常運作。</span><span class="sxs-lookup"><span data-stu-id="011de-141">This can prevent the gateway from working correctly if there are any rules defined for this NSG.</span></span>

```console
C:\>azure network vnet subnet show -g profx-prod-rg -e profx-vnet -n GatewaySubnet
    info:    Executing command network vnet subnet show
    + Looking up virtual network "profx-vnet"
    + Looking up the subnet "GatewaySubnet"
    data:    Id                              : /subscriptions/########-####-####-####-############/resourceGroups/profx-prod-rg/providers/Microsoft.Network/virtualNetworks/profx-vnet/subnets/GatewaySubnet
    data:    Name                            : GatewaySubnet
    data:    Provisioning state              : Succeeded
    data:    Address prefix                  : 10.20.3.0/27
    data:    Network Security Group id       : /subscriptions/########-####-####-####-############/resourceGroups/profx-prod-rg/providers/Microsoft.Network/networkSecurityGroups/VPN-Gateway-Group
    info:    network vnet subnet show command OK
```

<span data-ttu-id="011de-142">**請確認 Azure VNet 中的虛擬機器設定為允許流量從外部 VNet 傳入。**</span><span class="sxs-lookup"><span data-stu-id="011de-142">**Verify that the virtual machines in the Azure VNet are configured to permit traffic coming in from outside the VNet.**</span></span> <span data-ttu-id="011de-143">如果有任何 NSG 規則與包含這些虛擬機器的子網路相關聯，請檢查這些規則。</span><span class="sxs-lookup"><span data-stu-id="011de-143">Check any NSG rules associated with subnets containing these virtual machines.</span></span> <span data-ttu-id="011de-144">您可使用下列 Azure CLI 命令檢視所有 NSG 規則：</span><span class="sxs-lookup"><span data-stu-id="011de-144">You can view all NSG rules using the following Azure CLI command:</span></span>

```azurecli
azure network nsg show -g <<resource-group>> -n <<nsg-name>>
```

<span data-ttu-id="011de-145">**請確認 Azure VPN 閘道已連線。**</span><span class="sxs-lookup"><span data-stu-id="011de-145">**Verify that the Azure VPN gateway is connected.**</span></span> <span data-ttu-id="011de-146">您可以使用下列 Azure PowerShell 命令來檢查 Azure VPN 連線的目前狀態。</span><span class="sxs-lookup"><span data-stu-id="011de-146">You can use the following Azure PowerShell command to check the current status of the Azure VPN connection.</span></span> <span data-ttu-id="011de-147">`<<connection-name>>` 參數是連結虛擬網路閘道與區域閘道的 Azure VPN 連線名稱。</span><span class="sxs-lookup"><span data-stu-id="011de-147">The `<<connection-name>>` parameter is the name of the Azure VPN connection that links the virtual network gateway and the local gateway.</span></span>

```powershell
Get-AzureRmVirtualNetworkGatewayConnection -Name <<connection-name>> - ResourceGroupName <<resource-group>>
```

<span data-ttu-id="011de-148">下列程式碼片段會醒目提示閘道連線時 (第一個範例) 和中斷連線時 (第二個範例) 所產生的輸出：</span><span class="sxs-lookup"><span data-stu-id="011de-148">The following snippets highlight the output generated if the gateway is connected (the first example), and disconnected (the second example):</span></span>

```powershell
PS C:\> Get-AzureRmVirtualNetworkGatewayConnection -Name profx-gateway-connection -ResourceGroupName profx-prod-rg

AuthorizationKey           :
VirtualNetworkGateway1     : Microsoft.Azure.Commands.Network.Models.PSVirtualNetworkGateway
VirtualNetworkGateway2     :
LocalNetworkGateway2       : Microsoft.Azure.Commands.Network.Models.PSLocalNetworkGateway
Peer                       :
ConnectionType             : IPsec
RoutingWeight              : 0
SharedKey                  : ####################################
ConnectionStatus           : Connected
EgressBytesTransferred     : 55254803
IngressBytesTransferred    : 32227221
ProvisioningState          : Succeeded
...
```

```powershell
PS C:\> Get-AzureRmVirtualNetworkGatewayConnection -Name profx-gateway-connection2 -ResourceGroupName profx-prod-rg

AuthorizationKey           :
VirtualNetworkGateway1     : Microsoft.Azure.Commands.Network.Models.PSVirtualNetworkGateway
VirtualNetworkGateway2     :
LocalNetworkGateway2       : Microsoft.Azure.Commands.Network.Models.PSLocalNetworkGateway
Peer                       :
ConnectionType             : IPsec
RoutingWeight              : 0
SharedKey                  : ####################################
ConnectionStatus           : NotConnected
EgressBytesTransferred     : 0
IngressBytesTransferred    : 0
ProvisioningState          : Succeeded
...
```

## <a name="miscellaneous-issues"></a><span data-ttu-id="011de-149">其他問題</span><span class="sxs-lookup"><span data-stu-id="011de-149">Miscellaneous issues</span></span>

<span data-ttu-id="011de-150">下列建議有助於判斷主機虛擬機器設定、網路頻寬使用率或應用程式效能是否有問題：</span><span class="sxs-lookup"><span data-stu-id="011de-150">The following recommendations are useful for determining if there is an issue with Host VM configuration, network bandwidth utilization, or application performance:</span></span>

<span data-ttu-id="011de-151">**驗證防火牆組態。**</span><span class="sxs-lookup"><span data-stu-id="011de-151">**Verify firewall configuration.**</span></span> <span data-ttu-id="011de-152">如果子網路中的 Azure 虛擬機器上正在執行客體作業系統，請確認其中的防火牆已正確設定，可允許內部部署 IP 範圍中的許可流量。</span><span class="sxs-lookup"><span data-stu-id="011de-152">Verify that the firewall in the guest operating system running on the Azure VMs in the subnet is configured correctly to allow permitted traffic from the on-premises IP ranges.</span></span>

<span data-ttu-id="011de-153">**請確認流量尚未接近 Azure VPN 閘道可用的頻寬上限。**</span><span class="sxs-lookup"><span data-stu-id="011de-153">**Verify that the volume of traffic is not close to the limit of the bandwidth available to the Azure VPN gateway.**</span></span> <span data-ttu-id="011de-154">驗證此項目的方式取決於在內部部署的 VPN 設備。</span><span class="sxs-lookup"><span data-stu-id="011de-154">How to verify this depends on the VPN appliance running on-premises.</span></span> <span data-ttu-id="011de-155">例如，如果您在 Windows Server 2012 上使用 RRAS，您可以使用效能監視器來追蹤透過 VPN 連線收到和傳輸的資料量。</span><span class="sxs-lookup"><span data-stu-id="011de-155">For example, if you are using RRAS on Windows Server 2012, you can use Performance Monitor to track the volume of data being received and transmitted over the VPN connection.</span></span> <span data-ttu-id="011de-156">如果使用「RAS 總計」物件，請選取「接收的位元組/秒」和「傳輸的位元組/秒」計數器：</span><span class="sxs-lookup"><span data-stu-id="011de-156">Using the *RAS Total* object, select the *Bytes Received/Sec* and *Bytes Transmitted/Sec* counters:</span></span>

![監視 VPN 網路流量的效能計數器](../_images/guidance-hybrid-network-vpn/RRAS-perf-counters.png)

<span data-ttu-id="011de-158">您應比較 VPN 閘道的可用頻寬所產生的結果 (從基本 SKU 的 100 Mbps 到 VpnGw3 SKU 的 1.25 Gbps)：</span><span class="sxs-lookup"><span data-stu-id="011de-158">You should compare the results with the bandwidth available to the VPN gateway (from 100 Mbps for the Basic SKU to 1.25 Gbps for VpnGw3 SKU):</span></span>

![範例 VPN 網路的效能圖表](../_images/guidance-hybrid-network-vpn/RRAS-perf-graph.png)

<span data-ttu-id="011de-160">**請確認您已針對應用程式負載，部署正確的虛擬機器數量和大小。**</span><span class="sxs-lookup"><span data-stu-id="011de-160">**Verify that you have deployed the right number and size of VMs for your application load.**</span></span> <span data-ttu-id="011de-161">判斷 Azure VNet 中是否有任何一部虛擬機器執行速度緩慢。</span><span class="sxs-lookup"><span data-stu-id="011de-161">Determine if any of the virtual machines in the Azure VNet are running slowly.</span></span> <span data-ttu-id="011de-162">如果有，則表示虛擬機器負載可能過重、虛擬機器可能太少以至於無法處理負載，或是負載平衡器可能未正確設定。</span><span class="sxs-lookup"><span data-stu-id="011de-162">If so, they may be overloaded, there may be too few to handle the load, or the load-balancers may not be configured correctly.</span></span> <span data-ttu-id="011de-163">若要判斷原因，可[擷取及分析診斷資訊][azure-vm-diagnostics]。</span><span class="sxs-lookup"><span data-stu-id="011de-163">To determine this, [capture and analyze diagnostic information][azure-vm-diagnostics].</span></span> <span data-ttu-id="011de-164">您可以使用 Azure 入口網站檢查結果，但也有許多第三方工具可協助您深入了解效能資料。</span><span class="sxs-lookup"><span data-stu-id="011de-164">You can examine the results using the Azure portal, but many third-party tools are also available that can provide detailed insights into the performance data.</span></span>

<span data-ttu-id="011de-165">**請確認應用程式正在有效率地使用雲端資源。**</span><span class="sxs-lookup"><span data-stu-id="011de-165">**Verify that the application is making efficient use of cloud resources.**</span></span> <span data-ttu-id="011de-166">檢測每個虛擬機器上執行的應用程式程式碼，判斷應用程式是否以最佳方式在使用資源。</span><span class="sxs-lookup"><span data-stu-id="011de-166">Instrument application code running on each VM to determine whether applications are making the best use of resources.</span></span> <span data-ttu-id="011de-167">您可以使用 [Application Insights][application-insights] 等工具。</span><span class="sxs-lookup"><span data-stu-id="011de-167">You can use tools such as [Application Insights][application-insights].</span></span>

<!-- links -->

[application-insights]: /azure/application-insights/app-insights-overview-usage
[azure-vm-diagnostics]: https://azure.microsoft.com/blog/windows-azure-virtual-machine-monitoring-with-wad-extension/
[gateway-diagnostic-logs]: https://blogs.technet.microsoft.com/keithmayer/2016/10/12/step-by-step-capturing-azure-resource-manager-arm-vnet-gateway-diagnostic-logs/
[psping]: https://technet.microsoft.com/sysinternals/jj729731.aspx
[troubleshooting-vpn-errors]: https://blogs.technet.microsoft.com/rrasblog/2009/08/12/troubleshooting-common-vpn-related-errors/
[vpn-appliance]: /azure/vpn-gateway/vpn-gateway-about-vpn-devices
