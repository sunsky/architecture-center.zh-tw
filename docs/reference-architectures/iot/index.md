---
title: Azure IoT 參考架構
description: 使用 PaaS (平台即服務) 元件在 Azure 上建議的 IoT 應用程式架構
titleSuffix: Azure Reference Architectures
author: MikeWasson
ms.date: 01/09/2019
ms.openlocfilehash: 5a4b104044f3e64ffdce98e3952201d397d41f33
ms.sourcegitcommit: 700a4f6ce61b1ebe68e227fc57443e49282e35aa
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/07/2019
ms.locfileid: "55887347"
---
# <a name="azure-iot-reference-architecture"></a><span data-ttu-id="8cd88-103">Azure IoT 參考架構</span><span class="sxs-lookup"><span data-stu-id="8cd88-103">Azure IoT reference architecture</span></span>

<span data-ttu-id="8cd88-104">此參考架構展示使用 PaaS (平台即服務) 元件在 Azure 上建議的 IoT 應用程式架構。</span><span class="sxs-lookup"><span data-stu-id="8cd88-104">This reference architecture shows a recommended architecture for IoT applications on Azure using PaaS (platform-as-a-service) components.</span></span>

![架構圖](./_images/iot.png)

<span data-ttu-id="8cd88-106">IoT 應用程式可以描述為**事項** (裝置)，傳送產生**深入解析**的資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-106">IoT applications can be described as **things** (devices) sending data that generates **insights**.</span></span> <span data-ttu-id="8cd88-107">這些深入解析會產生**動作**，以改善商務或流程。</span><span class="sxs-lookup"><span data-stu-id="8cd88-107">These insights generate **actions** to improve a business or process.</span></span> <span data-ttu-id="8cd88-108">一個例子是引擎 (事項) 傳送溫度資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-108">An example is an engine (the thing) sending temperature data.</span></span> <span data-ttu-id="8cd88-109">這項資料用於評估引擎是否如預期般執行 (深入解析)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-109">This data is used to evaluate whether the engine is performing as expected (the insight).</span></span> <span data-ttu-id="8cd88-110">深入解析用於主動排定引擎維修排程的優先順序 (動作)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-110">The insight is used to proactively prioritize the maintenance schedule for the engine (the action).</span></span>

<span data-ttu-id="8cd88-111">此參考架構使用 Azure PaaS (平台即服務) 元件。</span><span class="sxs-lookup"><span data-stu-id="8cd88-111">This reference architecture uses Azure PaaS (platform-as-a-service) components.</span></span> <span data-ttu-id="8cd88-112">在 Azure 上建置 IoT 解決方案的其他選項，包括：</span><span class="sxs-lookup"><span data-stu-id="8cd88-112">Other options for building IoT solutions on Azure include:</span></span>

- <span data-ttu-id="8cd88-113">[Azure IoT Central](/azure/iot-central/)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-113">[Azure IoT Central](/azure/iot-central/).</span></span> <span data-ttu-id="8cd88-114">IoT Central 是完全受控的 SaaS (軟體即服務) 解決方案。</span><span class="sxs-lookup"><span data-stu-id="8cd88-114">IoT Central is a fully managed SaaS (software-as-a-service) solution.</span></span> <span data-ttu-id="8cd88-115">它會擷取技術選擇，讓您獨佔地專注於您的解決方案。</span><span class="sxs-lookup"><span data-stu-id="8cd88-115">It abstracts the technical choices and lets you focus on your solution exclusively.</span></span> <span data-ttu-id="8cd88-116">以 PaaS 為基礎的解決方案相比，這樣的簡單性會降低其可自訂性。</span><span class="sxs-lookup"><span data-stu-id="8cd88-116">This simplicity comes with a tradeoff in being less customizable than a PaaS-based solution.</span></span>
- <span data-ttu-id="8cd88-117">使用 OSS 元件，例如 SMACK堆疊 (Spark、Mesos、Akka、Cassandra、Kafka) 部署在 Azure VM 上。</span><span class="sxs-lookup"><span data-stu-id="8cd88-117">Using OSS components such as the SMACK stack (Spark, Mesos, Akka, Cassandra, Kafka) deployed on Azure VMs.</span></span> <span data-ttu-id="8cd88-118">這種方法提供了很多控制項，但是加複雜。</span><span class="sxs-lookup"><span data-stu-id="8cd88-118">This approach offers a great deal of control but is more complex.</span></span>

<span data-ttu-id="8cd88-119">概括而言，有兩種方式可處理遙測資料、最忙碌路徑和非經常性路徑。</span><span class="sxs-lookup"><span data-stu-id="8cd88-119">At a high level, there are two ways to process telemetry data, hot path and cold path.</span></span> <span data-ttu-id="8cd88-120">差異與對延遲和資料存取的要求有關。</span><span class="sxs-lookup"><span data-stu-id="8cd88-120">The difference has to do with requirements for latency and data access.</span></span>

- <span data-ttu-id="8cd88-121">**最忙碌路徑**在到達時，會分析近乎即時的資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-121">The **hot path** analyzes data in near-real-time, as it arrives.</span></span> <span data-ttu-id="8cd88-122">在最忙碌路徑中，必須以非常低的延遲處理遙測。</span><span class="sxs-lookup"><span data-stu-id="8cd88-122">In the hot path, telemetry must be processed with very low latency.</span></span> <span data-ttu-id="8cd88-123">最忙碌路徑通常是使用串流處理引擎來實作。</span><span class="sxs-lookup"><span data-stu-id="8cd88-123">The hot path is typically implemented using a stream processing engine.</span></span> <span data-ttu-id="8cd88-124">輸出可能會觸發警示，或寫入可以使用分析工具查詢結構化的格式。</span><span class="sxs-lookup"><span data-stu-id="8cd88-124">The output may trigger an alert, or be written to a structured format that can be queried using analytical tools.</span></span>
- <span data-ttu-id="8cd88-125">**非經常性路徑**以較長的時間間隔 (每小時或每日) 執行批次處理。</span><span class="sxs-lookup"><span data-stu-id="8cd88-125">The **cold path** performs batch processing at longer intervals (hourly or daily).</span></span> <span data-ttu-id="8cd88-126">非經常性路徑通常會運行大量資料，但結果不需要像最忙碌路徑一樣及時。</span><span class="sxs-lookup"><span data-stu-id="8cd88-126">The cold path typically operates over large volumes of data, but the results don't need to be as timely as the hot path.</span></span> <span data-ttu-id="8cd88-127">在非經常性路徑中，擷取未經處理的遙測，然後傳送至批次程序。</span><span class="sxs-lookup"><span data-stu-id="8cd88-127">In the cold path, raw telemetry is captured and then fed into a batch process.</span></span>

## <a name="architecture"></a><span data-ttu-id="8cd88-128">架構</span><span class="sxs-lookup"><span data-stu-id="8cd88-128">Architecture</span></span>

<span data-ttu-id="8cd88-129">此架構由下列元件組成。</span><span class="sxs-lookup"><span data-stu-id="8cd88-129">This architecture consists of the following components.</span></span> <span data-ttu-id="8cd88-130">有些應用程式可能不需要此處所列的每個元件。</span><span class="sxs-lookup"><span data-stu-id="8cd88-130">Some applications may not require every component listed here.</span></span>

<span data-ttu-id="8cd88-131">**IoT 裝置**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-131">**IoT devices**.</span></span> <span data-ttu-id="8cd88-132">裝置可以安全地向雲端註冊，而且可以連線至雲端，以傳送和接收資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-132">Devices can securely register with the cloud, and can connect to the cloud to send and receive data.</span></span> <span data-ttu-id="8cd88-133">某些裝置可能是**邊緣裝置**，其在裝置本身或現場閘道中執行一些資料處理。</span><span class="sxs-lookup"><span data-stu-id="8cd88-133">Some devices may be **edge devices** that perform some data processing on the device itself or in a field gateway.</span></span> <span data-ttu-id="8cd88-134">我們建議使用 [Azure IoT Edge](/azure/iot-edge/) 進行邊緣處理。</span><span class="sxs-lookup"><span data-stu-id="8cd88-134">We recommend [Azure IoT Edge](/azure/iot-edge/) for edge processing.</span></span>

<span data-ttu-id="8cd88-135">**雲端閘道**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-135">**Cloud gateway**.</span></span> <span data-ttu-id="8cd88-136">雲端閘道為裝置提供了一個雲端中樞，以便安全地連線到雲端並傳送資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-136">A cloud gateway provides a cloud hub for devices to connect securely to the cloud and send data.</span></span> <span data-ttu-id="8cd88-137">它也會提供裝置管理和功能，包括裝置的命令與控制項。</span><span class="sxs-lookup"><span data-stu-id="8cd88-137">It also provides device management, capabilities, including command and control of devices.</span></span> <span data-ttu-id="8cd88-138">對於雲端閘道，我們建議使用 [IoT 中樞](/azure/iot-hub/)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-138">For the cloud gateway, we recommend [IoT Hub](/azure/iot-hub/).</span></span> <span data-ttu-id="8cd88-139">IoT 中樞是一種託管雲端服務，會從裝置擷取事件，作為裝置與後端服務之間的訊息代理人。</span><span class="sxs-lookup"><span data-stu-id="8cd88-139">IoT Hub is a hosted cloud service that ingests events from devices, acting as a message broker between devices and backend services.</span></span> <span data-ttu-id="8cd88-140">IoT 中樞提供安全的連線能力、事件擷取、雙向通訊，以及裝置管理。</span><span class="sxs-lookup"><span data-stu-id="8cd88-140">IoT Hub provides secure connectivity, event ingestion, bidirectional communication, and device management.</span></span>

<span data-ttu-id="8cd88-141">**裝置佈建IoT**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-141">**Device provisioning.**</span></span> <span data-ttu-id="8cd88-142">對於註冊和連接大量裝置，我們建議使用 [IoT 中樞裝置佈建服務](/azure/iot-dps/) (DPS)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-142">For registering and connecting large sets of devices, we recommend using the [IoT Hub Device Provisioning Service](/azure/iot-dps/) (DPS).</span></span> <span data-ttu-id="8cd88-143">DPS 可讓您大規模地將裝置指派和註冊至特定 Azure IoT 中樞端點。</span><span class="sxs-lookup"><span data-stu-id="8cd88-143">DPS lets you assign and register devices to specific Azure IoT Hub endpoints at scale.</span></span>

<span data-ttu-id="8cd88-144">**串流處理**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-144">**Stream processing**.</span></span> <span data-ttu-id="8cd88-145">串流處理分析大量資料記錄，並評估這些串流的規則。</span><span class="sxs-lookup"><span data-stu-id="8cd88-145">Stream processing analyzes large streams of data records and evaluates rules for those streams.</span></span> <span data-ttu-id="8cd88-146">對於串流處理，我們建議使用 [Azure 串流分析](/azure/stream-analytics/)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-146">For stream processing, we recommend [Azure Stream Analytics](/azure/stream-analytics/).</span></span> <span data-ttu-id="8cd88-147">串流分析可執行大規模的複雜分析、使用時間範圍函式、資料流彙總，以及外部資料來源聯結。</span><span class="sxs-lookup"><span data-stu-id="8cd88-147">Stream Analytics can execute complex analysis at scale, using time windowing functions, stream aggregations, and external data source joins.</span></span> <span data-ttu-id="8cd88-148">另一個選項是 [Azure Databricks](/azure/azure-databricks/) 上 Apache Spark。</span><span class="sxs-lookup"><span data-stu-id="8cd88-148">Another option is Apache Spark on [Azure Databricks](/azure/azure-databricks/).</span></span>

<span data-ttu-id="8cd88-149">機器學習允許在歷史遙測資料上執行預測演算法，以啟用如預測性維護等的案例。</span><span class="sxs-lookup"><span data-stu-id="8cd88-149">Machine learning allows predictive algorithms to be executed over historical telemetry data, enabling scenarios such as predictive maintenance.</span></span> <span data-ttu-id="8cd88-150">對於機器學習，我們建議使用 [Azure Machine Learning 服務](/azure/machine-learning/service/)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-150">For machine learning, we recommend [Azure Machine Learning Service](/azure/machine-learning/service/).</span></span>

<span data-ttu-id="8cd88-151">**經常性路徑儲存體**保存必須從裝置立即取得，以用於報告和視覺效果的資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-151">**Warm path storage** holds data that must be available immediately from device for reporting and visualization.</span></span> <span data-ttu-id="8cd88-152">對於經常性路徑儲存體，我們建議使用 [Cosmos DB](/azure/cosmos-db/introduction)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-152">For warm path storage, we recommend [Cosmos DB](/azure/cosmos-db/introduction).</span></span> <span data-ttu-id="8cd88-153">Cosmos DB 是全域散發的多模型資料庫。</span><span class="sxs-lookup"><span data-stu-id="8cd88-153">Cosmos DB is a globally distributed, multi-model database.</span></span>

<span data-ttu-id="8cd88-154">**非經常性路徑儲存體**保存長期保留的資料，並用於批次處理。</span><span class="sxs-lookup"><span data-stu-id="8cd88-154">**Cold path storage** holds data that is kept longer term and is used for batch processing.</span></span> <span data-ttu-id="8cd88-155">對於非經常性路徑儲存體，我們建議使用 [Azure Blob 儲存體](/azure/storage/blobs/storage-blobs-introduction)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-155">For cold path storage, we recommend [Azure Blob Storage](/azure/storage/blobs/storage-blobs-introduction).</span></span> <span data-ttu-id="8cd88-156">可以將資料無限期地以較低的成本封存在 Blob 儲存體中，並可以輕鬆存取以供批次處理。</span><span class="sxs-lookup"><span data-stu-id="8cd88-156">Data can be archived in Blob storage indefinitely at low cost, and is easily accessible for batch processing.</span></span>

<span data-ttu-id="8cd88-157">**資料轉換**操縱或彙總遙測串流。</span><span class="sxs-lookup"><span data-stu-id="8cd88-157">**Data transformation** manipulates or aggregates the telemetry stream.</span></span> <span data-ttu-id="8cd88-158">範例包括通訊協定轉換，例如將二進位資料轉換為 JSON，或結合資料點。</span><span class="sxs-lookup"><span data-stu-id="8cd88-158">Examples include protocol transformation, such as converting binary data to JSON, or combining data points.</span></span> <span data-ttu-id="8cd88-159">如果必須在到達 IoT 中樞之前轉換資料，我們建議使用[通訊協定閘道](/azure/iot-hub/iot-hub-protocol-gateway) (未顯示)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-159">If the data must be transformed before reaching IoT Hub, we recommend using a [protocol gateway](/azure/iot-hub/iot-hub-protocol-gateway) (not shown).</span></span> <span data-ttu-id="8cd88-160">否則，可以在到達 IoT 中樞之後再轉換資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-160">Otherwise, data can be transformed after it reaches IoT Hub.</span></span> <span data-ttu-id="8cd88-161">在此情況下，我們建議使用 [Azure Functions](/azure/azure-functions/)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-161">In that case, we recommend using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="8cd88-162">Functions 已與 IoT 中樞、Cosmos DB 與 Blob 儲存體內建整合。</span><span class="sxs-lookup"><span data-stu-id="8cd88-162">Functions has built-in integration with IoT Hub, Cosmos DB, and Blob Storage.</span></span>

<span data-ttu-id="8cd88-163">**企業處理整合**根據裝置資料的深入解析執行動作。</span><span class="sxs-lookup"><span data-stu-id="8cd88-163">**Business process integration** performs actions based on insights from the device data.</span></span> <span data-ttu-id="8cd88-164">這可能包括儲存資訊訊息、引發警示、傳送電子郵件或簡訊，或與 CRM 整合。</span><span class="sxs-lookup"><span data-stu-id="8cd88-164">This could include storing informational messages, raising alarms, sending email or SMS messages, or integrating with CRM.</span></span> <span data-ttu-id="8cd88-165">我們建議使用 [Azure Logic Apps](/azure/logic-apps/logic-apps-overview) 進行企業處理整合。</span><span class="sxs-lookup"><span data-stu-id="8cd88-165">We recommend using [Azure Logic Apps](/azure/logic-apps/logic-apps-overview) for business process integration.</span></span>

<span data-ttu-id="8cd88-166">**使用者管理**會限制哪些使用者或群組可以在裝置上執行動作，例如升級韌體。</span><span class="sxs-lookup"><span data-stu-id="8cd88-166">**User management** restricts which users or groups can perform actions on devices, such as upgrading firmware.</span></span> <span data-ttu-id="8cd88-167">它也會為應用程式中的使用者定義功能。</span><span class="sxs-lookup"><span data-stu-id="8cd88-167">It also defines capabilities for users in applications.</span></span> <span data-ttu-id="8cd88-168">我們建議使用 [Azure Active Directory](/azure/active-directory/) 來驗證並授權使用者。</span><span class="sxs-lookup"><span data-stu-id="8cd88-168">We recommend using [Azure Active Directory](/azure/active-directory/) to authenticate and authorize users.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="8cd88-169">延展性考量</span><span class="sxs-lookup"><span data-stu-id="8cd88-169">Scalability considerations</span></span>

<span data-ttu-id="8cd88-170">IoT 應用程式應建置為可獨立調整的離散服務。</span><span class="sxs-lookup"><span data-stu-id="8cd88-170">An IoT application should be built as discrete services that can scale independently.</span></span> <span data-ttu-id="8cd88-171">請考慮下列延展性的點：</span><span class="sxs-lookup"><span data-stu-id="8cd88-171">Consider the following scalability points:</span></span>

<span data-ttu-id="8cd88-172">**IoTHub**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-172">**IoTHub**.</span></span> <span data-ttu-id="8cd88-173">對於 IoT 中樞，請考慮下列比例因素：</span><span class="sxs-lookup"><span data-stu-id="8cd88-173">For IoT Hub, consider the following scale factors:</span></span>

- <span data-ttu-id="8cd88-174">IoT 中樞[每日配額](/azure/iot-hub/iot-hub-devguide-quotas-throttling)訊息的上限。</span><span class="sxs-lookup"><span data-stu-id="8cd88-174">The maximum [daily quota](/azure/iot-hub/iot-hub-devguide-quotas-throttling) of messages into IoT Hub.</span></span>
- <span data-ttu-id="8cd88-175">IoT 中樞執行個體中已連線裝置的配額。</span><span class="sxs-lookup"><span data-stu-id="8cd88-175">The quota of connected devices in an IoT Hub instance.</span></span>
- <span data-ttu-id="8cd88-176">擷取輸送量 &mdash; IoT 中樞可以擷取訊息的速度。</span><span class="sxs-lookup"><span data-stu-id="8cd88-176">Ingestion throughput &mdash; how quickly IoT Hub can ingest messages.</span></span>
- <span data-ttu-id="8cd88-177">處理輸送量 &mdash; 處理內送訊息的速度。</span><span class="sxs-lookup"><span data-stu-id="8cd88-177">Processing throughput &mdash; how quickly the incoming messages are processed.</span></span>

<span data-ttu-id="8cd88-178">佈建每個 IoT 中樞時，都會為其佈建特定層級中的特定單位數。</span><span class="sxs-lookup"><span data-stu-id="8cd88-178">Each IoT hub is provisioned with a certain number of units in a specific tier.</span></span> <span data-ttu-id="8cd88-179">層級和單位數會決定裝置每天可傳送至中樞的訊息配額上限。</span><span class="sxs-lookup"><span data-stu-id="8cd88-179">The tier and number of units determine the maximum daily quota of messages that devices can send to the hub.</span></span> <span data-ttu-id="8cd88-180">如需詳細資訊，請參閱 IoT 中樞配額和節流。</span><span class="sxs-lookup"><span data-stu-id="8cd88-180">For more information, see IoT Hub quotas and throttling.</span></span> <span data-ttu-id="8cd88-181">您可以相應增加一個中樞，而不會中斷現有作業。</span><span class="sxs-lookup"><span data-stu-id="8cd88-181">You can scale up a hub without interrupting existing operations.</span></span>

<span data-ttu-id="8cd88-182">**串流分析**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-182">**Stream Analytics**.</span></span> <span data-ttu-id="8cd88-183">如果串流分析作業與串流分析管道 (從輸入到查詢再到輸出) 中的所有點為平行處理，則串流分析作業的擴展性最佳。</span><span class="sxs-lookup"><span data-stu-id="8cd88-183">Stream Analytics jobs scale best if they are parallel at all points in the Stream Analytics pipeline, from input to query to output.</span></span> <span data-ttu-id="8cd88-184">完全平行的作業允許串流分析橫跨多個計算節點來分割工作。</span><span class="sxs-lookup"><span data-stu-id="8cd88-184">A fully parallel job allows Stream Analytics to split the work across multiple compute nodes.</span></span> <span data-ttu-id="8cd88-185">否則，串流分析必須將串流資料合併到一個地方。</span><span class="sxs-lookup"><span data-stu-id="8cd88-185">Otherwise, Stream Analytics has to combine the stream data into one place.</span></span> <span data-ttu-id="8cd88-186">如需詳細資訊，請參閱[利用 Azure 串流分析中的查詢平行化作業](/azure/stream-analytics/stream-analytics-parallelization)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-186">For more information, see [Leverage query parallelization in Azure Stream Analytics](/azure/stream-analytics/stream-analytics-parallelization).</span></span>

<span data-ttu-id="8cd88-187">IoT 中樞根據裝置識別碼自動分割裝置訊息。</span><span class="sxs-lookup"><span data-stu-id="8cd88-187">IoT Hub automatically partitions device messages based on the device ID.</span></span> <span data-ttu-id="8cd88-188">特定裝置的所有訊息一定會抵達相同的磁碟分割，但單一分割區將具有來自多個裝置的訊息。</span><span class="sxs-lookup"><span data-stu-id="8cd88-188">All of the messages from a particular device will always arrive on the same partition, but a single partition will have messages from multiple devices.</span></span> <span data-ttu-id="8cd88-189">因此，平行處理的單位是分割區識別碼。</span><span class="sxs-lookup"><span data-stu-id="8cd88-189">Therefore, the unit of parallelization is the partition ID.</span></span>

<span data-ttu-id="8cd88-190">**Functions**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-190">**Functions**.</span></span> <span data-ttu-id="8cd88-191">從事件中樞端點讀取時，每個事件中樞分割區最多有一個函式執行個體。</span><span class="sxs-lookup"><span data-stu-id="8cd88-191">When reading from the Event Hubs endpoint, there is a maximum of function instance per event hub partition.</span></span> <span data-ttu-id="8cd88-192">最快的處理速率取決於一個函式執行個體處理來自單一分割區事件的速度。</span><span class="sxs-lookup"><span data-stu-id="8cd88-192">The maximum processing rate is determined by how fast one function instance can process the events from a single partition.</span></span> <span data-ttu-id="8cd88-193">該函式應該批次處理訊息。</span><span class="sxs-lookup"><span data-stu-id="8cd88-193">The function should process messages in batches.</span></span>

<span data-ttu-id="8cd88-194">**Cosmos DB**。</span><span class="sxs-lookup"><span data-stu-id="8cd88-194">**Cosmos DB**.</span></span> <span data-ttu-id="8cd88-195">若要擴充 Cosmos DB 集合，請使用分割區索引鍵建立集合，並在您寫入的每個文件中包含分割區索引鍵。</span><span class="sxs-lookup"><span data-stu-id="8cd88-195">To scale out a Cosmos DB collection, create the collection with a partition key and include the partition key in each document that you write.</span></span> <span data-ttu-id="8cd88-196">如需詳細資訊，請參閱[選擇分割區索引鍵時的最佳做法](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-196">For more information, see [Best practices when choosing a partition key](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key).</span></span>

- <span data-ttu-id="8cd88-197">如果您為每個裝置儲存並更新單一文件時，裝置識別碼是很好的分割區索引鍵。</span><span class="sxs-lookup"><span data-stu-id="8cd88-197">If you store and update a single document per device, the device ID is a good partition key.</span></span> <span data-ttu-id="8cd88-198">寫入資料已平均分散在索引鍵上。</span><span class="sxs-lookup"><span data-stu-id="8cd88-198">Writes are evenly distributed across the keys.</span></span> <span data-ttu-id="8cd88-199">嚴格限制每個分割區的大小，因為每個索引鍵的值都有一個文件。</span><span class="sxs-lookup"><span data-stu-id="8cd88-199">The size of each partition is strictly bounded, because there is a single document for each key value.</span></span>
- <span data-ttu-id="8cd88-200">如果您為每個裝置訊息儲存個別的文件，則使用裝置識別碼作為分割區索引鍵，會快速超過每個分割區 10 GB 的限制。</span><span class="sxs-lookup"><span data-stu-id="8cd88-200">If you store a separate document for every device message, using the device ID as a partition key would quickly exceed the 10-GB limit per partition.</span></span> <span data-ttu-id="8cd88-201">在這種情況下，訊息識別碼是更好的分割區索引鍵。</span><span class="sxs-lookup"><span data-stu-id="8cd88-201">Message ID is a better partition key in that case.</span></span> <span data-ttu-id="8cd88-202">通常，您仍會在索引編製和查詢文件中包含裝置識別碼。</span><span class="sxs-lookup"><span data-stu-id="8cd88-202">Typically you would still include device ID in the document for indexing and querying.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="8cd88-203">安全性考量</span><span class="sxs-lookup"><span data-stu-id="8cd88-203">Security considerations</span></span>

### <a name="trustworthy-and-secure-communication"></a><span data-ttu-id="8cd88-204">可信任和安全的通訊</span><span class="sxs-lookup"><span data-stu-id="8cd88-204">Trustworthy and secure communication</span></span>

<span data-ttu-id="8cd88-205">從裝置接收和傳送的所有資訊都必須是可信任的。</span><span class="sxs-lookup"><span data-stu-id="8cd88-205">All information received from and sent to a device must be trustworthy.</span></span> <span data-ttu-id="8cd88-206">除非裝置可支援下列密碼編譯功能，否則應限制為區域網路，並且所有網際網路通訊都應當透過現場閘道：</span><span class="sxs-lookup"><span data-stu-id="8cd88-206">Unless a device can support the following cryptographic capabilities, it should be constrained to local networks and all internetwork communication should go through a field gateway:</span></span>

- <span data-ttu-id="8cd88-207">資料加密採用可證明安全、公開分析且廣泛實作的對稱金鑰加密演算法。</span><span class="sxs-lookup"><span data-stu-id="8cd88-207">Data encryption with a provably secure, publicly analyzed, and broadly implemented symmetric-key encryption algorithm.</span></span>
- <span data-ttu-id="8cd88-208">數位簽章採用可證明安全、公開分析且廣泛實作的對稱金鑰簽章演算法。</span><span class="sxs-lookup"><span data-stu-id="8cd88-208">Digital signature with a provably secure, publicly analyzed, and broadly implemented symmetric-key signature algorithm.</span></span>
- <span data-ttu-id="8cd88-209">支援 TCP 的 TLS 1.2 或其他以資料流為基礎的通訊路徑，或 DTLS 1.2 以資料包為基礎的通訊路徑。</span><span class="sxs-lookup"><span data-stu-id="8cd88-209">Support for either TLS 1.2 for TCP or other stream-based communication paths or DTLS 1.2 for datagram-based communication paths.</span></span> <span data-ttu-id="8cd88-210">X.509 憑證處理的支援是選擇性的，可以替換為 TLS 的 的計算效率更高且網路效率預先共用金鑰模式，其可透過支援 AES 和 SHA-2 演算法來實作。</span><span class="sxs-lookup"><span data-stu-id="8cd88-210">Support of X.509 certificate handling is optional and can be replaced by the more compute-efficient and wire-efficient pre-shared key mode for TLS, which can be implemented with support for the AES and SHA-2 algorithms.</span></span>
- <span data-ttu-id="8cd88-211">可更新的金鑰存放區和每一裝置索引鍵。</span><span class="sxs-lookup"><span data-stu-id="8cd88-211">Updateable key-store and per-device keys.</span></span> <span data-ttu-id="8cd88-212">每個裝置必須有唯一的金鑰資料或權杖，以對系統識別該裝置。</span><span class="sxs-lookup"><span data-stu-id="8cd88-212">Each device must have unique key material or tokens that identify it toward the system.</span></span> <span data-ttu-id="8cd88-213">裝置應將金鑰安全地儲存在裝置 (例如，使用安全金鑰存放區) 上。</span><span class="sxs-lookup"><span data-stu-id="8cd88-213">The devices should store the key securely on the device (for example, using a secure key-store).</span></span> <span data-ttu-id="8cd88-214">裝置應能夠定期更新金鑰或權杖，或在緊急情況 (例如系統漏洞) 下進行反應。</span><span class="sxs-lookup"><span data-stu-id="8cd88-214">The device should be able to update the keys or tokens periodically, or reactively in emergency situations such as a system breach.</span></span>
- <span data-ttu-id="8cd88-215">必須允許裝置上的韌體和應用程式軟體進行更新，以便修復發現的安全性漏洞。</span><span class="sxs-lookup"><span data-stu-id="8cd88-215">The firmware and application software on the device must allow for updates to enable the repair of discovered security vulnerabilities.</span></span>

<span data-ttu-id="8cd88-216">不過，許多裝置的限制太多而無法支援這些需求。</span><span class="sxs-lookup"><span data-stu-id="8cd88-216">However, many devices are too constrained to support these requirements.</span></span> <span data-ttu-id="8cd88-217">在此情況下，您應該使用現場閘道。</span><span class="sxs-lookup"><span data-stu-id="8cd88-217">In that case, a field gateway should be used.</span></span> <span data-ttu-id="8cd88-218">裝置透過區域網路安全地連線到現場閘道上，並且閘道可啟用與雲端的安全通訊。</span><span class="sxs-lookup"><span data-stu-id="8cd88-218">Devices connect securely to the field gateway through a local area network, and the gateway enables secure communication to the cloud.</span></span>

### <a name="physical-tamper-proofing"></a><span data-ttu-id="8cd88-219">實體竄改校訂</span><span class="sxs-lookup"><span data-stu-id="8cd88-219">Physical tamper proofing</span></span>

<span data-ttu-id="8cd88-220">強烈建議裝置設計納入防止實體操作嘗試的功能，以協助確保安全性完整性和整體系統的可信度。</span><span class="sxs-lookup"><span data-stu-id="8cd88-220">It is strongly recommended that device design incorporates features that defend against physical manipulation attempts, to help ensure the security integrity and trustworthiness of the overall system.</span></span>

<span data-ttu-id="8cd88-221">例如︰</span><span class="sxs-lookup"><span data-stu-id="8cd88-221">For example:</span></span>

- <span data-ttu-id="8cd88-222">選擇提供安全的儲存體和使用密碼編譯金鑰內容的微控制器/微處理器或輔助硬體，例如信賴平台模組 (TPM) 整合。</span><span class="sxs-lookup"><span data-stu-id="8cd88-222">Choose microcontrollers/microprocessors or auxiliary hardware that provide secure storage and use of cryptographic key material, such as trusted platform module (TPM) integration.</span></span>
- <span data-ttu-id="8cd88-223">保護開機載入器和軟體載入的安全，錨定在 TPM 中。</span><span class="sxs-lookup"><span data-stu-id="8cd88-223">Secure boot loader and secure software loading, anchored in the TPM.</span></span>
- <span data-ttu-id="8cd88-224">使用感應器偵測入侵嘗試，並嘗試透過裝置的警示和可能的「數位自我損毀」來操縱裝置環境。</span><span class="sxs-lookup"><span data-stu-id="8cd88-224">Use sensors to detect intrusion attempts and attempts to manipulate the device environment with alerting and potentially “digital self-destruction” of the device.</span></span>

<span data-ttu-id="8cd88-225">如需額外的安全性考量，請參閱[物聯網 (IoT) 安全性架構](/azure/iot-fundamentals/iot-security-architecture)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-225">For additional security considerations, see [Internet of Things (IoT) security architecture](/azure/iot-fundamentals/iot-security-architecture).</span></span>

### <a name="monitoring-and-logging"></a><span data-ttu-id="8cd88-226">監視和記錄</span><span class="sxs-lookup"><span data-stu-id="8cd88-226">Monitoring and logging</span></span>

<span data-ttu-id="8cd88-227">記錄和監視系統是用來判斷解決方案是否正常運作，以及協助疑難排解問題。</span><span class="sxs-lookup"><span data-stu-id="8cd88-227">Logging and monitoring systems are used to determine whether the solution is functioning and to help troubleshoot problems.</span></span> <span data-ttu-id="8cd88-228">監視和記錄系統可協助回答下列操作問題：</span><span class="sxs-lookup"><span data-stu-id="8cd88-228">Monitoring and logging systems help answer the following operational questions:</span></span>

- <span data-ttu-id="8cd88-229">裝置或系統是否處於錯誤狀況？</span><span class="sxs-lookup"><span data-stu-id="8cd88-229">Are devices or systems in an error condition?</span></span>
- <span data-ttu-id="8cd88-230">是否已正確設定系統或裝置？</span><span class="sxs-lookup"><span data-stu-id="8cd88-230">Are devices or systems correctly configured?</span></span>
- <span data-ttu-id="8cd88-231">裝置或系統是否產生精確的資料？</span><span class="sxs-lookup"><span data-stu-id="8cd88-231">Are devices or systems generating accurate data?</span></span>
- <span data-ttu-id="8cd88-232">系統是否滿足業務和最終客戶的期望？</span><span class="sxs-lookup"><span data-stu-id="8cd88-232">Are systems meeting the expectations of both the business and end customers?</span></span>

<span data-ttu-id="8cd88-233">記錄和監視工具通常包含下列四個元件：</span><span class="sxs-lookup"><span data-stu-id="8cd88-233">Logging and monitoring tools are typically comprised of the following four components:</span></span>

- <span data-ttu-id="8cd88-234">系統效能與時間軸視覺效果工具，用來監視系統以及基本疑難排解。</span><span class="sxs-lookup"><span data-stu-id="8cd88-234">System performance and timeline visualization tools to monitor the system and for basic troubleshooting.</span></span>
- <span data-ttu-id="8cd88-235">緩衝資料擷取，以緩衝記錄資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-235">Buffered data ingestion, to buffer log data.</span></span>
- <span data-ttu-id="8cd88-236">持續性儲存區以儲存記錄資料。</span><span class="sxs-lookup"><span data-stu-id="8cd88-236">Persistence store to store log data.</span></span>
- <span data-ttu-id="8cd88-237">搜尋和查詢功能，檢視記錄資料以用於詳細疑難排解。</span><span class="sxs-lookup"><span data-stu-id="8cd88-237">Search and query capabilities, to view log data for use in detailed troubleshooting.</span></span>

<span data-ttu-id="8cd88-238">監視系統會提供 IoT 解決方案的健康情況、安全性、穩定性和效能的深入解析。</span><span class="sxs-lookup"><span data-stu-id="8cd88-238">Monitoring systems provide insights into the health, security, and stability, and performance of an IoT solution.</span></span> <span data-ttu-id="8cd88-239">這些系統也可以提供更詳細的檢視，記錄元件設定變更、提供可以呈現潛在安全性漏洞的擷取記錄資料、增強事件管理程序，並協助系統擁有者針對問題進行疑難排解。</span><span class="sxs-lookup"><span data-stu-id="8cd88-239">These systems can also provide a more detailed view, recording component configuration changes and providing extracted logging data that can surface potential security vulnerabilities, enhance the incident management process, and help the owner of the system troubleshoot problems.</span></span> <span data-ttu-id="8cd88-240">完整的監視解決方案包含特定子系統或跨多個子系統彙總查詢資訊的能力。</span><span class="sxs-lookup"><span data-stu-id="8cd88-240">Comprehensive monitoring solutions include the ability to query information for specific subsystems or aggregating across multiple subsystems.</span></span>

<span data-ttu-id="8cd88-241">監視系統開發應首先定義健全的作業、法規遵循和稽核要求。</span><span class="sxs-lookup"><span data-stu-id="8cd88-241">Monitoring system development should begin by defining healthy operation, regulatory compliance, and audit requirements.</span></span> <span data-ttu-id="8cd88-242">收集的度量資訊可能包括：</span><span class="sxs-lookup"><span data-stu-id="8cd88-242">Metrics collected may include:</span></span>

- <span data-ttu-id="8cd88-243">實體裝置、邊緣裝置和基礎結構元件報表組態變更。</span><span class="sxs-lookup"><span data-stu-id="8cd88-243">Physical devices, edge devices, and infrastructure components reporting configuration changes.</span></span>
- <span data-ttu-id="8cd88-244">應用程式報表組態變更、安全性稽核記錄檔、要求率、回應時間、錯誤率和記憶體回收統計資料 (managed 語言)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-244">Applications reporting configuration changes, security audit logs, request rates, response times, error rates, and garbage collection statistics for managed languages.</span></span>
- <span data-ttu-id="8cd88-245">資料庫、持續性儲存區、快取報告查詢以及寫入效能、結構描述變更、安全性稽核記錄檔、鎖定或鎖死、索引效能、CPU、記憶體和磁碟使用量。</span><span class="sxs-lookup"><span data-stu-id="8cd88-245">Databases, persistence stores, and caches reporting query and write performance, schema changes, security audit log, locks or deadlocks, index performance, CPU, memory, and disk usage.</span></span>
- <span data-ttu-id="8cd88-246">受管理的服務 (IaaS、PaaS、SaaS 及 FaaS) 報告影響相依系統健康情況和效能的健康情況度量與組態變更。</span><span class="sxs-lookup"><span data-stu-id="8cd88-246">Managed services (IaaS, PaaS, SaaS, and FaaS) reporting health metrics and configuration changes that impact dependent system health and performance.</span></span>

<span data-ttu-id="8cd88-247">視覺效果的監視度量警示操作員系統不穩定並協助事件回應。</span><span class="sxs-lookup"><span data-stu-id="8cd88-247">Visualization of monitoring metrics alert operators to system instabilities and facilitate incident response.</span></span>

### <a name="tracing-telemetry"></a><span data-ttu-id="8cd88-248">追蹤遙測</span><span class="sxs-lookup"><span data-stu-id="8cd88-248">Tracing telemetry</span></span>

<span data-ttu-id="8cd88-249">追蹤遙測可讓操作員追蹤從建立到系統的遙測旅程。</span><span class="sxs-lookup"><span data-stu-id="8cd88-249">Tracing telemetry allows an operator to follow the journey of a piece of telemetry from creation through the system.</span></span> <span data-ttu-id="8cd88-250">追蹤對於偵錯和疑難排解很重要。</span><span class="sxs-lookup"><span data-stu-id="8cd88-250">Tracing is important for debugging and troubleshooting.</span></span> <span data-ttu-id="8cd88-251">對於使用 Azure IoT 中樞的 IoT 解決方案和 [IoT 中樞裝置 SDK](/azure/iot-hub/iot-hub-devguide-sdks)，追蹤資料包可以產生為雲端到裝置訊息並包含在遙測資料流中。</span><span class="sxs-lookup"><span data-stu-id="8cd88-251">For IoT solutions that use Azure IoT Hub and the [IoT Hub Device SDKs](/azure/iot-hub/iot-hub-devguide-sdks), tracing datagrams can be originated as Cloud-to-Device messages and included in the telemetry stream.</span></span>

### <a name="logging"></a><span data-ttu-id="8cd88-252">記錄</span><span class="sxs-lookup"><span data-stu-id="8cd88-252">Logging</span></span>

<span data-ttu-id="8cd88-253">記錄系統是了解解決方案已執行哪些動作或活動、已發生失敗以及可提供協助修復這些失敗不可或缺的部分。</span><span class="sxs-lookup"><span data-stu-id="8cd88-253">Logging systems are integral in understanding what actions or activities a solution has performed, failures that have occurred, and can provide help in fixing those failures.</span></span> <span data-ttu-id="8cd88-254">您可以分析記錄檔以協助了解和解決錯誤狀況、加強效能特性，並確保符合規範規則與規定。</span><span class="sxs-lookup"><span data-stu-id="8cd88-254">Logs can be analyzed to help understand and remedy error conditions, enhance performance characteristics, and ensure compliance with governing rule and regulations.</span></span>

<span data-ttu-id="8cd88-255">雖然純文字記錄對前期開發成本的影響較小，但對於剖析/讀取機器來說更具挑戰性。</span><span class="sxs-lookup"><span data-stu-id="8cd88-255">Though plain-text logging is lower impact on upfront development costs, it is more challenging for a machine to parse/read.</span></span> <span data-ttu-id="8cd88-256">我們建議使用結構化記錄，因為收集的資訊是電腦可剖析和人類可讀取的資訊。</span><span class="sxs-lookup"><span data-stu-id="8cd88-256">We recommend structured logging be used, as collected information is both machine parsable and human readable.</span></span> <span data-ttu-id="8cd88-257">結構化記錄會將環境的內容和中繼資料加入至記錄資訊。</span><span class="sxs-lookup"><span data-stu-id="8cd88-257">Structured logging adds situational context and metadata to the log information.</span></span> <span data-ttu-id="8cd88-258">在結構化日誌記錄中，屬性是格式化為一對索引鍵/值的第一類公民，或具有固定的結構描述，以增強搜尋和查詢功能。</span><span class="sxs-lookup"><span data-stu-id="8cd88-258">In structured logging, properties are first class citizens formatted as key/value pairs, or with a fixed schema, to enhance search and query capabilities.</span></span>

## <a name="next-steps"></a><span data-ttu-id="8cd88-259">後續步驟</span><span class="sxs-lookup"><span data-stu-id="8cd88-259">Next steps</span></span>

- <span data-ttu-id="8cd88-260">如需建議的架構和實作選擇的詳細討論，請參閱 [Microsoft Azure IoT 參考架構](http://aka.ms/iotrefarchitecture) (PDF)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-260">For a more detailed discussion of the recommended architecture and implementation choices, see [Microsoft Azure IoT Reference Architecture](http://aka.ms/iotrefarchitecture) (PDF).</span></span>

- <span data-ttu-id="8cd88-261">如需各種 Azure IoT 服務的詳細文件，請參閱 [Azure IoT 基礎](/azure/iot-fundamentals/)。</span><span class="sxs-lookup"><span data-stu-id="8cd88-261">For detailed documentation of the various Azure IoT services, see [Azure IoT Fundamentals](/azure/iot-fundamentals/).</span></span>

- <span data-ttu-id="8cd88-262">範例 IoT 實作可以在 [GitHub](https://github.com/mspnp/iot-guidance) 上取得。</span><span class="sxs-lookup"><span data-stu-id="8cd88-262">A sample IoT implementation is available on [GitHub](https://github.com/mspnp/iot-guidance).</span></span>
