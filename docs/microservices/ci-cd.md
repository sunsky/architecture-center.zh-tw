---
title: 微服務的 CI/CD
description: 微服務的持續整合與持續傳遞。
author: MikeWasson
ms.date: 03/27/2019
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: microservices
ms.openlocfilehash: f7f3f3d48087db51c40f134e3e4cf11ec58501bb
ms.sourcegitcommit: d58e6b2b891c9c99e951c59f15fce71addcb96b1
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/12/2019
ms.locfileid: "59533085"
---
# <a name="cicd-for-microservices-architectures"></a>微服務架構的 CI/CD

更快速的發行週期是其中一個微服務架構的主要優點。 但沒有很好的 CI/CD 程序，就無法達到微服務所承諾的靈活度。 本文章會說明所面臨的挑戰，並建議問題的一些方法。

## <a name="what-is-cicd"></a>什麼是 CI/CD？

當我們談論 CI/CD 時，我們真正的意思了數個相關的處理程序：持續整合、持續傳遞和持續部署。

- **持續整合**。 程式碼變更經常會併入主要分支。 自動化建置和測試程序可讓您確保主要分支中的程式碼一定是實際執行品質。

- **持續傳遞**。 變更任何程式碼傳遞 CI 程序會自動發佈到類似生產的環境中。 部署至即時生產環境可能需要手動核准，除此之外皆是自動化作業。 這麼做的目的是，您的程式碼應該總是「準備好」部署到生產環境。

- **連續部署**。 程式碼變更前的兩個步驟會自動部署該階段*運行*。

針對微服務架構，以下是強固 CI/CD 程序的一些目標：

- 每個小組都可建置並部署獨立擁有的服務，而不會影響或干擾其他小組。

- 將新版服務部署到生產環境之前，可先部署到開發/測試/QA 環境來進行驗證。 在每個階段上強制執行品質閘門 (Quality Gate)。

- 服務的新版本可以與舊版並存部署。

- 有足夠的存取控制原則。

- 適用於容器化工作負載，您可以信任的容器映像，部署到生產環境。

## <a name="why-a-robust-cicd-pipeline-matters"></a>為何很重要的強固的 CI/CD 管線

在傳統的單體式應用程式中，沒有一個建置管線，其輸出是可執行檔的應用程式。 所有開發工作都會饋送到此管線中。 如果發現高優先順序的錯誤 (bug)，則必須整合、測試及發行修正程式，這可能會延遲新功能的發行。 您可以藉由擁有構造良好的模組，並使用程式碼變更的影響降到最低的功能分支來緩和這些問題。 但隨著應用程式日益複雜，並新增了更多功能，單體的發行程序就變得更加脆弱並可能中斷。

根據微服務的原理，絕不會有每個小組都必須排隊的冗長發行序列。 建立服務 "A" 的小組可以隨時發行更新，而不需等待服務 "B" 的變更來進行合併、測試和部署。

![CI/CD 整合型的圖表](./images/cicd-monolith.png)

若要達到高發行速度，您的發行管線必須自動化且高度可靠，風險降至最低。 如果您發行至生產環境的每日或一天多次，迴歸或服務中斷必須是非常罕見。 同時，如果部署了錯誤的更新，您必須有可靠的方法能快速復原或向前復原至舊版的服務。

## <a name="challenges"></a>挑戰

- **許多小型獨立的程式碼基底**。 每個小組需利用自己的建置管線，負責建立自己的服務。 在某些組織中，小組可以使用不同的程式碼存放庫。 了解如何建置系統會散佈到各小組，而在組織中沒有人知道如何部署整個應用程式的情況可能會導致個別的存放庫。 例如，如果您需要快速部署到新的叢集，災害復原案例會發生什麼情況？

    **降低風險**：具有統一且自動化的管線，以建置及部署服務，因此這項知識不會 「 隱藏 」 內每個小組。

- **多個語言和架構**。 如果每個小組都使用自己的各項技術，則可能很難建立適用於整個組織的單一建置程序。 建置程序必須有足夠的彈性，每個小組才能針對其選擇的語言或架構進行調整。

    **降低風險**：將容器化每個服務的建置程序。 如此一來，建置系統只需要能夠執行容器。

- **整合及負載測試**。 如果小組依照自己的步調發行更新，則要設計強固的端對端測試可能具有挑戰性，特別是在服務相依於其他服務時。 此外，執行完整生產叢集可能很昂貴，因此不太可能每個小組將會在生產環境的縮放比例，純粹作為測試執行它自己的完整叢集。

- **發行管理**。 每個小組應該能夠將更新部署到生產環境。 但這不表示每個小組成員都有權限這麼做。 不過，擁有集中的發行管理員角色可能會降低部署的速度。

    **Migitation**:因此您的 CI/CD 程序愈加自動化和可靠，中央授權的需求就愈低。 儘管如此，您可能使用不同的原則來發行主要功能更新和次要錯誤修正。 分散管理並不表示零治理。

- **服務更新**。 當您將服務更新為新版本時，其不得中斷與其相依的其他服務。

    **降低風險**：使用部署技術，例如藍綠色或淡黃色版本的非中斷變更。 重大 API 變更，部署新的版本與舊版並存。 如此一來，使用先前的 API 的服務可以更新並測試新的 API。 請參閱[更新服務](#updating-services)底下。

## <a name="monorepo-vs-multi-repo"></a>Monorepo vs 多存放庫

建立 CI/CD 工作流程之前，您必須知道如何結構化和管理程式碼基底。

- 小組是使用不同的存放庫或使用 monorepo (單一存放庫)？
- 您的分支策略是什麼？
- 誰可以將程式碼推送至生產環境？ 有版本管理員角色嗎？

雖然 monorepo 方法較受青睞，但這兩者都有優點和缺點。

| &nbsp; | Monorepo | 多個存放庫 |
|--------|----------|----------------|
| **優點** | 程式碼共用<br/>可更輕鬆地將程式碼及工具標準化<br/>可更輕鬆地重構程式碼<br/>可搜尋性 - 程式碼的單一檢視<br/> | 每個小組有明確擁有權<br/>可能可減少合併衝突<br/>有助於強制分離微服務 |
| **挑戰** | 共用程式碼的變更可能會影響多個微服務<br/>很可能會有合併衝突<br/>工具必須擴充為大型程式碼基底<br/>存取控制<br/>更複雜的部署程序 | 難以共用程式碼<br/>難以強制執行編碼標準<br/>相依性管理<br/>擴散的程式碼基底、不佳的探索能力<br/>缺少共用的基礎結構

## <a name="updating-services"></a>更新服務

有各種策略可用來更新已在生產環境中的服務。 我們在此討論三個常見的選項：輪流更新、藍綠色部署和 Canary 版本。

### <a name="rolling-updates"></a>輪流更新

在輪流更新中，您會部署新的服務執行個體，而新的執行個體會立刻開始接收要求。 隨著新執行個體的出現，系統會移除先前的執行個體。

**範例。** 在 Kubernetes 中，輪流更新，會是預設行為，當您更新部署的 pod 規格時。 部署控制器會為已更新的 pod 建立新的 ReplicaSet。 然後它會相應增加新的 ReplicaSet，同時相應減少舊的 ReplicaSet，以維持所需的複本計數。 在新的 pod 備妥之前，舊的 pod 不會遭到刪除。 所以您可以回復更新如有需要 Kubernetes 會保存歷程記錄的更新。

輪流更新的其中一項挑戰就是在更新過程中，新舊版本會混合執行及接收流量。 在這段期間，所有要求會路由傳送至任一個版本。

重大 API 變更，最好是支援並存，這兩個版本，直到前一版的所有用戶端會更新。 請參閱[API 版本設定](./design/api-design.md#api-versioning)。

### <a name="blue-green-deployment"></a>藍綠部署

在藍綠色部署中，您可以一起部署新版本與前一個版本。 在您驗證新版本之後，立刻將所有流量從前一個版本切換到新版本。 切換之後，您可監視應用程式是否有任何問題。 如果發生錯誤，您可以換回舊版本。 假設沒有任何問題，您可以刪除舊版本。

使用更傳統的單體式或多層式架構應用程式，藍綠部署通常是指佈建兩個相同的環境。 您會將新版本部署到預備環境，然後將用戶端流量重新導向至預備環境 &mdash; 例如，藉由交換 VIP 位址。 在微服務架構中，更新會發生在微服務層級，因此您通常會將更新部署到相同的環境，並使用服務探索機制來交換。

**範例**。 在 Kubernetes 中，您不需佈建個別的叢集來進行藍綠部署。 您反而可以利用選取器。 利用新的 pod 規格和一組不同的標籤，建立新的部署資源。 建立此部署，而不需刪除先前的部署，或修改指向它的服務。 當新的 pod 執行時，您可以更新服務的選取器，以符合新的部署。

藍綠部署的缺點之一是在更新期間，您會執行兩倍 pod，服務 （目前和下一步）。 如果 pod 需要大量 CPU 或記憶體資源，您可能需要暫時相應放大叢集，以處理資源耗用。

### <a name="canary-release"></a>Canary 版本

在 Canary 版本中，您會向少數用戶端推出更新的版本。 然後您會先監視新服務的行為，然後再向所有的用戶端推出該服務。 這可讓您以控制方式進行緩慢推出、觀察實際資料，以及在所有客戶受影響之前找出問題。

Canary 版本的管理比藍綠或輪流更新更複雜，因為您必須動態將要求路由傳送到不同的服務版本。

**範例**。 在 Kubernetes 中，您可以將服務設定為橫跨兩個複本集 (每個版本各一個) 並手動調整複本計數。 不過，此方法會因為 Kubernetes 在 pod 間進行平衡負載的方式而顯得相當粗糙。 比方說，如果您有 10 個複本的總計，您只可以轉換流量 10%的增量。 如果您使用服務網格，則可以使用服務網格路由規則，實作更精緻的 Canary 版本策略。

## <a name="next-steps"></a>後續步驟

了解特定的 CI/CD 做法適用於在 Kubernetes 上執行的微服務。

- [在 Kubernetes 上的微服務的 CI/CD](./ci-cd-kubernetes.md)