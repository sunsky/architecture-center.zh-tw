---
title: 補償交易模式
titleSuffix: Cloud Design Patterns
description: 復原由一系列步驟執行的工作，這些步驟共同定義最終一致的作業。
keywords: 設計模式
author: dragon119
ms.date: 06/23/2017
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: 5cefef36b7c763324de2e962d47509b1d1b2c968
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58242989"
---
# <a name="compensating-transaction-pattern"></a>補償交易模式

[!INCLUDE [header](../_includes/header.md)]

如果一或多個步驟失敗，請復原由一系列步驟執行的工作，這些步驟共同定義最終的一致作業。 依照最終一致性模型來執行的作業，經常可在實作複雜商業程序和工作流程的雲端裝載應用程式中發現。

## <a name="context-and-problem"></a>內容和問題

在雲端中執行的應用程式經常會修改資料。 此資料可能散佈在保存於不同地理位置的各種不同資料來源。 為了避免分散式環境中出現競爭並改善效能，應用程式不應嘗試提供強式交易一致性。 相反地，應用程式應實作最終一致性。 在此模型中，一般商業作業包含一系列個別的步驟。 執行這些步驟時，系統狀態整體看來可能會不一致，但當作業完成並執行所有步驟之後，系統應會再次變得一致。

> [資料一致性入門](https://msdn.microsoft.com/library/dn589800.aspx) \(英文\) 提供為什麼分散式交易不能縮放自如，以及最終一致性模型原則的相關資訊。

最終一致性模型的挑戰之一是如何處理失敗的步驟。 在此情況下，可能必須復原作業中所有先前步驟完成的所有工作。 不過，因為應用程式的其他並行執行個體可能已變更該資料，所以無法直接復原資料。 即使在資料未由並行執行個體變更的情況下，復原步驟也不只是還原為原始狀態。 可能必須套用各種不同的商務特有規則 (請參閱「範例」一節所述的旅遊網站)。

如果實作最終一致性的作業橫跨數個異質資料存放區，復原作業中的步驟將需要依序造訪每個資料存放區。 在每個資料存放區中執行的工作必須可靠地復原，才能防止系統留有不一致之處。

並非受到實作最終一致性的作業影響的所有資料都會保留在資料庫中。 在服務導向架構 (SOA) 環境中，作業會叫用服務中的動作並造成該服務的狀態變更。 若要復原作業，也必須復原此狀態變更。 這可能涉及再次叫用服務，以及執行另一個動作以反轉第一個動作的效果。

## <a name="solution"></a>解決方法

解決方式就是實作補償交易。 補償交易中的步驟必須將原始作業中的步驟效果復原。 因為補償交易會覆寫應用程式之其他並行執行個體所做的變更，所以這種方法可能無法以作業之初的系統狀態取代目前的狀態。 相反地，必須採用考慮到並行執行個體所完成之任何工作的智慧型程序。 此程序通常是應用程式特有，受到原始作業所執行工作的本質驅動。

常見的方法是使用工作流程來實作需要補償的最終一致性作業。 系統會隨著原始作業不斷進行，記錄每個步驟和能如何復原該步驟所執行工作的相關資訊。 如果作業在任何時間點失敗，工作流程會倒轉回到已經完成的步驟，並執行可反轉每個步驟的工作。 請注意，補償交易可能不必依照原始作業的順序反向復原，而且能平行執行一些復原步驟。

> 這種方法類似於 [Clemens Vasters 部落格](https://vasters.com/clemensv/2012/09/01/Sagas.aspx) \(英文\) 中所述的 Sagas 策略。

補償交易也是最終一致性作業，而且也可能會失敗。 系統應能夠在失敗時恢復補償交易並繼續。 因為可能需要重複失敗的步驟，所以應將補償交易中的步驟定義為等冪命令。 如需詳細資訊，請參閱 Jonathan Oliver 部落格上的[等冪模式](https://blog.jonathanoliver.com/idempotency-patterns/) \(英文\)。

在某些情況下，可能無法從失敗的步驟復原，除了手動介入，別無他法。 在這些情況下，系統應會引發警示，並儘可能提供失敗原因的詳細資訊。

## <a name="issues-and-considerations"></a>問題和考量

當您決定如何實作此模式時，請考慮下列幾點：

要判斷實作最終一致性之作業中的步驟何時失敗，可能並不容易。 步驟可能不會立即失敗，而是造成後續步驟無法執行。 可能必須實作某種形式的逾時機制。

- 補償邏輯並不容易一般化。 補償交易是應用程式特有。 全賴應用程式有足夠的資訊，才能復原失敗作業中每個步驟的效果。

您應該將補償交易中的步驟定義為等冪命令。 這可在補償交易本身失敗時，重複執行步驟。

處理原始作業中步驟的基礎結構和補償交易都必須具有復原功能。 它不得遺失補償失敗步驟所需的資訊，也必須可靠地監視補償邏輯的進度。

補償交易不一定會讓系統中的資料回到原始作業之初的狀態。 相反地，它會補償該步驟在作業失敗之前已順利完成執行的工作。

補償交易中步驟的順序不一定要和原始作業中的步驟完全相反。 例如，某個資料存放區對於不一致的情況可能會比另一個資料存放區更敏感，因此補償交易中的步驟應該先復原此存放區的變更。

在完成作業所需的每個資源放置短期逾時型鎖定，並事先取得這些資源，有助於提升整體活動成功的可能性。 應只有在取得所有資源之後，才執行工作。 所有動作都必須在鎖定到期之前完成。

請考慮使用比平常更寬鬆的重試邏輯，以將會觸發補償交易的失敗減至最少。 如果實作最終一致性的作業中有步驟失敗，請嘗試將該失敗視為暫時性例外狀況來處理，並重複執行該步驟。 只有在步驟不斷失敗或永久失敗時，才停止該作業並起始補償交易。

> 實作補償交易的多項挑戰和實作最終一致性的挑戰相同。 如需實作最終一致性的詳細資訊，請參閱[資料一致性入門](https://msdn.microsoft.com/library/dn589800.aspx) \(英文\) 中的「實作最終一致性的考量」一節。

## <a name="when-to-use-this-pattern"></a>使用此模式的時機

只針對失敗時必須復原的作業使用此模式。 設計解決方案時，請盡量避免採用複雜的補償交易。

## <a name="example"></a>範例

旅遊網站可讓客戶預訂行程。 單一行程可能包含一系列航班和旅館。 從西雅圖前往倫敦再到巴黎的客戶，建立行程時會執行下列步驟：

1. 預訂從西雅圖飛往倫敦的 F1 航班座位。
2. 預訂從倫敦飛往巴黎的 F2 航班座位。
3. 預訂從巴黎飛往西雅圖的 F3 航班座位。
4. 在倫敦的 H1 旅館訂房。
5. 在巴黎的 H2 旅館訂房。

雖然每個步驟都是個別的動作，但這些步驟會構成最終一致性作業。 因此，系統不但會執行這些步驟，也必須記錄復原每個步驟所需的反向作業，以在客戶決定取消行程時執行。 執行計數器作業所需的步驟，能以補償交易形式執行。

請注意，可能不會使用和原始步驟完全相反的順序來進行補償交易中的步驟，而且補償交易中每個步驟的邏輯都必須考慮到任何商務特有規則。 例如，取消航班訂位可能無法全額退還客戶已支付的任何款項。 下圖說明產生補償交易以將長時間執行以預訂旅遊行程的交易復原。

![產生補償交易以將長時間執行以預訂旅遊行程的交易復原](./_images/compensating-transaction-diagram.png)

> [!NOTE]
> 視您如何為每個步驟設計補償邏輯而定，可能可以平行執行補償交易中的步驟。

在許多商務解決方案中，單一步驟失敗時，不一定需要使用補償交易來復原系統。 例如，&mdash;在旅遊網站案例中的 F1、F2 及 F3 航班訂位之後&mdash;如果客戶無法在 H1 旅館訂房，最好能為客戶提供同一城市但不同旅館的房間，而不是取消航班訂位。 客戶仍可以決定取消 (此時，補償交易會執行並復原對 F1、F2 及 F3 航班的訂位)，但此決策應由客戶決定，而不是系統。

## <a name="related-patterns-and-guidance"></a>相關的模式和指導方針

實作此模式時，下列模式和指導方針可能也相關：

- [資料一致性入門](https://msdn.microsoft.com/library/dn589800.aspx)。 補償交易模式通常用來復原實作最終一致性模型的作業。 此入門提供最終一致性優缺點的相關資訊。

- [Scheduler-Agent-Supervisor 模式](./scheduler-agent-supervisor.md)。 描述如何實作使用分散式服務與資源執行商務作業且具復原功能的系統。 有時候，可能有必要使用補償交易來復原由作業所執行的工作。

- [重試模式](./retry.md)。 執行補償交易可能所費不貲，而遵循重試模式實作重試失敗作業的有效原則，可以將此一必要降至最低。
