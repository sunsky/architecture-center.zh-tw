---
title: 建構恢復功能和可用性的 Azure 應用的程式
description: 在 Azure 的應用程式中建置復原功能和可用性
author: MikeWasson
ms.date: 04/10/2019
ms.topic: article
ms.service: architecture-center
ms.subservice: cloud-design-principles
ms.openlocfilehash: ee4bb5b4a85e48fe0ff017297c31823c93a48f04
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59646520"
---
# <a name="architecting-azure-applications-for-resiliency-and-availability"></a>建構恢復功能和可用性的 Azure 應用的程式

您已針對您的應用程式開發的需求之後下, 一個步驟是要內建的復原和可用性。 這些特質無法加入結尾&mdash;您必須將它們設計架構。

## <a name="conduct-a-failure-mode-analysis"></a>執行失敗模式分析

*失敗模式分析*(FMA) 系統中內建復原功能，透過識別可能的失敗點，並定義應用程式如何回應這些失敗。 FMA 應該是架構和設計階段中的一部分，因此從一開始在系統內建失敗復原。 FMA 的目標是：

- 決定應用程式可能遭遇哪些失敗類型，以及如何應用程式會偵測這些失敗。
- 擷取每種失敗的潛在影響，並決定應用程式的回應方式。
- 規劃記錄和監視失敗，並找出復原策略。

以下是一些範例的失敗模式和特定的失敗點的偵測策略&mdash;呼叫外部 web 服務：

| 失敗模式           | 偵測策略           |
|------------------------|------------------------------|
| 服務停用 | HTTP 5xx                     |
| 節流             | HTTP 429 (太多要求) |
| Authentication         | HTTP 401 (未經授權)      |
| 回應變慢          | 要求逾時            |

如需有關 Azure 中的特定建議事項的 FMA 程序，請參閱[失敗模式分析](../resiliency/failure-mode-analysis.md)。

## <a name="plan-for-redundancy"></a>如需備援的計劃

失敗會在範圍內的影響而有所不同。 有些硬體失敗，例如失敗的磁碟，會影響單一主機電腦。 失敗的網路交換器則可能影響整個伺服器機架。 較不常見的失敗，例如失去電源，會中斷整個資料中心。 很少，整個區域變得無法使用。

備援是一種方式讓應用程式具有恢復功能。 備援層級取決於您的業務需求&mdash;並非每個應用程式需要備援，跨區域，以防範區域性中斷。 一般情況下，沒有更高的備援性和可靠性與更高的成本和複雜性之間權衡取捨。

### <a name="review-azure-redundancy-features"></a>檢閱 Azure 備援功能

Azure 會有多重備援功能失敗，整個區域個別虛擬機器 (VM) 的每個層級。

- **單一 Vm 也**有[的執行時間服務等級協定 (SLA)](https://azure.microsoft.com/support/legal/sla/virtual-machines) Azure 所提供。 （VM 必須使用進階儲存體的所有作業系統磁碟和資料磁碟）。雖然您可以透過執行兩個以上的 VM 來獲得更高的 SLA，但對於某些工作負載來說，單一 VM 或許就已足夠。 至於生產工作負載，我們建議使用兩個以上的 VM 來作為備援。
- **可用性設定組**防範當地語系化的硬體失敗，例如磁碟或網路交換器失敗。 在可用性設定組中的 Vm 會分散到最多三個*容錯網域*。 容錯網域定義一組共用通用電源和網路交換器的 Vm。 如果硬體故障會影響一個容錯網域，網路流量會路由到其他容錯網域中的 Vm。 如需有關可用性設定組的詳細資訊，請參閱[管理 Azure 中 Windows 虛擬機器的可用性](/azure/virtual-machines/windows/manage-availability)。
- **可用性區域**是 Azure 區域內實際分開的區域。 每個可用性區域各有不同的電力來源、網路和冷卻系統。 將 Vm 部署在可用性區域可協助保護應用程式防範全資料中心失敗。 並非所有區域都支援可用性區域。 如需支援的區域和服務清單，請參閱[什麼是 Azure 中的可用性區域？](/azure/availability-zones/az-overview)。

    如果您打算使用可用性區域，您的部署中，先驗證您的應用程式架構和程式碼基底支援此設定。 如果您部署商業軟體，請洽詢軟體廠商，並部署到生產環境之前適當地測試。 應用程式必須維護狀態，並已設定的區域內中斷期間避免資料遺失。 應用程式必須支援在沒有任何硬式編碼的基礎結構元件的彈性和分散式基礎結構中執行。
- **Azure Site Recovery**複寫 Azure 虛擬機器到另一個 Azure 區域 (BC) 的業務續航力和災害復原 (DR) 需求。 您可以進行定期 DR 切入，以確保您符合合規性需求。 VM 會複寫使用指定的設定到選取的區域中，因此您可以復原您的應用程式發生來源區域中的中斷事件時。 如需詳細資訊，請參閱 <<c0> [ 設定為 Azure 虛擬機器的災害復原至次要 Azure 區域](/azure/site-recovery/azure-to-azure-quickstart/)。

    在測試期間，確認*復原時間目標*(RTO) 和*復原點目標*(RPO) 符合您的需求。 RTO 是應用程式之後的事件，即無法使用的時間上限，RPO 的最大資料遺失時間長度在災害期間。
- **配對的區域**會建立使用 Azure 流量管理員將網際網路流量分散到不同的區域，保護應用程式防範區域性中斷。 每個 Azure 區域都會與另一個區域配對。 在一起，這些區域會構成[*區域配對*](/azure/best-practices-availability-paired-regions)。 為了符合資料常駐地之稅務和執法強制管轄，區域性配對會位於相同的地理位置 （巴西南部除外）。

    若要改善應用程式恢復功能，Azure 會將平台更新 （計劃性維護） 序列化跨每個區域配對，因此只有一個配對的區域會更新一次。
- 當您設計的多區域應用程式時，請考慮跨區域的網路延遲會高於單一區域內的帳戶。 比方說，如果您要複寫的資料庫，啟用容錯移轉，使用單一區域內的同步資料複寫，但非同步資料複寫跨區域。

下表比較跨數個復原策略的冗餘因素：

| &nbsp; | 可用性設定組 | 可用性區域 | Azure Site Recovery/配對的區域 |
|--------|------------------|-------------------|-----------------------------------|
| 失敗原因 | 機架                  | 資料中心               | 區域                               |
| 要求路由  | Azure Load Balancer   | 跨區域負載平衡器 | Azure 流量管理員                |
| 網路延遲  | 非常低              | 低                      | 中到高                          |
| 虛擬網路  | Azure 虛擬網路 | Azure 虛擬網路          | 跨區域虛擬網路對等互連 |

### <a name="complete-azure-redundancy-tasks"></a>完整的 Azure 複本建立工作

備援的需求，使用下列工作：

- **部署多個服務執行個體。** 如果您的應用程式相依於服務的單一執行個體，它會建立單一失敗點。 佈建多個執行個體，可改善復原能力和延展性。 對於 [Azure App Service](/azure/app-service/app-service-value-prop-what-is/)，請選擇可提供多個執行個體的 [App Service 方案](/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview/)。 針對[Azure 虛擬機器](/azure/virtual-machines/virtual-machines-windows-about/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)，請確定您的架構有多個 VM，並中包含的每個 VM[可用性設定組](/azure/virtual-machines/virtual-machines-windows-manage-availability/)。

- **使用 Azure Site Recovery 複寫 VM。** 使用 Azure Vm 的複寫時[Site Recovery](/azure/site-recovery/)，所有 VM 磁碟持續會以非同步方式都複寫到目標區域。 建立復原點會每隔幾分鐘，讓大約幾分鐘的 RPO。

- **請考慮在多個區域中部署您的應用程式。** 如果您的應用程式部署到單一區域中，而且區域變成無法使用，也會無法使用您的應用程式。 您應用程式的 SLA 條款可能無法接受這種情況。 若是如此，請考慮在多個區域中部署您的應用程式及其服務。 多區域部署可以使用*主動-主動*或是*主動-被動*組態。 主動-主動組態會將要求分散到多個使用中的區域。 主動-被動組態在次要區域中，保留熱的執行個體，但不會傳送流量那里除非主要區域失敗。 多區域部署中，我們建議您部署至配對的區域，上面所述。 如需詳細資訊，請參閱[商務持續性和災害復原 (BCDR)：Azure 配對的區域](/azure/best-practices-availability-paired-regions)。

- **使用 Azure 流量管理員將應用程式的流量傳送到不同的區域。** [Azure 流量管理員](/azure/traffic-manager/traffic-manager-overview/)執行 DNS 層級的 負載平衡，並將流量路由至不同的區域，視[流量路由](/azure/traffic-manager/traffic-manager-routing-methods/)方法和您的應用程式端點的健全狀況。 不使用流量管理員，您受限於單一區域部署，它會限制規模、 會增加延遲某些使用者，並會導致應用程式的停機時間，在全區域服務中斷的情況下。

- **Azure 應用程式閘道設定為使用多個執行個體。** 根據您應用程式的需求，[Azure 應用程式閘道](/azure/application-gateway/application-gateway-introduction/)可能更適合用於將要求分配至您應用程式的服務。 不過，單一執行個體的應用程式閘道服務不保證 sla，因此很可能您的應用程式可能會失敗，如果應用程式閘道執行個體失敗。 佈建一個以上中型或大型執行個體，以確保可用性的服務條款[應用程式閘道的 SLA](https://azure.microsoft.com/support/legal/sla/application-gateway/)。

## <a name="design-for-scalability"></a>延展性設計

*延展性*是系統能夠處理增加的負載，而且其中一個[軟體品質要素](../guide/pillars.md)。 擴充性架構的階段期間的工作包括：

- **資料分割的工作負載。** 將程序的組件設計為離散與可分解狀態。 每個部分的大小降到最低。 這可讓元件組件，以最大化每個計算單位使用的方式散發。 它也能藉由新增特定資源的執行個體，更輕鬆地調整應用程式。 針對複雜的網域，請考慮採用[微服務架構](../guide/architecture-styles/microservices.md)。
- **調整設計。** 調整可讓應用程式，以回應多變的負載增加和減少的角色、 佇列和其他服務的執行個體數目。 不過，設計應用程式時也必須考量到這一點。 例如，應用程式和它所使用的服務必須是無狀態，以允許將要求路由傳送到任何執行個體。 具有無狀態服務，也表示，新增或移除執行個體不會造成不良影響目前的使用者。
- **規劃成長的縮放單位。** 針對每個資源，了解調整上限，並使用分區化或分解超出這些限制。 應用程式應設計為能藉由新增一或多個縮放單位來輕鬆調整。 根據定義完善的資源組決定系統縮放單位。 這可讓套用的向外延展作業更容易且較不容易出錯的整體系統某部分缺乏資源所造成的負面影響。 比方說，新增*X*前端 Vm 數目可能會需要*Y*數目更多佇列並*Z*數目來處理額外的工作負載的儲存體帳戶。 讓縮放單位可以組成*X* VM 執行個體， *Y*佇列，並*Z*儲存體帳戶。
- **避免用戶端親和性。** 可能的話，請確定應用程式不需要親和性。 要求便會路由至任何執行個體，並執行個體數目無關。 這也可避免進行儲存、擷取與維護每位使用者狀態資訊所產生的額外負荷。
- **善用平台自動調整功能。** 使用內建自動調整功能，如果可能的話，而不是自訂或協力廠商的機制。 使用排程的調整規則，可能的話，以確保資源沒有啟動延遲時間，也可以使用，但新增被動式自動調整規則，在適當，來應付非預期的變更的需求。 如需詳細資訊，請參閱 <<c0> [ 自動調整指引](../best-practices/auto-scaling.md)。  

  如果您的應用程式未設定為隨著負載增加自動相應放大，很可能您的應用程式服務，將會失敗，如果它們充斥著使用者要求。 如需詳細資訊，請參閱下列文章：

  - 一般：[延展性檢查清單](../checklist/scalability.md)
  - Azure App Service：[手動或自動調整執行個體計數](/azure/monitoring-and-diagnostics/insights-how-to-scale/)
  - 雲端服務：[如何自動調整雲端服務](/azure/cloud-services/cloud-services-how-to-scale/)
  - 虛擬機器：[自動調整與虛擬機器擴展集](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview/)

- **卸載密集 CPU/IO 工作作為背景工作。** 如果預計需要很長的時間來執行服務的要求，或可能吸收大量資源，處理卸載至個別的工作。 您可以使用背景工作來執行這些工作。 這項策略可讓服務繼續接收更多的要求，並仍能繼續回應。 如需詳細資訊，請參閱「 [背景工作指引](../best-practices/background-jobs.md)」(英文)。
- **將背景工作的工作負載。** 如果有許多的背景工作或工作需要相當長的時間或資源，請將工作分散多個計算單位。 [Competing Consumers Pattern (競爭取用者模式)](../patterns/competing-consumers.md)提供了一個可能的解決方案。
- **請考慮朝向*無共用*架構。** 此架構使用獨立且自給自足的節點具有單點的 （例如共用的服務或儲存體） 的爭用。 理論上，這類系統幾乎可以無限期地調整。 雖然以完全無共用架構的方法通常不實用，它可能會提供機會設計更好的延展性。 邁向無共用架構的好例子包括資料分割，並避免使用伺服器端工作階段狀態和用戶端親和性。
- **設計您的應用程式儲存體需求，使其落在 Azure 儲存體延展性和效能目標。** Azure 儲存體被設計來預先定義的延展性和效能目標內運作，所以設計您的應用程式使用這些目標內的儲存體。 如果您超過這些目標，您的應用程式就會發生儲存體節流。 若要避免節流，佈建額外的儲存體帳戶。 如果您遭遇儲存體帳戶限制時，佈建額外的 Azure 訂用帳戶，然後佈建額外的儲存體帳戶。 如需詳細資訊，請參閱 [Azure 儲存體延展性和效能目標](/azure/storage/storage-scalability-targets/)。
- **為您的應用程式選取適當的 VM 大小。** 測量實際的 CPU、 記憶體、 磁碟和 I/O 生產環境中的 Vm，並確認您已選取 VM 大小就已足夠。 如果未這麼做，您的應用程式可能會在 VM 接近其限制時遇到容量問題。 [Azure 中的虛擬機器大小](/azure/virtual-machines/virtual-machines-windows-sizes/?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)會詳細說明 VM 大小。

## <a name="determine-subscription-and-service-requirements"></a>判斷訂用帳戶和服務的需求

透過這些工作選擇正確的訂用帳戶和服務應用程式的功能：

- **評估需求，針對[Azure 訂用帳戶和服務限制](/azure/azure-subscription-service-limits/)。** *Azure 訂用帳戶*限制對特定資源類型，例如資源群組、 核心和儲存體帳戶的數目。 如果應用程式需求超過 Azure 訂用帳戶限制，請建立另一個 Azure 訂用帳戶並在其中佈建足夠的資源。 個別的 Azure 服務都有取用量限制&mdash;，例如儲存體、輸送量、連線數目、每秒要求數和其他計量的限制。 如果它嘗試使用超出這些限制，導致受影響的使用者的服務節流和可能停機的資源，您的應用程式將會失敗。 根據特定的服務和應用程式的需求，您通常可以避免這些限制 （例如，選擇另一個定價層） 向上或向外延展 （例如新增新的執行個體）。
- **判斷您需要多少儲存體帳戶。** Azure 可讓特定數目的每個訂用帳戶的儲存體帳戶。 如需詳細資訊，請參閱 [Azure 訂用帳戶和服務限制、配額與條件約束](/azure/azure-subscription-service-limits/#storage-limits)。
- **選取 Azure SQL Database 適用的服務層。** 如果您的應用程式使用 Azure SQL Database，請選取適當的服務層。 如果層無法處理您的應用程式資料庫交易單位 (DTU) 需求，將會節流您的資料使用。 如需選取正確服務方案的詳細資訊，請參閱 [SQL Database 選項和效能：了解每個服務層中可用的項目](/azure/sql-database/sql-database-service-tiers/)。
- **佈建 Azure Cosmos DB 中足夠的要求單位 (Ru)**。 使用 Azure Cosmos DB，您需要按小時支付所佈建的輸送量及所取用的儲存體。 所有資料庫作業的成本會標準化 Ru，為其擷取的系統資源，例如 CPU、 IOPS 和記憶體。 如需詳細資訊，請參閱 [Azure Cosmos DB 中的要求單位](/azure/cosmos-db/request-units)。

## <a name="load-balance-as-needed"></a>負載平衡所需

適當的負載平衡，可讓您符合可用性需求，以及可用性相關聯的成本降至最低。

- **使用負載平衡來分散要求。** 負載平衡時，會將您的應用程式要求至狀況良好的服務執行個體散發藉由從循環中移除狀況不良的執行個體。 如果您的服務使用 Azure App Service 或 Azure 雲端服務，它已經為您進行負載平衡。 不過，如果您的應用程式使用 Azure Vm，您需要佈建負載平衡器。 如需詳細資訊，請參閱[什麼是 Azure Load Balancer？](/azure/load-balancer/load-balancer-overview/)

  您可以使用 Azure Load Balancer：

  - 負載平衡連入網際網路流量到 Vm。 此組態稱為[*公用 Load Balancer*](/azure/load-balancer/load-balancer-overview#publicloadbalancer)。
  - 對虛擬網路內 VM 之間的流量進行負載平衡。 在混合式的案例中，您也可以從內部部署網路連線到 Load Balancer 前端。 這兩種案例使用的設定，就所謂[*內部 Load Balancer*](/azure/load-balancer/load-balancer-overview#internalloadbalancer)。
  - 連接埠流量轉送至具有輸入的網路位址轉譯 (NAT) 規則的特定 Vm 上的分項連接埠。
  - 藉由使用公用 Load Balancer，為虛擬網路內的 VM 提供[輸出連線能力](/azure/load-balancer/load-balancer-outbound-connections)。

- **使用流量管理員，在 「 Azure 流量管理員 」 等的區域之間，平衡負載。** 進行負載平衡跨區域流量需要流量管理解決方案，而 Azure 提供[Traffic Manager](https://azure.microsoft.com/services/traffic-manager/)。 也可以利用提供類似流量管理功能的第三方服務。

## <a name="implement-resiliency-strategies"></a>實作復原策略

本章節描述一些常見復原策略。 大部分的這些策略並不限於特定技術。 描述摘要說明每套方法背後的基本概念，而且包含進一步的讀取連結。

- **實作復原模式**遠端作業，在適當時。 如果您的應用程式相依於遠端服務之間的通訊，請遵循[設計模式](../patterns/category/resiliency.md)來處理暫時性失敗。

- **重試暫時性失敗。** 這些可能被因暫時遺失網路連線、 卸除的資料庫連線或逾時當服務忙碌中。 通常，可以解決暫時性失敗重試要求。

  - 對於許多 Azure 服務，用戶端軟體開發套件 (SDK) 會對呼叫端而言是透明的方式來實作自動重試。 請參閱[重試的特定服務的指引](../best-practices/retry-service-specific.md)。
  - 或實作[重試模式](../patterns/retry.md)協助應用程式以透明的方式處理預期的暫時性失敗，嘗試連線到服務或網路資源時。

- **使用斷路器**處理可能需要在變數的一段時間，若要修正錯誤。 [斷路器模式](../patterns/circuit-breaker.md)可以防止應用程式重複嘗試可能失敗的作業。 斷路器會包裝對服務呼叫，並會追蹤最近的失敗數目。 如果失敗計數超過臨界值，則斷路器會開始傳回錯誤碼而不呼叫服務。 這可讓服務有時間復原，有助於避免發生連鎖性失敗。
- **隔離重要的資源。** 在某個子系統中的失敗有時候可能會重疊，導致失敗的應用程式其他部分。 就可能發生此失敗可防止資源，例如執行緒或通訊端釋放，導致資源耗盡。 若要避免這個問題，您可以系統分割為隔離群組，讓一個分割區中的失敗不會使整個系統當機。

    以下是一些範例，這項技術，這有時稱為[隔艙模式](../patterns/bulkhead.md):

  - 資料分割 （例如，藉由租用戶） 資料庫，並指派不同的集區的每個資料分割的 web 伺服器執行個體。
  - 使用個別執行緒集區將呼叫隔離至不同的服務。 如果其中一個服務失敗，這有助於防止階層式失敗。 如需範例，請參閱 Netflix [hystrix 文件庫](https://medium.com/netflix-techblog/introducing-hystrix-for-resiliency-engineering-13531c1ab362)。
  - 使用[容器](https://en.wikipedia.org/wiki/Operating-system-level_virtualization)來限制特定子系統的可用資源。

      ![隔艙模式的圖表](_images/bulkhead.png)

- **適用於[*補償交易*](../patterns/compensating-transaction.md)**。 補償交易是將另一個已完成交易的影響復原的交易。 在分散式系統中，很難達到強式交易一致性。 補償交易以協助使用一系列的較小型的個別交易可以復原在每個步驟來達成一致性。 例如，若要預訂旅程，客戶可能要預約汽車、旅館房間和班機。 如果其中一個步驟失敗，整個作業就會失敗。 您並非在整個作業中嘗試使用單一的分散式交易，而是可以定義每個步驟的補償交易。
- **實作非同步作業，可能的話。** 同步作業會獨佔資源，而且在呼叫端等候程序完成時，封鎖其他作業。 設計您的應用程式，以便盡可能的非同步作業的每個部分。 如需有關如何在 C 中實作非同步程式設計\#，請參閱 <<c2> [ 非同步程式設計](/dotnet/articles/csharp/async)。

## <a name="ensure-that-availability-meets-slas"></a>請確認可用性符合 Sla

*可用性*比例的時間，系統可正常運作，而且其中一個[軟體品質要素](../guide/pillars.md)。 在本節中使用的工作，以檢閱您的應用程式架構，從可用性的觀點，確定您的可用性會符合您的 Sla。

- **請避免單一失敗點。**  為避免單一失敗點影響可用性，應該將所有的元件、服務、資源和計算執行個體部署為多個執行個體。 驗證機制也可以是單一失敗點。 應用程式設計為可進行設定，若要使用多個執行個體，以便自動偵測失敗，並要求重新導向至非失敗的執行個體，如果平台不會自動執行此動作。
- **根據服務層級目標來分解工作負載。**  如果服務由重要和比較不重要的工作負載組成，請以不同的方式加以管理，並指定服務功能及執行個體數目，以符合其可用性需求。
- **最小化和了解服務相依性。** 盡可能使用不同的服務數目降至最低。 請確定您已了解所有功能和服務相依性，存在於系統中。 特別是，了解失敗或在每個相依性的效能降低的整體影響。
- **將工作和訊息設計*具有等冪性*，其中可能。** 若作業可以多次重複並產生相同的結果，則作業具有等冪性。 這可以確保重複的要求不會造成問題。 訊息取用者與其執行的作業應該具有等冪性，這樣重複先前執行過的作業才不會使結果無效。 這可能表示偵測重複訊息，或使用開放式的方法來處理衝突，以確保一致性。
- **設定要求逾時。**  服務和資源可能會變成無法使用，導致要求失敗。 請確認您所套用的逾時值是適用於每個服務或資源，然後用戶端可存取它們。 在某些情況下，您可能會允許用戶端的特定執行個體有較長的逾時，取決於用戶端所執行的內容和其他動作。 短的逾時可能會導致過多的重試作業的服務和具有大量延遲的資源。 長的逾時可能會導致封鎖，如果大量的要求會排入佇列，等待服務或資源回應。
- **使用可實作重要交易之高可用性的訊息代理人。** 許多雲端應用程式會使用傳訊來觸發程序的非同步工作。 若要保證訊息的傳遞，傳訊系統應該提供高可用性。 [Azure 服務匯流排傳訊](/azure/service-bus-messaging)會實作*至少一次*語意，這表示保證訊息會傳遞至少一次。 在某些情況下，可能傳送重複的訊息。 如果訊息處理是等冪 (請參閱上一個項目)，重複傳遞應該不是問題。
- **節流處理大量使用者。** 有時候，少數的使用者會建立過多的負載。 這可能會對其他使用者造成影響，並可減少您的應用程式的整體可用性。 當單一用戶端提出的要求數目過多時，應用程式可能會將用戶端節流一段時間。 在節流期間，應用程式會從該用戶端拒絕部分或所有的要求。 節流的臨界值通常取決於客戶的服務層。 如需詳細資訊，請參閱 <<c0> [ 節流模式](../patterns/throttling.md)。

    節流並不表示，用戶端一定有惡意&mdash;僅表示它超過其服務配額。 在某些情況下，取用者可能會持續超過其配額或是行為不當。 在此情況下，您可能會繼續執行並封鎖使用者。 一般而言，這是透過封鎖 API 金鑰或 IP 位址範圍來完成。
- **設計可依正常程序降級的應用程式。** 應用程式上的負載可能會超出其中一或多個組件的容量，而導致可用性降低和連線失敗。 調整可以減輕這個問題，但它可能會到達資源可用性或成本等其他因素所加諸的限制。 應用程式達到資源限制時，應該採取適當的動作，將對於使用者的影響降到最低。 例如，在電子商務系統中，如果訂單處理子系統處於疲勞或失敗，它可以是暫時停用同時允許其他功能，例如瀏覽產品目錄。 它可能會延後對失敗子系統的要求適當&mdash;比方說，仍可讓客戶可以提交訂單，但儲存以供稍後處理，「 訂單 」 子系統再次可用時。
- **適當處理急促高載事件。** 大部分的應用程式所需要處理的工作負載，會隨著時間而有所不同。 自動調整有助於處理負載，但是可能需要一些時間讓其他執行個體上線並處理要求。 若要防止暴增的活動而吃不消應用程式，請使用的服務，並佇列接近容量時適當降級的佇列要求設計。 請確認有足夠的效能和容量可在非高載條件清空佇列並處理未處理的要求。 如需詳細資訊，請參閱[佇列型負載調節模式](../patterns/queue-based-load-leveling.md)。
- **撰寫或容錯回復到多個元件。** 應用程式設計成儘可能使用多個執行個體，而不影響作業和現有的連線。 若要將可用性最大化、 使用多個執行個體並分散它們之間的要求和偵測並避免傳送要求給失敗的執行個體。
- **容錯回復至不同的服務或工作流程。** 例如，如果寫入至 SQL Database 失敗，暫時將資料儲存在 Blob 儲存體或 Redis 快取中。 服務可供使用時，請提供重新執行寫入至 SQL Database 的功能。 在某些情況下，失敗的作業可能會有替代動作，讓應用程式繼續運作，即使當元件或服務失敗。 可能的話，請偵測失敗，並在主要服務離線時，將要求重新導向至其他服務。
- **使用負載均衡來緩和突然增加的流量。** 應用程式可能會突然出現尖峰流量，可能會淹沒後端服務。 如果後端服務無法回應要求速度不夠快，待決的要求可能會累積，或服務可節流應用程式。 若要避免這個問題，您可以使用佇列作為緩衝區。 當沒有新的工作項目，而不是立即呼叫後端服務時，應用程式排入佇列以非同步方式執行的工作項目。 佇列會作為消除負載尖峰的緩衝區。 如需詳細資訊，請參閱 <<c0> [ 佇列型負載調節模式](../patterns/queue-based-load-leveling.md)。

## <a name="manage-your-data"></a>管理您的資料

您如何管理您的資料會直接將您的應用程式的可用性播放。 在本節中的工作可協助您建立管理計畫，以協助確保可用性。

- **複寫資料，並了解您的應用程式資料存放區的複寫方法。** 複寫資料是處理資料存放區中非暫時性失敗的一般策略。 請考慮讀取和寫入的路徑。 根據儲存體技術中，您可能會有多個可寫入的複本，或您可能會有單一的可寫入複本及多個唯讀複本。 若要將可用性最大化，可將複本放在多個區域。 不過，這種方法會將複寫資料時增加延遲。 一般而言，跨區域複寫會以非同步方式進行，這表示複本失敗時，會有最終一致性模型和資料遺失。  

  您可以使用[Azure Site Recovery](/azure/site-recovery/azure-to-azure-quickstart/)從一個區域複寫 Azure 虛擬機器。 Site Recovery 持續將資料複寫至目標區域。 如果您的主要站台發生中斷，您容錯移轉到次要位置。

- **確保所有單一使用者帳戶均無法同時存取生產和備份資料。** 如果有單一使用者帳戶同時具有寫入生產與備份來源的權限，您的資料備份就會受到危害。 惡意使用者可能會刻意刪除您所有的資料，並以一般使用者可能不小心刪除它。 設計您的應用程式，以限制每個使用者帳戶的權限。 只授與寫入存取權，需要使用者，並授與存取生產或備份，但非兩者。
- **文件和測試資料存放區容錯移轉和容錯回復程序。** 如果發生災難性失敗的資料存放區，操作人員必須遵循一組書面指示來容錯移轉至新的資料存放區。 如果記錄的步驟中遇到錯誤，操作員將無法成功地遵循它們，並容錯移轉的資源。 定期測試指示步驟，以驗證遵循文件的操作員可以成功地容錯移轉和容錯回復。
- **備份資料，並驗證您的資料備份。** 定期執行的指令碼，以驗證資料完整性、 結構描述和查詢，以確保備份資料是您的預期。 記錄和報告不一致情形，以便修復備份服務。
- **使用定期備份和還原時間點。** 定期並自動備份不會保留其他位置的資料。 請確認您可以可靠地還原資料和應用程式本身發生錯誤。 請確定備份符合您的 RPO。 資料複寫並不是備份功能，因為人為錯誤或惡意作業可能會損毀的資料在所有複本上。 備份程序必須是安全的，才能保護傳輸和儲存體中的資料。 資料庫通常可以復原到前一個點的時間使用交易記錄檔。 如需詳細資訊，請參閱 <<c0> [ 從資料損毀或意外刪除復原](../resiliency/recovery-data-corruption.md)。
- **請考慮使用異地備援儲存體帳戶。** 儲存於 Azure 儲存體帳戶的資料一律會在本機複寫。 不過，有多個複寫策略，可供佈建儲存體帳戶時從中選擇。 若要保護您的應用程式資料免於少數的情況下，當整個區域無法使用時，選取[Azure 讀取權限異地備援儲存體 (RA-GRS)](/azure/storage/storage-redundancy/#read-access-geo-redundant-storage)。  

    > [!NOTE]
    > 若為 VM，請勿依賴 RA-GRS 複寫來還原 VM 磁碟 (VHD 檔案)。 請改用 [Azure 備份](/azure/backup)。

- **請考慮將參考資料部署到多個區域。** 參考資料是可支援應用程式功能的唯讀資料。 它通常不常變更。 雖然從備份還原是一種方式處理全區域服務中斷，RTO 是較長。 當您將應用程式部署到次要地區時，有些策略可改善參考資料的 RTO。

    因為參考的資料變更很少，您可以改善 RTO，藉由維護永久複本在次要區域中的。 這會排除在災害後還原備份所需的時間。 為了符合多重區域的災害復原需求，您必須在多個區域上一起部署應用程式和參考資料。

- **使用開放式並行存取和最終一致性。** 透過鎖定資源的交易封鎖存取 (*封閉式並行存取*) 可能會導致效能不佳，並降低可用性。 這些問題在分散式系統中可能會變得特別嚴重。 在許多情況下，謹慎設計和技術，例如資料分割，可以減少發生更新衝突的機會。 如果資料已複寫，或從個別更新存放區讀取，才會最終一致的資料。 但優點通常遠大於對使用交易來確保立即一致性的可用性的影響。
- **若要將變更複寫到次要資料庫使用 SQL database 的主動式異地複寫。** SQL database 的主動式異地複寫會自動將資料庫變更複寫至次要資料庫位於相同區域或不同區域中。 如需詳細資訊，請參閱 <<c0> [ 建立和使用主動式異地複寫](/azure/sql-database/sql-database-active-geo-replication)。

  或者，您可以採取較為手動的方式，利用**資料庫複製**命令來建立資料庫的備份副本，具有交易一致性。 您也可以使用 Azure SQL Database 的匯入/匯出服務，其支援將資料庫匯出到 BACPAC 檔案 (此為包含資料庫結構描述和相關聯資料的壓縮檔案)，並儲存在 Azure Blob 儲存體中。 Azure 儲存體相同的區域中建立的備份檔案的兩個複本。 不過，備份程序的頻率會決定您的 RPO，這是您可能會遺失在災害案例中的資料量。 例如，如果您備份資料每隔一小時，而災害發生在備份之前的兩分鐘，將會遺失的 58 分鐘資料。 此外，若要防止全區域的服務中斷，您應該將 BACPAC 檔案複製到替代區域。 如需詳細資訊，請參閱 <<c0> [ 使用 Azure SQL Database 的業務續航力概觀](/azure/sql-database/sql-database-business-continuity)。

- **用於 SQL 資料倉儲中的異地備份。** 對於 SQL 資料倉儲，請使用[異地備份](/azure/sql-data-warehouse/backup-and-restore)還原至配對區域以進行災害復原。 這些備份會每隔 24 小時，且可以在 20 分鐘內還原在配對的區域中。 所有的 SQL 資料倉儲執行個體的預設為開啟這項功能。 如需有關如何還原您的資料倉儲的詳細資訊，請參閱[Azure 地理區域使用 PowerShell 從還原。](/azure/sql-data-warehouse/sql-data-warehouse-restore)

- **使用 Azure Site Recovery 複寫 VM 磁碟。** 使用 Azure Vm 的複寫時[Site Recovery](/azure/site-recovery/)，所有 VM 磁碟持續會以非同步方式都複寫到目標區域。 每隔幾分鐘就會建立一次復原點。 這可讓您為大約幾分鐘的 RPO。
- **在 Vm 上執行的 SQL Server 備份或記錄傳送工作階段設定。** 對於在虛擬機器上執行的 SQL Server，有兩種選項：傳統備份和記錄傳送。 傳統備份可讓您還原至特定點的時間，但復原程序緩慢。 還原傳統備份需要初始完整備份開始，然後套用之後所建立的任何備份。 第二個選項是設定記錄傳送工作階段 （例如，藉由兩個小時為單位） 的記錄備份還原延遲。 這會提供從在主要伺服器上所造成的錯誤復原的時間。
- **Azure 儲存體備份使用自訂的處理序或協力廠商工具。** Azure 儲存體，您可以開發自訂備份程序，或使用協力廠商備份工具。 大部分的應用程式設計有額外的複雜性，其中的儲存體資源相互參考。 例如，假設 SQL database 具有資料行連結至 Azure 儲存體中的 blob。 如果備份未同時進行，則資料庫可能有失敗前未備份 Blob 的指標。 應用程式或災害復原計畫必須實作相關程序來處理復原後的此種不一致情況。
- **用於在 Vm 上裝載的其他資料平台的原生複寫或快照集功能。** 其他資料平台，例如 Elasticsearch 或 MongoDB，有其自己的功能和考量時建立的整合式的備份和還原程序。 對於這些資料平台，一般建議是使用任何原生或可用整合為基礎的複寫或快照集功能。 如果這些功能不存在，或者不合適，請考慮使用 Azure 備份或磁碟的快照集建立的應用程式資料的時間點複本。 在所有情況下，請務必判斷如何達到一致的備份，尤其是當應用程式資料橫跨多個檔案系統或多個磁碟機組合成單一檔案系統。
- **了解您的應用程式資料來源的複寫方法。** 您的應用程式資料會儲存在不同的資料來源，並將具有不同可用性需求。 評估的資料儲存在 Azure 中，每種類型的複寫方法包括[Azure 儲存體備援](/azure/storage/storage-redundancy/)並[SQL Database 作用中異地複寫](/azure/sql-database/sql-database-geo-replication-overview/)，確保您的應用程式資料已滿足需求。 如果您將使用的 Azure Vm 複寫[Site Recovery](/azure/site-recovery/)，所有 VM 磁碟持續會以非同步方式都複寫到目標區域。 每隔幾分鐘就會建立一次復原點。
- **建立災害復原的資料策略。** 適當處理資料是任何災害復原計劃的一項麻煩。 在復原過程中，通常會花最多時間在還原資料。 不同的降低功能選擇會導致資料修復和一致性的困難挑戰。

## <a name="next-steps"></a>後續步驟

> [!div class="nextstepaction"]
> [針對復原能力和可用性測試](./testing.md)
