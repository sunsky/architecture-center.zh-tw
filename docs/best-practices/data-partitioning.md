---
title: 資料分割指引
titleSuffix: Best practices for cloud applications
description: 如何分割要個別管理和存取的分割區指引。
author: dragon119
ms.date: 11/04/2018
ms.topic: best-practice
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: 561fe6e47a4cd64aa545349dde4c76260d76e78e
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58248953"
---
# <a name="horizontal-vertical-and-functional-data-partitioning"></a><span data-ttu-id="84b16-103">水平、垂直和功能性資料分割</span><span class="sxs-lookup"><span data-stu-id="84b16-103">Horizontal, vertical, and functional data partitioning</span></span>

<span data-ttu-id="84b16-104">在許多大型解決方案中，資料分成分割區，可以個別管理和存取。</span><span class="sxs-lookup"><span data-stu-id="84b16-104">In many large-scale solutions, data is divided into *partitions* that can be managed and accessed separately.</span></span> <span data-ttu-id="84b16-105">資料分割可以改善延展性、減少爭用，以及最佳化效能。</span><span class="sxs-lookup"><span data-stu-id="84b16-105">Partitioning can improve scalability, reduce contention, and optimize performance.</span></span> <span data-ttu-id="84b16-106">它也提供機制以根據使用模式來分隔資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-106">It can also provide a mechanism for dividing data by usage pattern.</span></span> <span data-ttu-id="84b16-107">例如，您可以將較舊的資料封存至成本較低的資料儲存空間。</span><span class="sxs-lookup"><span data-stu-id="84b16-107">For example, you can archive older data in cheaper data storage.</span></span>

<span data-ttu-id="84b16-108">但是，您必須仔細選擇資料分割策略，才能最大化利益，同時將不良影響降至最低。</span><span class="sxs-lookup"><span data-stu-id="84b16-108">However, the partitioning strategy must be chosen carefully to maximize the benefits while minimizing adverse effects.</span></span>

> [!NOTE]
> <span data-ttu-id="84b16-109">本中所用的「資料分割」一詞指的是實際將資料區分至個別資料存放區的程序。</span><span class="sxs-lookup"><span data-stu-id="84b16-109">In this article, the term *partitioning* means the process of physically dividing data into separate data stores.</span></span> <span data-ttu-id="84b16-110">這和 SQL Server 的資料表分割不同。</span><span class="sxs-lookup"><span data-stu-id="84b16-110">It is not the same as SQL Server table partitioning.</span></span>

<!-- markdownlint-disable MD026 -->

## <a name="why-partition-data"></a><span data-ttu-id="84b16-111">為何要分割資料？</span><span class="sxs-lookup"><span data-stu-id="84b16-111">Why partition data?</span></span>

<!-- markdownlint-enable MD026 -->

- <span data-ttu-id="84b16-112">**改善延展性**。</span><span class="sxs-lookup"><span data-stu-id="84b16-112">**Improve scalability**.</span></span> <span data-ttu-id="84b16-113">當您相應增加單一資料庫系統時，其最終將會到達實體硬體限制。</span><span class="sxs-lookup"><span data-stu-id="84b16-113">When you scale up a single database system, it will eventually reach a physical hardware limit.</span></span> <span data-ttu-id="84b16-114">如果您跨多個分割區來區分資料，而其中每一個分割區都裝載於個別伺服器上，您幾乎能夠無限制地相應放大系統。</span><span class="sxs-lookup"><span data-stu-id="84b16-114">If you divide data across multiple partitions, each hosted on a separate server, you can scale out the system almost indefinitely.</span></span>

- <span data-ttu-id="84b16-115">**提升效能**。</span><span class="sxs-lookup"><span data-stu-id="84b16-115">**Improve performance**.</span></span> <span data-ttu-id="84b16-116">在每個分割區上的資料存取作業會透過較小的資料磁碟區進行。</span><span class="sxs-lookup"><span data-stu-id="84b16-116">Data access operations on each partition take place over a smaller volume of data.</span></span> <span data-ttu-id="84b16-117">正確完成的話，資料分割可讓您的系統更有效率。</span><span class="sxs-lookup"><span data-stu-id="84b16-117">Correctly done, partitioning can make your system more efficient.</span></span> <span data-ttu-id="84b16-118">影響多個分割區的作業都能平行執行。</span><span class="sxs-lookup"><span data-stu-id="84b16-118">Operations that affect more than one partition can run in parallel.</span></span>

- <span data-ttu-id="84b16-119">**改善安全性**。</span><span class="sxs-lookup"><span data-stu-id="84b16-119">**Improve security**.</span></span> <span data-ttu-id="84b16-120">在某些情況下，您可以將機密和非機密資料分隔到不同的分割區，並且將不同的安全性控制項套用至機密資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-120">In some cases, you can separate sensitive and non-sensitive data into different partitions and apply different security controls to the sensitive data.</span></span>

- <span data-ttu-id="84b16-121">**提供做業彈性**。</span><span class="sxs-lookup"><span data-stu-id="84b16-121">**Provide operational flexibility**.</span></span> <span data-ttu-id="84b16-122">資料分割提供許多微調作業、最大化系統管理效率和最小化成本的機會。</span><span class="sxs-lookup"><span data-stu-id="84b16-122">Partitioning offers many opportunities for fine tuning operations, maximizing administrative efficiency, and minimizing cost.</span></span> <span data-ttu-id="84b16-123">例如，您可以根據資料在每個分割區中的重要性，來定義適用於管理、監視、備份和還原的不同原則，以及其他系統管理工作。</span><span class="sxs-lookup"><span data-stu-id="84b16-123">For example, you can define different strategies for management, monitoring, backup and restore, and other administrative tasks based on the importance of the data in each partition.</span></span>

- <span data-ttu-id="84b16-124">**比對資料存放區和使用模式**。</span><span class="sxs-lookup"><span data-stu-id="84b16-124">**Match the data store to the pattern of use**.</span></span> <span data-ttu-id="84b16-125">資料分割可根據資料存放區所提供的成本和內建功能，讓每個分割區部署在不同類型的資料存放區上。</span><span class="sxs-lookup"><span data-stu-id="84b16-125">Partitioning allows each partition to be deployed on a different type of data store, based on cost and the built-in features that data store offers.</span></span> <span data-ttu-id="84b16-126">例如，大型二進位資料可儲存於 Blob 儲存體，而更為結構化的資料可保存於文件資料庫中。</span><span class="sxs-lookup"><span data-stu-id="84b16-126">For example, large binary data can be stored in blob storage, while more structured data can be held in a document database.</span></span> <span data-ttu-id="84b16-127">請參閱[選擇正確的資料存放區](../guide/technology-choices/data-store-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="84b16-127">See [Choose the right data store](../guide/technology-choices/data-store-overview.md).</span></span>

- <span data-ttu-id="84b16-128">**改善可用性**。</span><span class="sxs-lookup"><span data-stu-id="84b16-128">**Improve availability**.</span></span> <span data-ttu-id="84b16-129">跨多個伺服器分格資料可避免單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="84b16-129">Separating data across multiple servers avoids a single point of failure.</span></span> <span data-ttu-id="84b16-130">如果一個執行個體失敗，則只有該分割區中的資料無法使用。</span><span class="sxs-lookup"><span data-stu-id="84b16-130">If one instance fails, only the data in that partition is unavailable.</span></span> <span data-ttu-id="84b16-131">在其他分割區上的作業可以繼續進行。</span><span class="sxs-lookup"><span data-stu-id="84b16-131">Operations on other partitions can continue.</span></span> <span data-ttu-id="84b16-132">針對受控 PaaS 資料存放區，這項考量較不相關，因為這些服務已設計成具有內建備援。</span><span class="sxs-lookup"><span data-stu-id="84b16-132">For managed PaaS data stores, this consideration is less relevant, because these services are designed with built-in redundancy.</span></span>

## <a name="designing-partitions"></a><span data-ttu-id="84b16-133">移除分割區</span><span class="sxs-lookup"><span data-stu-id="84b16-133">Designing partitions</span></span>

<span data-ttu-id="84b16-134">分割資料的三個典型的策略是：</span><span class="sxs-lookup"><span data-stu-id="84b16-134">There are three typical strategies for partitioning data:</span></span>

- <span data-ttu-id="84b16-135">**水平資料分割** (通常稱為「分區化」)。</span><span class="sxs-lookup"><span data-stu-id="84b16-135">**Horizontal partitioning** (often called *sharding*).</span></span> <span data-ttu-id="84b16-136">在此策略中，每個分割區都是資料存放區，但所有分割區具有相同的結構描述。</span><span class="sxs-lookup"><span data-stu-id="84b16-136">In this strategy, each partition is a separate data store, but all partitions have the same schema.</span></span> <span data-ttu-id="84b16-137">每個分割區都稱為「分區」，而且會保存特定的資料子集，例如，一組特定客戶的所有訂單。</span><span class="sxs-lookup"><span data-stu-id="84b16-137">Each partition is known as a *shard* and holds a specific subset of the data, such as all the orders for a specific set of customers.</span></span>

- <span data-ttu-id="84b16-138">**垂直資料分割**。</span><span class="sxs-lookup"><span data-stu-id="84b16-138">**Vertical partitioning**.</span></span> <span data-ttu-id="84b16-139">在此策略中，每個分割區會在資料存放區中保留項目的欄位子集。</span><span class="sxs-lookup"><span data-stu-id="84b16-139">In this strategy, each partition holds a subset of the fields for items in the data store.</span></span> <span data-ttu-id="84b16-140">欄位會根據其使用模式來區分。</span><span class="sxs-lookup"><span data-stu-id="84b16-140">The fields are divided according to their pattern of use.</span></span> <span data-ttu-id="84b16-141">比方說，經常存取的欄位可能會放在一個垂直的分割區中，而較不常存取的欄位則放置於另一個分割區中。</span><span class="sxs-lookup"><span data-stu-id="84b16-141">For example, frequently accessed fields might be placed in one vertical partition and less frequently accessed fields in another.</span></span>

- <span data-ttu-id="84b16-142">**功能資料分割**。</span><span class="sxs-lookup"><span data-stu-id="84b16-142">**Functional partitioning**.</span></span> <span data-ttu-id="84b16-143">在此策略中，資料會根據系統中每個繫結的內容使用它的方式進行彙總。</span><span class="sxs-lookup"><span data-stu-id="84b16-143">In this strategy, data is aggregated according to how it is used by each bounded context in the system.</span></span> <span data-ttu-id="84b16-144">例如，電子商務系統可能會將發票資料儲存在某個分割區，而將產品庫存資料儲存在另一個分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-144">For example, an e-commerce system might store invoice data in one partition and product inventory data in another.</span></span>

<span data-ttu-id="84b16-145">這些策略可以合併，建議您在設計資料分割配置時應全部納入考量。</span><span class="sxs-lookup"><span data-stu-id="84b16-145">These strategies can be combined, and we recommend that you consider them all when you design a partitioning scheme.</span></span> <span data-ttu-id="84b16-146">例如，您可能會將資料區分成分區，然後使用垂直資料分割進一步細分每個分區中的資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-146">For example, you might divide data into shards and then use vertical partitioning to further subdivide the data in each shard.</span></span>

### <a name="horizontal-partitioning-sharding"></a><span data-ttu-id="84b16-147">水平資料分割 (分區化)</span><span class="sxs-lookup"><span data-stu-id="84b16-147">Horizontal partitioning (sharding)</span></span>

<span data-ttu-id="84b16-148">圖 1 顯示水平資料分割或分區化。</span><span class="sxs-lookup"><span data-stu-id="84b16-148">Figure 1 shows horizontal partitioning or sharding.</span></span> <span data-ttu-id="84b16-149">在此範例中，產品庫存資料會根據產品索引鍵區分成分區。</span><span class="sxs-lookup"><span data-stu-id="84b16-149">In this example, product inventory data is divided into shards based on the product key.</span></span> <span data-ttu-id="84b16-150">每個分區都保存分區索引鍵 (A-G 和 H-Z) 的連續範圍資料，依照字母順序排列。</span><span class="sxs-lookup"><span data-stu-id="84b16-150">Each shard holds the data for a contiguous range of shard keys (A-G and H-Z), organized alphabetically.</span></span> <span data-ttu-id="84b16-151">分區化會將負載分散到多部電腦，以減少爭用並改善效能。</span><span class="sxs-lookup"><span data-stu-id="84b16-151">Sharding spreads the load over more computers, which reduces contention and improves performance.</span></span>

![水平資料分割 (分區化) 的資料是以分割區索引鍵為基礎](./images/data-partitioning/DataPartitioning01.png)

<span data-ttu-id="84b16-153">*圖 1.水平資料分割 (分區化) 的資料是以分割區索引鍵為基礎。*</span><span class="sxs-lookup"><span data-stu-id="84b16-153">*Figure 1. Horizontally partitioning (sharding) data based on a partition key.*</span></span>

<span data-ttu-id="84b16-154">最重要的因素是分區金鑰的選擇。</span><span class="sxs-lookup"><span data-stu-id="84b16-154">The most important factor is the choice of a sharding key.</span></span> <span data-ttu-id="84b16-155">系統在作業之後，就很難變更索引鍵。</span><span class="sxs-lookup"><span data-stu-id="84b16-155">It can be difficult to change the key after the system is in operation.</span></span> <span data-ttu-id="84b16-156">金鑰必須確定資料已分割，使工作負載盡可能跨分區平均分配。</span><span class="sxs-lookup"><span data-stu-id="84b16-156">The key must ensure that data is partitioned to spread the workload as evenly as possible across the shards.</span></span>

<span data-ttu-id="84b16-157">分區的大小不一定要相同。</span><span class="sxs-lookup"><span data-stu-id="84b16-157">The shards don't have to be the same size.</span></span> <span data-ttu-id="84b16-158">務必讓要求數目平衡。</span><span class="sxs-lookup"><span data-stu-id="84b16-158">It's more important to balance the number of requests.</span></span> <span data-ttu-id="84b16-159">有些分區可能非常大，但每個項目都只有少量存取作業。</span><span class="sxs-lookup"><span data-stu-id="84b16-159">Some shards might be very large, but each item has a low number of access operations.</span></span> <span data-ttu-id="84b16-160">其他的分區可能比較小，但是更常存取每個項目。</span><span class="sxs-lookup"><span data-stu-id="84b16-160">Other shards might be smaller, but each item is accessed much more frequently.</span></span> <span data-ttu-id="84b16-161">另一個重點是確保單一分區不會超過資料存放區的規模限制 (以容量和處理資源為準)。</span><span class="sxs-lookup"><span data-stu-id="84b16-161">It's also important to ensure that a single shard does not exceed the scale limits (in terms of capacity and processing resources) of the data store.</span></span>

<span data-ttu-id="84b16-162">請避免建立「熱點」分割區，其會影響效能和可用性。</span><span class="sxs-lookup"><span data-stu-id="84b16-162">Avoid creating "hot" partitions that can affect performance and availability.</span></span> <span data-ttu-id="84b16-163">例如，使用客戶名稱的第一個字母會導致分散不平衡，因為某些字母較為常見。而改為使用客戶識別碼的雜湊就可以將資料平均地分散到分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-163">For example, using the first letter of a customer’s name causes an unbalanced distribution, because some letters are more common Instead, use a hash of a customer identifier to distribute data more evenly across partitions.</span></span>

<span data-ttu-id="84b16-164">選擇可最小化任何未來需求的分區金鑰，以分割大型分區、將小型分區聯合成較大的分割區，或者變更結構描述。</span><span class="sxs-lookup"><span data-stu-id="84b16-164">Choose a sharding key that minimizes any future requirements to split large shards, coalesce small shards into larger partitions, or change the schema.</span></span> <span data-ttu-id="84b16-165">這些作業非常耗時，而且可能需要在執行時讓一或多個分區離線。</span><span class="sxs-lookup"><span data-stu-id="84b16-165">These operations can be very time consuming, and might require taking one or more shards offline while they are performed.</span></span>

<span data-ttu-id="84b16-166">如果複寫分區，某些複本可能要保持上線，而其他複本會被劃分、合併或重新設定。</span><span class="sxs-lookup"><span data-stu-id="84b16-166">If shards are replicated, it might be possible to keep some of the replicas online while others are split, merged, or reconfigured.</span></span> <span data-ttu-id="84b16-167">但在進行重新設定時，系統可能需要限制可以執行的作業。</span><span class="sxs-lookup"><span data-stu-id="84b16-167">However, the system might need to limit the operations that can be performed during the reconfiguration.</span></span> <span data-ttu-id="84b16-168">例如，複本中的資料可能會標示為唯讀，以避免資料不一致。</span><span class="sxs-lookup"><span data-stu-id="84b16-168">For example, the data in the replicas might be marked as read-only to prevent data inconsistences.</span></span>

<span data-ttu-id="84b16-169">如需有關水平資料分割的詳細資訊，請參閱 [分區化模式]。</span><span class="sxs-lookup"><span data-stu-id="84b16-169">For more information about horizontal partitioning, see [Sharding pattern].</span></span>

### <a name="vertical-partitioning"></a><span data-ttu-id="84b16-170">垂直資料分割</span><span class="sxs-lookup"><span data-stu-id="84b16-170">Vertical partitioning</span></span>

<span data-ttu-id="84b16-171">垂直資料分割的最常見用途是可降低與擷取最常存取之項目相關聯的 I/O 和效能成本。</span><span class="sxs-lookup"><span data-stu-id="84b16-171">The most common use for vertical partitioning is to reduce the I/O and performance costs associated with fetching items that are frequently accessed.</span></span> <span data-ttu-id="84b16-172">圖 2 顯示垂直資料分割的範例。</span><span class="sxs-lookup"><span data-stu-id="84b16-172">Figure 2 shows an example of vertical partitioning.</span></span> <span data-ttu-id="84b16-173">在此範例中，項目的不同屬性都會儲存在不同的分割區中。</span><span class="sxs-lookup"><span data-stu-id="84b16-173">In this example, different properties of an item are stored in different partitions.</span></span> <span data-ttu-id="84b16-174">有一個分割區會保留較常存取的資料，包括產品名稱、描述和價格。</span><span class="sxs-lookup"><span data-stu-id="84b16-174">One partition holds data that is accessed more frequently, including product name, description, and price.</span></span> <span data-ttu-id="84b16-175">另一個分割區會保留庫存資料：庫存計數和上次訂購日期。</span><span class="sxs-lookup"><span data-stu-id="84b16-175">Another partition holds inventory data: the stock count and last-ordered date.</span></span>

![以使用模式分割的垂直分割資料](./images/data-partitioning/DataPartitioning02.png)

<span data-ttu-id="84b16-177">*圖 2.依使用模式垂直分割資料。*</span><span class="sxs-lookup"><span data-stu-id="84b16-177">*Figure 2. Vertically partitioning data by its pattern of use.*</span></span>

<span data-ttu-id="84b16-178">在此範例中，應用程式會在向客戶顯示產品詳細資料時，固定查詢產品名稱、描述和價格。</span><span class="sxs-lookup"><span data-stu-id="84b16-178">In this example, the application regularly queries the product name, description, and price when displaying the product details to customers.</span></span> <span data-ttu-id="84b16-179">庫存計數和上次訂購日期會保留在個別的分割區，因為這兩個項目通常會一起使用。</span><span class="sxs-lookup"><span data-stu-id="84b16-179">Stock count and last- ordered date are held in a separate partition because these two items are commonly used together.</span></span>

<span data-ttu-id="84b16-180">垂直資料分割的其他優點：</span><span class="sxs-lookup"><span data-stu-id="84b16-180">Other advantages of vertical partitioning:</span></span>

- <span data-ttu-id="84b16-181">移動頻率相當低的資料 (產品名稱、描述和價格) 可以和較動態的資料 (存貨量和上一次訂單日期) 分開。</span><span class="sxs-lookup"><span data-stu-id="84b16-181">Relatively slow-moving data (product name, description, and price) can be separated from the more dynamic data (stock level and last ordered date).</span></span> <span data-ttu-id="84b16-182">移動頻率低的資料是應用程式在記憶體中快取的良好候選項目。</span><span class="sxs-lookup"><span data-stu-id="84b16-182">Slow moving data is a good candidate for an application to cache in memory.</span></span>

- <span data-ttu-id="84b16-183">機密資料可以儲存在具有其他安全性控制項的個別分割區中。</span><span class="sxs-lookup"><span data-stu-id="84b16-183">Sensitive data can be stored in a separate partition with additional security controls.</span></span>

- <span data-ttu-id="84b16-184">垂直資料分割可以減少所需的並行存取數量。</span><span class="sxs-lookup"><span data-stu-id="84b16-184">Vertical partitioning can reduce the amount of concurrent access that's needed.</span></span>

<span data-ttu-id="84b16-185">垂直資料分割都是在資料存放區內的實體層級運做，有部分會正規化實體，將其從「廣泛」項目細分成一組「縮小」項目。</span><span class="sxs-lookup"><span data-stu-id="84b16-185">Vertical partitioning operates at the entity level within a data store, partially normalizing an entity to break it down from a *wide* item to a set of *narrow* items.</span></span> <span data-ttu-id="84b16-186">在理想的情況下，它適用於 HBase 和 Cassandra 等資料行導向的資料存放區。</span><span class="sxs-lookup"><span data-stu-id="84b16-186">It is ideally suited for column-oriented data stores such as HBase and Cassandra.</span></span> <span data-ttu-id="84b16-187">如果資料行集合中的資料不太可能變更，您也可以考慮使用 SQL Server 中的資料行存放區。</span><span class="sxs-lookup"><span data-stu-id="84b16-187">If the data in a collection of columns is unlikely to change, you can also consider using column stores in SQL Server.</span></span>

### <a name="functional-partitioning"></a><span data-ttu-id="84b16-188">功能資料分割</span><span class="sxs-lookup"><span data-stu-id="84b16-188">Functional partitioning</span></span>

<span data-ttu-id="84b16-189">可以在應用程式中為每個不同的商業領域識別繫結內容時，功能資料分割是可改善隔離和資料存取效能的一種方法。</span><span class="sxs-lookup"><span data-stu-id="84b16-189">When it's possible to identify a bounded context for each distinct business area in an application, functional partitioning is a way to improve isolation and data access performance.</span></span> <span data-ttu-id="84b16-190">功能資料分割的另一種常用功能是將讀寫資料與唯讀資料分開。</span><span class="sxs-lookup"><span data-stu-id="84b16-190">Another common use for functional partitioning is to separate read-write data from read-only data.</span></span> <span data-ttu-id="84b16-191">圖 3 顯示功能資料分割的概觀，清查資料可從客戶的資料分開。</span><span class="sxs-lookup"><span data-stu-id="84b16-191">Figure 3 shows an overview of functional partitioning where inventory data is separated from customer data.</span></span>

![以繫結的內容或子網域分割的功能分割資料](./images/data-partitioning/DataPartitioning03.png)

<span data-ttu-id="84b16-193">*圖 3.依繫結的內容或子網域分割的功能分割資料。*</span><span class="sxs-lookup"><span data-stu-id="84b16-193">*Figure 3. Functionally partitioning data by bounded context or subdomain.*</span></span>

<span data-ttu-id="84b16-194">此資料分割策略有助於減少跨系統的不同部分所發生的資料存取爭用。</span><span class="sxs-lookup"><span data-stu-id="84b16-194">This partitioning strategy can help reduce data access contention across different parts of a system.</span></span>

## <a name="designing-partitions-for-scalability"></a><span data-ttu-id="84b16-195">設計延展性的分割區</span><span class="sxs-lookup"><span data-stu-id="84b16-195">Designing partitions for scalability</span></span>

<span data-ttu-id="84b16-196">請務必考慮每個分割區的大小和工作負載並加以平衡，使資料分佈以達到最大延展性。</span><span class="sxs-lookup"><span data-stu-id="84b16-196">It's vital to consider size and workload for each partition and balance them so that data is distributed to achieve maximum scalability.</span></span> <span data-ttu-id="84b16-197">不過，您也必須分割資料，使它不會超過單一資料分割存放區的調整限制。</span><span class="sxs-lookup"><span data-stu-id="84b16-197">However, you must also partition the data so that it does not exceed the scaling limits of a single partition store.</span></span>

<span data-ttu-id="84b16-198">設計具延展性的分割區時，請遵循下列步驟：</span><span class="sxs-lookup"><span data-stu-id="84b16-198">Follow these steps when designing partitions for scalability:</span></span>

1. <span data-ttu-id="84b16-199">分析應用程式以了解資料存取模式，例如每個查詢所傳回的結果集大小、存取的頻率、固有的延遲，以及伺服器端計算處理需求。</span><span class="sxs-lookup"><span data-stu-id="84b16-199">Analyze the application to understand the data access patterns, such as the size of the result set returned by each query, the frequency of access, the inherent latency, and the server-side compute processing requirements.</span></span> <span data-ttu-id="84b16-200">在許多情況下，幾個主要實體會要求大部分的處理資源。</span><span class="sxs-lookup"><span data-stu-id="84b16-200">In many cases, a few major entities will demand most of the processing resources.</span></span>
2. <span data-ttu-id="84b16-201">使用此分析來判斷目前和未來的延展性目標，例如資料大小和工作負載。</span><span class="sxs-lookup"><span data-stu-id="84b16-201">Use this analysis to determine the current and future scalability targets, such as data size and workload.</span></span> <span data-ttu-id="84b16-202">然後將資料分散在各個分割區上，以符合延展性目標。</span><span class="sxs-lookup"><span data-stu-id="84b16-202">Then distribute the data across the partitions to meet the scalability target.</span></span> <span data-ttu-id="84b16-203">針對水平資料分割，選擇適當的分區金鑰，這對確定分佈是否平均很重要。</span><span class="sxs-lookup"><span data-stu-id="84b16-203">For horizontal partitioning, choosing the right shard key is important to make sure distribution is even.</span></span> <span data-ttu-id="84b16-204">如需詳細資訊，請參閱 [分區化模式]。</span><span class="sxs-lookup"><span data-stu-id="84b16-204">For more information, see the [Sharding pattern].</span></span>
3. <span data-ttu-id="84b16-205">請確定每個分割區具有足夠資源，可處理資料大小和輸送量方面的延展性需求。</span><span class="sxs-lookup"><span data-stu-id="84b16-205">Make sure each partition has enough resources to handle the scalability requirements, in terms of data size and throughput.</span></span> <span data-ttu-id="84b16-206">根據資料存放區的不同，儲存空間、處理能力或每個分割區的網路頻寬可能會有所限制。</span><span class="sxs-lookup"><span data-stu-id="84b16-206">Depending on the data store, there might be a limit on the amount of storage space, processing power, or network bandwidth per partition.</span></span> <span data-ttu-id="84b16-207">如果需求可能會超過這些限制，您就可能需要調整您的資料分割策略或進一步劃分資料，也許要合併兩個以上的策略。</span><span class="sxs-lookup"><span data-stu-id="84b16-207">If the requirements are likely to exceed these limits, you may need to refine your partitioning strategy or split data out further, possibly combining two or more strategies.</span></span>
4. <span data-ttu-id="84b16-208">監視系統以確認資料會如預期般分佈，而且分割區可以處理負載。</span><span class="sxs-lookup"><span data-stu-id="84b16-208">Monitor the system to verify that data is distributed as expected and that the partitions can handle the load.</span></span> <span data-ttu-id="84b16-209">實際的使用方式不一定符合分析預測。</span><span class="sxs-lookup"><span data-stu-id="84b16-209">Actual usage does not always match what an analysis predicts.</span></span> <span data-ttu-id="84b16-210">如果是這樣，可能可以重新平衡分割區，或是重新設計系統的某些部分以取得必要的平衡。</span><span class="sxs-lookup"><span data-stu-id="84b16-210">If so, it might be possible to rebalance the partitions, or else redesign some parts of the system to gain the required balance.</span></span>

<span data-ttu-id="84b16-211">某些雲端環境會根據基礎結構界限配置資源。</span><span class="sxs-lookup"><span data-stu-id="84b16-211">Some cloud environments allocate resources in terms of infrastructure boundaries.</span></span> <span data-ttu-id="84b16-212">您應該確定您所選界限的限制可在資料儲存體、處理能力及頻寬等方面，提供足夠的空間，使資料量能夠如預期般成長。</span><span class="sxs-lookup"><span data-stu-id="84b16-212">Ensure that the limits of your selected boundary provide enough room for any anticipated growth in the volume of data, in terms of data storage, processing power, and bandwidth.</span></span>

<span data-ttu-id="84b16-213">例如如果您使用 Azure 資料表儲存空間，對於單一磁碟區可在一段特定期間內處理的要求數量是有限制的。</span><span class="sxs-lookup"><span data-stu-id="84b16-213">For example, if you use Azure table storage, there is a limit to the volume of requests that can be handled by a single partition in a particular period of time.</span></span> <span data-ttu-id="84b16-214">(請參閱 [Azure 儲存體的延展性與效能目標]。)忙碌的分區可能會需要比單一分割區可以處理還要多的資源。</span><span class="sxs-lookup"><span data-stu-id="84b16-214">(See [Azure storage scalability and performance targets].) A busy shard might require more resources than a single partition can handle.</span></span> <span data-ttu-id="84b16-215">如果是這樣，可能需要重新分割分區以散佈負載。</span><span class="sxs-lookup"><span data-stu-id="84b16-215">If so, the shard might need to be repartitioned to spread the load.</span></span> <span data-ttu-id="84b16-216">如果這些資料表的總大小或輸送量超過儲存體帳戶的容量，您可能必須建立其他儲存體帳戶並跨這些帳戶散佈資料表。</span><span class="sxs-lookup"><span data-stu-id="84b16-216">If the total size or throughput of these tables exceeds the capacity of a storage account, you might need to create additional storage accounts and spread the tables across these accounts.</span></span>

## <a name="designing-partitions-for-query-performance"></a><span data-ttu-id="84b16-217">設計查詢效能的分割區</span><span class="sxs-lookup"><span data-stu-id="84b16-217">Designing partitions for query performance</span></span>

<span data-ttu-id="84b16-218">使用較小的資料集和執行平行查詢，通常可提高查詢效能。</span><span class="sxs-lookup"><span data-stu-id="84b16-218">Query performance can often be boosted by using smaller data sets and by running parallel queries.</span></span> <span data-ttu-id="84b16-219">每個分割區都應包含整個資料集的一小部分。</span><span class="sxs-lookup"><span data-stu-id="84b16-219">Each partition should contain a small proportion of the entire data set.</span></span> <span data-ttu-id="84b16-220">數量的縮減可以改善查詢效能。</span><span class="sxs-lookup"><span data-stu-id="84b16-220">This reduction in volume can improve the performance of queries.</span></span> <span data-ttu-id="84b16-221">不過，資料分割並不是適當地設計和設定資料庫的替代方式。</span><span class="sxs-lookup"><span data-stu-id="84b16-221">However, partitioning is not an alternative for designing and configuring a database appropriately.</span></span> <span data-ttu-id="84b16-222">例如，請確定您已備妥必要的索引。</span><span class="sxs-lookup"><span data-stu-id="84b16-222">For example, make sure that you have the necessary indexes in place.</span></span>

<span data-ttu-id="84b16-223">基於查詢效能設計分割區時，請遵循下列步驟：</span><span class="sxs-lookup"><span data-stu-id="84b16-223">Follow these steps when designing partitions for query performance:</span></span>

1. <span data-ttu-id="84b16-224">檢查應用程式的需求以及效能：</span><span class="sxs-lookup"><span data-stu-id="84b16-224">Examine the application requirements and performance:</span></span>

   - <span data-ttu-id="84b16-225">使用商務需求來判斷隨時必須快速執行的重要查詢。</span><span class="sxs-lookup"><span data-stu-id="84b16-225">Use business requirements to determine the critical queries that must always perform quickly.</span></span>
   - <span data-ttu-id="84b16-226">監視系統以識別任何執行速度慢的查詢。</span><span class="sxs-lookup"><span data-stu-id="84b16-226">Monitor the system to identify any queries that perform slowly.</span></span>
   - <span data-ttu-id="84b16-227">尋找最常執行的查詢。</span><span class="sxs-lookup"><span data-stu-id="84b16-227">Find which queries are performed most frequently.</span></span> <span data-ttu-id="84b16-228">即使單一查詢的成本最低，但是累計資源耗用量可能相當高。</span><span class="sxs-lookup"><span data-stu-id="84b16-228">Even if a single query has a minimal cost, the cumulative resource consumption could be significant.</span></span>

2. <span data-ttu-id="84b16-229">分割會導致效能變慢的資料：</span><span class="sxs-lookup"><span data-stu-id="84b16-229">Partition the data that is causing slow performance:</span></span>
   - <span data-ttu-id="84b16-230">限制每個分割區的大小，使查詢回應時間在目標內。</span><span class="sxs-lookup"><span data-stu-id="84b16-230">Limit the size of each partition so that the query response time is within target.</span></span>
   - <span data-ttu-id="84b16-231">如果您使用水平資料分割，請設計分區金鑰，讓應用程式可以輕鬆地選取分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-231">If you use horizontal partitioning, design the shard key so that the application can easily select the right partition.</span></span> <span data-ttu-id="84b16-232">這可防止查詢需要掃描每個分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-232">This prevents the query from having to scan through every partition.</span></span>
   - <span data-ttu-id="84b16-233">請考慮分割區的位置。</span><span class="sxs-lookup"><span data-stu-id="84b16-233">Consider the location of a partition.</span></span> <span data-ttu-id="84b16-234">如果可能，請嘗試將資料保留在地理位置靠近存取它之應用程式和使用者的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-234">If possible, try to keep data in partitions that are geographically close to the applications and users that access it.</span></span>

3. <span data-ttu-id="84b16-235">如果實體有輸送量和查詢效能的需求，請根據該實體使用功能資料分割。</span><span class="sxs-lookup"><span data-stu-id="84b16-235">If an entity has throughput and query performance requirements, use functional partitioning based on that entity.</span></span> <span data-ttu-id="84b16-236">如果這樣還是無法滿足需求，請同時套用水平資料分割。</span><span class="sxs-lookup"><span data-stu-id="84b16-236">If this still doesn't satisfy the requirements, apply horizontal partitioning as well.</span></span> <span data-ttu-id="84b16-237">在大部分情況下，單一資料分割策略就足夠了，但在某些情況下，結合這兩種策略會更有效率。</span><span class="sxs-lookup"><span data-stu-id="84b16-237">In most cases a single partitioning strategy will suffice, but in some cases it is more efficient to combine both strategies.</span></span>

4. <span data-ttu-id="84b16-238">請考慮跨分割區平行執行查詢，以改善效能。</span><span class="sxs-lookup"><span data-stu-id="84b16-238">Consider running queries in parallel across partitions to improve performance.</span></span>

## <a name="designing-partitions-for-availability"></a><span data-ttu-id="84b16-239">設計可用性的分割區</span><span class="sxs-lookup"><span data-stu-id="84b16-239">Designing partitions for availability</span></span>

<span data-ttu-id="84b16-240">分割資料可以確保整個資料集不會構成單一失敗點，而且確保資料集的個別子集可以分開管理，藉以改善應用程式的可用性。</span><span class="sxs-lookup"><span data-stu-id="84b16-240">Partitioning data can improve the availability of applications by ensuring that the entire dataset does not constitute a single point of failure and that individual subsets of the dataset can be managed independently.</span></span>

<span data-ttu-id="84b16-241">請考慮下列會影響可用性的因素：</span><span class="sxs-lookup"><span data-stu-id="84b16-241">Consider the following factors that affect availability:</span></span>

<span data-ttu-id="84b16-242">**資料對商務營運的重要性**。</span><span class="sxs-lookup"><span data-stu-id="84b16-242">**How critical the data is to business operations**.</span></span> <span data-ttu-id="84b16-243">識別哪些資料是重要商務資訊，例如交易，而哪些資料是較不重要的作業資料，例如記錄檔。</span><span class="sxs-lookup"><span data-stu-id="84b16-243">Identify which data is critical business information, such as transactions, and which data is less critical operational data, such as log files.</span></span>

- <span data-ttu-id="84b16-244">請考慮利用適當的備份計劃，將重要資料儲存在高度可用的分割區中。</span><span class="sxs-lookup"><span data-stu-id="84b16-244">Consider storing critical data in highly-available partitions with an appropriate backup plan.</span></span>

- <span data-ttu-id="84b16-245">針對不同的資料集建立個別的管理和監視程序。</span><span class="sxs-lookup"><span data-stu-id="84b16-245">Establish separate management and monitoring procedures for the different datasets.</span></span>

- <span data-ttu-id="84b16-246">將具有相同嚴重性等級的資料放在同一個分割區，利用適當的頻率一併進行備份。</span><span class="sxs-lookup"><span data-stu-id="84b16-246">Place data that has the same level of criticality in the same partition so that it can be backed up together at an appropriate frequency.</span></span> <span data-ttu-id="84b16-247">例如，保留交易資料的分割區的備份頻率可能必須高於保留記錄或追蹤資訊的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-247">For example, partitions that hold transaction data might need to be backed up more frequently than partitions that hold logging or trace information.</span></span>

<span data-ttu-id="84b16-248">**個別分割區的管理方式**。</span><span class="sxs-lookup"><span data-stu-id="84b16-248">**How individual partitions can be managed**.</span></span> <span data-ttu-id="84b16-249">將分割區設計為支援獨立管理和維護可提供數個優點。</span><span class="sxs-lookup"><span data-stu-id="84b16-249">Designing partitions to support independent management and maintenance provides several advantages.</span></span> <span data-ttu-id="84b16-250">例如︰</span><span class="sxs-lookup"><span data-stu-id="84b16-250">For example:</span></span>

- <span data-ttu-id="84b16-251">如果分割區失敗，可以獨立復原而不會影響在其他分割區中存取資料的應用程式。</span><span class="sxs-lookup"><span data-stu-id="84b16-251">If a partition fails, it can be recovered independently without applications that access data in other partitions.</span></span>

- <span data-ttu-id="84b16-252">依地理區域分割資料，允許已排程的維護工作在每個位置的離峰時段進行。</span><span class="sxs-lookup"><span data-stu-id="84b16-252">Partitioning data by geographical area allows scheduled maintenance tasks to occur at off-peak hours for each location.</span></span> <span data-ttu-id="84b16-253">請確定分割區不會太大而無法防止任何已規劃的分割區維護在這段期間完成。</span><span class="sxs-lookup"><span data-stu-id="84b16-253">Ensure that partitions are not too big to prevent any planned maintenance from being completed during this period.</span></span>

<span data-ttu-id="84b16-254">**是否要跨分割區複寫重要資料**。</span><span class="sxs-lookup"><span data-stu-id="84b16-254">**Whether to replicate critical data across partitions**.</span></span> <span data-ttu-id="84b16-255">此策略可以改善可用性和效能，不過它也會導入一致性問題。</span><span class="sxs-lookup"><span data-stu-id="84b16-255">This strategy can improve availability and performance, but can also introduce consistency issues.</span></span> <span data-ttu-id="84b16-256">需要時間來同步處理每個複本的變更。</span><span class="sxs-lookup"><span data-stu-id="84b16-256">It takes time to synchronize changes with every replica.</span></span> <span data-ttu-id="84b16-257">在這段期間，不同的分割區會包含不同的資料值。</span><span class="sxs-lookup"><span data-stu-id="84b16-257">During this period, different partitions will contain different data values.</span></span>

## <a name="application-design-considerations"></a><span data-ttu-id="84b16-258">應用程式設計考量</span><span class="sxs-lookup"><span data-stu-id="84b16-258">Application design considerations</span></span>

<span data-ttu-id="84b16-259">資料分割會增加系統設計和開發的複雜度。</span><span class="sxs-lookup"><span data-stu-id="84b16-259">Partitioning adds complexity to the design and development of your system.</span></span> <span data-ttu-id="84b16-260">即使系統一開始只包含單一分割區，也請考慮將資料分割視為系統設計的基本部分。</span><span class="sxs-lookup"><span data-stu-id="84b16-260">Consider partitioning as a fundamental part of system design even if the system initially only contains a single partition.</span></span> <span data-ttu-id="84b16-261">如果您事後才處理資料分割，因為您已經有需要維護的即時系統，因此更具挑戰性：</span><span class="sxs-lookup"><span data-stu-id="84b16-261">If you address partitioning as an afterthought, it will be more challenging because you already have a live system to maintain:</span></span>

- <span data-ttu-id="84b16-262">需要修改資料存取邏輯。</span><span class="sxs-lookup"><span data-stu-id="84b16-262">Data access logic will need to be modified.</span></span>
- <span data-ttu-id="84b16-263">可能需要遷移大量的現有資料，將資料分佈到分割區</span><span class="sxs-lookup"><span data-stu-id="84b16-263">Large quantities of existing data may need to be migrated, to distribute it across partitions</span></span>
- <span data-ttu-id="84b16-264">使用者期望可以在移轉期間繼續使用系統。</span><span class="sxs-lookup"><span data-stu-id="84b16-264">Users expect to be able to continue using the system during the migration.</span></span>

<span data-ttu-id="84b16-265">在某些情況下，資料分割並不重要，因為初始資料集很小，而且可以輕鬆地由單一伺服器處理。</span><span class="sxs-lookup"><span data-stu-id="84b16-265">In some cases, partitioning is not considered important because the initial dataset is small and can be easily handled by a single server.</span></span> <span data-ttu-id="84b16-266">對於部分工作負載來說可能是如此，但是許多商務系統需要隨著使用者數目增加而擴充。</span><span class="sxs-lookup"><span data-stu-id="84b16-266">This might be true for some workloads, but many commercial systems need to expand as the number of users increases.</span></span>

<span data-ttu-id="84b16-267">此外，不只有大型資料存放區受益於資料分割。</span><span class="sxs-lookup"><span data-stu-id="84b16-267">Moreover, it's not only large data stores that benefit from partitioning.</span></span> <span data-ttu-id="84b16-268">例如，數百個並行用戶端可能會大量存取一個小型資料存放區。</span><span class="sxs-lookup"><span data-stu-id="84b16-268">For example, a small data store might be heavily accessed by hundreds of concurrent clients.</span></span> <span data-ttu-id="84b16-269">在此情況下將資料分割可以協助減少爭用並提高輸送量。</span><span class="sxs-lookup"><span data-stu-id="84b16-269">Partitioning the data in this situation can help to reduce contention and improve throughput.</span></span>

<span data-ttu-id="84b16-270">當您設計資料分割配置時，應考慮下列幾點：</span><span class="sxs-lookup"><span data-stu-id="84b16-270">Consider the following points when you design a data partitioning scheme:</span></span>

<span data-ttu-id="84b16-271">**最小化跨分割區資料存取作業**。</span><span class="sxs-lookup"><span data-stu-id="84b16-271">**Minimize cross-partition data access operations**.</span></span> <span data-ttu-id="84b16-272">盡可能一併保留每個分割區中最常見資料庫作業的資料，以使跨分割區的資料存取作業減到最少。</span><span class="sxs-lookup"><span data-stu-id="84b16-272">Where possible, keep data for the most common database operations together in each partition to minimize cross-partition data access operations.</span></span> <span data-ttu-id="84b16-273">跨分割區查詢可能比在單一分割區內查詢更費時，但是最佳化一組查詢的分割區可能會對其他組的查詢造成不良影響。</span><span class="sxs-lookup"><span data-stu-id="84b16-273">Querying across partitions can be more time-consuming than querying within a single partition, but optimizing partitions for one set of queries might adversely affect other sets of queries.</span></span> <span data-ttu-id="84b16-274">如果您必須跨分割區查詢，可以在應用程式內執行平行查詢並彙總結果，來將查詢時間降至最低。</span><span class="sxs-lookup"><span data-stu-id="84b16-274">If you must query across partitions, minimize query time by running parallel queries and aggregating the results within the application.</span></span> <span data-ttu-id="84b16-275">(在某些情況下可能無法使用這種方法，例如，從某個查詢中取得的結果在下一個查詢使用時。)</span><span class="sxs-lookup"><span data-stu-id="84b16-275">(This approach might not be possible in some cases, such as when the result from one query is used in the next query.)</span></span>

<span data-ttu-id="84b16-276">**請考慮複寫靜態參考資料。**</span><span class="sxs-lookup"><span data-stu-id="84b16-276">**Consider replicating static reference data.**</span></span> <span data-ttu-id="84b16-277">如果查詢使用相對靜態的參考資料 (例如，郵遞區號資料表或產品清單)，請考慮將此資料複寫到所有分割區，以減少在不同分割區中個別查閱作業。</span><span class="sxs-lookup"><span data-stu-id="84b16-277">If queries use relatively static reference data, such as postal code tables or product lists, consider replicating this data in all of the partitions to reduce separate lookup operations in different partitions.</span></span> <span data-ttu-id="84b16-278">這種方法也會減少參考資料成為「熱門」資料集的可能性，具有整個系統中的高流量。</span><span class="sxs-lookup"><span data-stu-id="84b16-278">This approach can also reduce the likelihood of the reference data becoming a "hot" dataset, with heavy traffic from across the entire system.</span></span> <span data-ttu-id="84b16-279">不過，還是會有與同步處理此參考資料的任何變更相關聯的其他成本。</span><span class="sxs-lookup"><span data-stu-id="84b16-279">However, there is an additional cost associated with synchronizing any changes to the reference data.</span></span>

<span data-ttu-id="84b16-280">**最小化跨分割區聯結。**</span><span class="sxs-lookup"><span data-stu-id="84b16-280">**Minimize cross-partition joins.**</span></span> <span data-ttu-id="84b16-281">盡可能最小化跨垂直和功能分割區之參考完整性的需求。</span><span class="sxs-lookup"><span data-stu-id="84b16-281">Where possible, minimize requirements for referential integrity across vertical and functional partitions.</span></span> <span data-ttu-id="84b16-282">在這些配置中，應用程式會負責維護跨分割區的參考完整性。</span><span class="sxs-lookup"><span data-stu-id="84b16-282">In these schemes, the application is responsible for maintaining referential integrity across partitions.</span></span> <span data-ttu-id="84b16-283">跨多個分割區聯結資料的查詢效率不佳，因為應用程式通常必須先根據索引鍵，接著根據外部索引鍵來執行連續查詢。</span><span class="sxs-lookup"><span data-stu-id="84b16-283">Queries that join data across multiple partitions are inefficient because the application typically needs to perform consecutive queries based on a key and then a foreign key.</span></span> <span data-ttu-id="84b16-284">請改為考慮將相關資料複寫或取消正規化。</span><span class="sxs-lookup"><span data-stu-id="84b16-284">Instead, consider replicating or de-normalizing the relevant data.</span></span> <span data-ttu-id="84b16-285">如果需要跨分割區聯結，請在分割區之間執行平行查詢，並在應用程式內聯結資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-285">If cross-partition joins are necessary, run parallel queries over the partitions and join the data within the application.</span></span>

<span data-ttu-id="84b16-286">**擁有最終一致性**。</span><span class="sxs-lookup"><span data-stu-id="84b16-286">**Embrace eventual consistency**.</span></span> <span data-ttu-id="84b16-287"> 評估強式一致性是否為實際的需求。</span><span class="sxs-lookup"><span data-stu-id="84b16-287">Evaluate whether strong consistency is actually a requirement.</span></span> <span data-ttu-id="84b16-288">分散式系統中的常見方法是實作最終一致性。</span><span class="sxs-lookup"><span data-stu-id="84b16-288">A common approach in distributed systems is to implement eventual consistency.</span></span> <span data-ttu-id="84b16-289">每個分割區中的資料會個別更新，而應用程式邏輯可確保所有更新都會順利完成。</span><span class="sxs-lookup"><span data-stu-id="84b16-289">The data in each partition is updated separately, and the application logic ensures that the updates are all completed successfully.</span></span> <span data-ttu-id="84b16-290">它也會在執行最終一致性作業時，處理查詢資料所引發的不一致性。</span><span class="sxs-lookup"><span data-stu-id="84b16-290">It also handles the inconsistencies that can arise from querying data while an eventually consistent operation is running.</span></span>

<span data-ttu-id="84b16-291">**請考慮查詢如何尋找正確的分割區**。</span><span class="sxs-lookup"><span data-stu-id="84b16-291">**Consider how queries locate the correct partition**.</span></span> <span data-ttu-id="84b16-292">如果查詢必須掃描所有分割區來尋找所需的資料，即使是有多個平行查詢正在執行，還是會對效能產生嚴重的影響。</span><span class="sxs-lookup"><span data-stu-id="84b16-292">If a query must scan all partitions to locate the required data, there is a significant impact on performance, even when multiple parallel queries are running.</span></span> <span data-ttu-id="84b16-293">搭配垂直和功能資料分割策略使用的查詢可以自然指定分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-293">With vertical and functional partitioning, queries can naturally specify the partition.</span></span> <span data-ttu-id="84b16-294">但另一方面，水平資料分割會使得尋找項目變得困難，因為每個分區都有相同的結構描述。</span><span class="sxs-lookup"><span data-stu-id="84b16-294">Horizontal partitioning, on the other hand, can make locating an item difficult, because every shard has the same schema.</span></span> <span data-ttu-id="84b16-295">典型解決方案是維護對應，用來查閱特定資料項目的分區位置。</span><span class="sxs-lookup"><span data-stu-id="84b16-295">A typical solution to maintain a map that is used to look up the shard location for specific items.</span></span> <span data-ttu-id="84b16-296">此對應會在應用程式的分區化邏輯中實作，或者如果它支援透明的分區化，就會由資料存放區維護。</span><span class="sxs-lookup"><span data-stu-id="84b16-296">This map can be implemented in the sharding logic of the application, or maintained by the data store if it supports transparent sharding.</span></span>

<span data-ttu-id="84b16-297">**請考慮定期重新平衡分區**。</span><span class="sxs-lookup"><span data-stu-id="84b16-297">**Consider periodically rebalancing shards**.</span></span> <span data-ttu-id="84b16-298">使用水平資料分割，重新平衡分區有助於根據大小和工作負載來平均分佈資料，進而最小化作用點、最大化查詢效能，並解決實體的儲存體限制。</span><span class="sxs-lookup"><span data-stu-id="84b16-298">With horizontal partitioning, rebalancing shards can help distribute the data evenly by size and by workload to minimize hotspots, maximize query performance, and work around physical storage limitations.</span></span> <span data-ttu-id="84b16-299">不過，這是一個複雜的工作，通常需要使用自訂工具或程序。</span><span class="sxs-lookup"><span data-stu-id="84b16-299">However, this is a complex task that often requires the use of a custom tool or process.</span></span>

<span data-ttu-id="84b16-300">**複寫資料分割。**</span><span class="sxs-lookup"><span data-stu-id="84b16-300">**Replicate partitions.**</span></span> <span data-ttu-id="84b16-301">如果您複寫每個分割區，就能提供額外的保護以防止發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="84b16-301">If you replicate each partition, it provides additional protection against failure.</span></span> <span data-ttu-id="84b16-302">如果單一複本失敗，查詢可以導向至可用的複本。</span><span class="sxs-lookup"><span data-stu-id="84b16-302">If a single replica fails, queries can be directed towards a working copy.</span></span>

<span data-ttu-id="84b16-303">**如果您達到資料分割策略的實體限制，您可能必須將延展性擴充至不同層級**。</span><span class="sxs-lookup"><span data-stu-id="84b16-303">**If you reach the physical limits of a partitioning strategy, you might need to extend the scalability to a different level**.</span></span> <span data-ttu-id="84b16-304">例如，如果資料分割是在資料庫層級，您可能需要尋找或複寫多個資料庫中的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-304">For example, if partitioning is at the database level, you might need to locate or replicate partitions in multiple databases.</span></span> <span data-ttu-id="84b16-305">如果資料分割已經在資料庫層級，而且發生實體限制的問題，可能表示您需要尋找或複寫多個裝載帳戶中的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-305">If partitioning is already at the database level, and physical limitations are an issue, it might mean that you need to locate or replicate partitions in multiple hosting accounts.</span></span>

<span data-ttu-id="84b16-306">**避免在多個分割區中存取資料的交易**。</span><span class="sxs-lookup"><span data-stu-id="84b16-306">**Avoid transactions that access data in multiple partitions**.</span></span> <span data-ttu-id="84b16-307">某些資料存放區會為了修改資料的作業而實作交易一致性和完整性，但唯有當資料位於單一分割區時才如此。</span><span class="sxs-lookup"><span data-stu-id="84b16-307">Some data stores implement transactional consistency and integrity for operations that modify data, but only when the data is located in a single partition.</span></span> <span data-ttu-id="84b16-308">如果您需要跨多個分割區的交易式支援，您可能必須實作此支援做為應用程式邏輯的一部分，因為大部分的資料分割系統不會提供原生支援。</span><span class="sxs-lookup"><span data-stu-id="84b16-308">If you need transactional support across multiple partitions, you will probably need to implement this as part of your application logic because most partitioning systems do not provide native support.</span></span>

<span data-ttu-id="84b16-309">所有資料存放區都需要某些作業管理和監視活動。</span><span class="sxs-lookup"><span data-stu-id="84b16-309">All data stores require some operational management and monitoring activity.</span></span> <span data-ttu-id="84b16-310">工作的範圍可包含載入資料、備份和還原資料、重新組織資料，以及確保系統正確、有效率地執行。</span><span class="sxs-lookup"><span data-stu-id="84b16-310">The tasks can range from loading data, backing up and restoring data, reorganizing data, and ensuring that the system is performing correctly and efficiently.</span></span>

<span data-ttu-id="84b16-311">請考慮下列會影響作業管理的因素：</span><span class="sxs-lookup"><span data-stu-id="84b16-311">Consider the following factors that affect operational management:</span></span>

- <span data-ttu-id="84b16-312">**對分割資料時，如何實作適當的管理和操作工作**。</span><span class="sxs-lookup"><span data-stu-id="84b16-312">**How to implement appropriate management and operational tasks when the data is partitioned**.</span></span> <span data-ttu-id="84b16-313">這些工作可能包括備份與還原、封存資料、監視系統，以及其他管理工作。</span><span class="sxs-lookup"><span data-stu-id="84b16-313">These tasks might include backup and restore, archiving data, monitoring the system, and other administrative tasks.</span></span> <span data-ttu-id="84b16-314">例如，在備份和還原作業期間維護邏輯一致性是一項挑戰。</span><span class="sxs-lookup"><span data-stu-id="84b16-314">For example, maintaining logical consistency during backup and restore operations can be a challenge.</span></span>

- <span data-ttu-id="84b16-315">**如何將資料載入多個分割區，並新增從其他來源送達的新資料**。</span><span class="sxs-lookup"><span data-stu-id="84b16-315">**How to load the data into multiple partitions and add new data that's arriving from other sources**.</span></span> <span data-ttu-id="84b16-316">某些工具和公用程式可能不支援分區化資料作業，例如，將資料載入正確的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-316">Some tools and utilities might not support sharded data operations such as loading data into the correct partition.</span></span>

- <span data-ttu-id="84b16-317">**如何定期封存及刪除資料**。</span><span class="sxs-lookup"><span data-stu-id="84b16-317">**How to archive and delete the data on a regular basis**.</span></span> <span data-ttu-id="84b16-318">若要防止分割區過度成長，您必須定期 (也許是每月) 封存及刪除資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-318">To prevent the excessive growth of partitions, you need to archive and delete data on a regular basis (perhaps monthly).</span></span> <span data-ttu-id="84b16-319">可能需要轉換資料，以符合不同的封存結構描述。</span><span class="sxs-lookup"><span data-stu-id="84b16-319">It might be necessary to transform the data to match a different archive schema.</span></span>

- <span data-ttu-id="84b16-320">**如何找出資料完整性問題**。</span><span class="sxs-lookup"><span data-stu-id="84b16-320">**How to locate data integrity issues**.</span></span> <span data-ttu-id="84b16-321">請考慮定期執行程序以尋找任何資料完整性問題，例如，某一個分割區中的資料會參考另一個分割區中遺失的資訊。</span><span class="sxs-lookup"><span data-stu-id="84b16-321">Consider running a periodic process to locate any data integrity issues, such as data in one partition that references missing information in another.</span></span> <span data-ttu-id="84b16-322">此程序可嘗試自動修正這些問題，或是只產生報告供手動檢閱。</span><span class="sxs-lookup"><span data-stu-id="84b16-322">The process can either attempt to fix these issues automatically or simply generate a report for manual review.</span></span>

## <a name="rebalancing-partitions"></a><span data-ttu-id="84b16-323">重新平衡分割區</span><span class="sxs-lookup"><span data-stu-id="84b16-323">Rebalancing partitions</span></span>

<span data-ttu-id="84b16-324">隨著系統成熟，您可能必須調整資料分割配置。</span><span class="sxs-lookup"><span data-stu-id="84b16-324">As a system matures, you might have to adjust the partitioning scheme.</span></span> <span data-ttu-id="84b16-325">例如，個別的分割區可能開始有不當比例的流量並變得熱門，導致過度爭用。</span><span class="sxs-lookup"><span data-stu-id="84b16-325">For example, individual partitions might start get a disproportionate volume of traffic and become hot, leading to excessive contention.</span></span> <span data-ttu-id="84b16-326">或者您可能低估某些分割區中的資料量，導致某些分割區達到容量限制。</span><span class="sxs-lookup"><span data-stu-id="84b16-326">Or you might have underestimated the volume of data in some partitions, causing some partitions to approach capacity limits.</span></span>

<span data-ttu-id="84b16-327">某些資料存放區 (例如 Cosmos DB) 會自動重新平衡分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-327">Some data stores, such as Cosmos DB, can automatically rebalance partitions.</span></span> <span data-ttu-id="84b16-328">在其他情況下，重新平衡是由兩個階段組成的系統管理工作：</span><span class="sxs-lookup"><span data-stu-id="84b16-328">In other cases, rebalancing is an administrative task that consists of two stages:</span></span>

1. <span data-ttu-id="84b16-329">判斷新的資料分割策略。</span><span class="sxs-lookup"><span data-stu-id="84b16-329">Determine a new partitioning strategy.</span></span>

    - <span data-ttu-id="84b16-330">哪些分割區必須劃分 (或可能必須結合)？</span><span class="sxs-lookup"><span data-stu-id="84b16-330">Which partitions need to be split (or possibly combined)?</span></span>
    - <span data-ttu-id="84b16-331">新的分割區索引鍵是什麼？</span><span class="sxs-lookup"><span data-stu-id="84b16-331">What is the new partition key?</span></span>

2. <span data-ttu-id="84b16-332">將資料從舊的資料分割配置遷移至一組新的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-332">Migrate data from the old partitioning scheme to the new set of partitions.</span></span>

<span data-ttu-id="84b16-333">根據資料存放區的不同，您可以在分割區正在使用中時，在它們之間遷移資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-333">Depending on the data store, you might be able to migrate data between partitions while they are in use.</span></span> <span data-ttu-id="84b16-334">這就是所謂的「線上移轉」。</span><span class="sxs-lookup"><span data-stu-id="84b16-334">This is called *online migration*.</span></span> <span data-ttu-id="84b16-335">如果此方法不可行，您可能必須在重新定位資料時讓分割區暫時無法使用 (「離線移轉」)。</span><span class="sxs-lookup"><span data-stu-id="84b16-335">If that's not possible, you might need to make partitions unavailable while the data is relocated (*offline migration*).</span></span>

### <a name="offline-migration"></a><span data-ttu-id="84b16-336">離線移轉</span><span class="sxs-lookup"><span data-stu-id="84b16-336">Offline migration</span></span>

<span data-ttu-id="84b16-337">離線移轉一般來說是較簡單的方法，因為它可以減少發生爭用的機會。</span><span class="sxs-lookup"><span data-stu-id="84b16-337">Offline migration is generally simpler, because it reduces the chances of contention occurring.</span></span> <span data-ttu-id="84b16-338">就概念而言，離線移轉的運作方式如下所示：</span><span class="sxs-lookup"><span data-stu-id="84b16-338">Conceptually, offline migration works as follows:</span></span>

1. <span data-ttu-id="84b16-339">將分割區標示為離線。</span><span class="sxs-lookup"><span data-stu-id="84b16-339">Mark the partition offline.</span></span>
2. <span data-ttu-id="84b16-340">劃分-合併資料，並將其移到新的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-340">Split-merge and move the data to the new partitions.</span></span>
3. <span data-ttu-id="84b16-341">驗證資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-341">Verify the data.</span></span>
4. <span data-ttu-id="84b16-342">讓新的分割區上線。</span><span class="sxs-lookup"><span data-stu-id="84b16-342">Bring the new partitions online.</span></span>
5. <span data-ttu-id="84b16-343">移除舊的分割區。</span><span class="sxs-lookup"><span data-stu-id="84b16-343">Remove the old partition.</span></span>

<span data-ttu-id="84b16-344">(選擇性) 您可以在步驟 1 中將分割區標示為唯讀，讓應用程式在資料移動時，仍然可以讀取資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-344">Optionally, you can mark a partition as read-only in step 1, so that applications can still read the data while it is being moved.</span></span>

## <a name="online-migration"></a><span data-ttu-id="84b16-345">線上移轉</span><span class="sxs-lookup"><span data-stu-id="84b16-345">Online migration</span></span>

<span data-ttu-id="84b16-346">線上移轉執行上較複雜，但是比較不會受到干擾。</span><span class="sxs-lookup"><span data-stu-id="84b16-346">Online migration is more complex to perform but less disruptive.</span></span> <span data-ttu-id="84b16-347">其程序與離線移轉相似，不同之處在於原始分割區未標示為離線。</span><span class="sxs-lookup"><span data-stu-id="84b16-347">The process is similar to offline migration, except the original partition is not marked offline.</span></span> <span data-ttu-id="84b16-348">根據移轉程序的細微性 (例如，逐項目與逐分區)，用戶端應用程式中的資料存取程式碼可能必須處理保留在兩個位置 (原始分割區和新分割區) 中之資料的讀取和寫入。</span><span class="sxs-lookup"><span data-stu-id="84b16-348">Depending on the granularity of the migration process (for example, item by item versus shard by shard), the data access code in the client applications might have to handle reading and writing data that's held in two locations, the original partition and the new partition.</span></span>

## <a name="related-patterns"></a><span data-ttu-id="84b16-349">相關的模式</span><span class="sxs-lookup"><span data-stu-id="84b16-349">Related patterns</span></span>

<span data-ttu-id="84b16-350">下列設計模式可能會與您的案例相關：</span><span class="sxs-lookup"><span data-stu-id="84b16-350">The following design patterns might be relevant to your scenario:</span></span>

- <span data-ttu-id="84b16-351">[分區化模式](../patterns/sharding.md)說明一些分區化資料的常見策略。</span><span class="sxs-lookup"><span data-stu-id="84b16-351">The [sharding pattern](../patterns/sharding.md) describes some common strategies for sharding data.</span></span>

- <span data-ttu-id="84b16-352">[索引資料表模式](../patterns/index-table.md)示範如何建立資料的次要索引。</span><span class="sxs-lookup"><span data-stu-id="84b16-352">The [index table pattern](../patterns/index-table.md) shows how to create secondary indexes over data.</span></span> <span data-ttu-id="84b16-353">應用程式可以使用未參考集合的主索引鍵的查詢，透過這個方法快速擷取資料。</span><span class="sxs-lookup"><span data-stu-id="84b16-353">An application can quickly retrieve data with this approach, by using queries that do not reference the primary key of a collection.</span></span>

- <span data-ttu-id="84b16-354">[具體化檢視模式](../patterns/materialized-view.md)說明如何產生預先填入的檢視，可摘要列出資料以支援快速查詢作業。</span><span class="sxs-lookup"><span data-stu-id="84b16-354">The [materialized view pattern](../patterns/materialized-view.md) describes how to generate pre-populated views that summarize data to support fast query operations.</span></span> <span data-ttu-id="84b16-355">如果包含已摘要列出之資料的分割區會跨多個網站分佈，則這個方法對分割的資料存放區很有幫助。</span><span class="sxs-lookup"><span data-stu-id="84b16-355">This approach can be useful in a partitioned data store if the partitions that contain the data being summarized are distributed across multiple sites.</span></span>

## <a name="next-steps"></a><span data-ttu-id="84b16-356">後續步驟</span><span class="sxs-lookup"><span data-stu-id="84b16-356">Next steps</span></span>

- <span data-ttu-id="84b16-357">深入了解特定 Azure 服務的資料分割策略。</span><span class="sxs-lookup"><span data-stu-id="84b16-357">Learn about partitioning strategies for specific Azure services.</span></span> <span data-ttu-id="84b16-358">請參閱[資料分割策略](./data-partitioning-strategies.md)</span><span class="sxs-lookup"><span data-stu-id="84b16-358">See [Data partitioning strategies](./data-partitioning-strategies.md)</span></span>

[Azure 儲存體的延展性與效能目標]: /azure/storage/storage-scalability-targets
[Azure Storage Scalability and Performance Targets]: /azure/storage/storage-scalability-targets
