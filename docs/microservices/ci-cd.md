---
title: 微服務的 CI/CD
description: 微服務的持續整合與持續傳遞。
author: MikeWasson
ms.date: 10/23/2018
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: microservices
ms.openlocfilehash: 026d22bb9cfdcb69b1a12294410af748e7af5c39
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/23/2019
ms.locfileid: "54480788"
---
# <a name="designing-microservices-continuous-integration"></a>設計微服務：持續整合

持續整合與持續傳遞 (CI/CD) 是透過微服務獲得成功的關鍵需求。 若沒有完善的 CI/CD 程序，您就無法達到微服務所承諾的靈活度。 微服務的某些 CI/CD 挑戰是來自於各種服務的多個程式碼基底及各式各樣的建置環境。 本章描述一些挑戰，並建議可解決問題的一些方法。

![微服務的 CI/CD 圖](./images/ci-cd.png)

更快速的發行週期是採用微服務架構的最大原因之一。

純粹單體式應用程式中有一個建置管線，其輸出是應用程式可執行檔。 所有開發工作都會饋送到此管線中。 如果發現高優先順序的錯誤 (bug)，則必須整合、測試及發行修正程式，這可能會延遲新功能的發行。 您的確可藉由擁有構造良好的模組以及使用功能分支來緩和這些問題，進而將程式碼變更的影響降到最低。 但隨著應用程式日益複雜，並新增了更多功能，單體的發行程序就變得更加脆弱並可能中斷。

根據微服務的原理，絕不會有每個小組都必須排隊的冗長發行序列。 建立服務 "A" 的小組可以隨時發行更新，而不需等待服務 "B" 的變更來進行合併、測試和部署。 CI/CD 程序是達成此目的的關鍵。 發行管線必須自動化且高度可靠，才能將部署更新的風險降到最低。 如果您是每天或一天多次地對生產環境進行發行，則退回或服務中斷的狀況必定要非常罕見。 同時，如果部署了錯誤的更新，您必須有可靠的方法能快速復原或向前復原至舊版的服務。

![CI/CD 整合型的圖表](./images/cicd-monolith.png)

當我們談論 CI/CD 時，我們實際會談論數個相關程序：持續整合、持續傳遞和持續部署。

- 持續整合意味著程式碼變更經常會併入主要分支中，使用自動化建置和測試程序來確保主要分支中的程式碼一律具有良好的生產品質。

- 持續傳遞意味著傳遞 CI 程序的程式碼變更會自動發佈到類似生產的環境。 部署至即時生產環境可能需要手動核准，除此之外皆是自動化作業。 這麼做的目的是，您的程式碼應該總是「準備好」部署到生產環境。

- 持續部署意味著傳遞 CI/CD 程序的程式碼變更會自動發佈到生產環境中。

在 Kubernetes 和微服務的內容中，CI 階段涉及建立和測試容器映像，並將這些映像推送到容器登錄。 在部署階段中，pod 規格會進行更新，以取得最新的生產映像。

## <a name="challenges"></a>挑戰

- **許多小型獨立的程式碼基底**。 每個小組需利用自己的建置管線，負責建立自己的服務。 在某些組織中，小組可以使用不同的程式碼存放庫。 這可能會導致一個情況，就是如何建置系統的知識已散佈到各小組，但組織中沒有人知道如何部署整個應用程式。 例如，如果您需要快速部署到新的叢集，災害復原案例會發生什麼情況？

- **多個語言和架構**。 如果每個小組都使用自己的各項技術，則可能很難建立適用於整個組織的單一建置程序。 建置程序必須有足夠的彈性，每個小組才能針對其選擇的語言或架構進行調整。

- **整合及負載測試**。 如果小組依照自己的步調發行更新，則要設計強固的端對端測試可能具有挑戰性，特別是在服務相依於其他服務時。 此外，執行完整生產叢集可能很耗費資源，因此，如果只作為測試用，不太可能每個小組都能夠以生產規模執行自己的完整叢集。

- **發行管理**。 每個小組應該都要能夠將更新部署到生產環境。 但這不表示每個小組成員都有權限這麼做。 不過，擁有集中的發行管理員角色可能會降低部署的速度。 因此您的 CI/CD 程序愈加自動化和可靠，中央授權的需求就愈低。 儘管如此，您可能使用不同的原則來發行主要功能更新和次要錯誤修正。 分散管理並不表示就是零治理。

- **容器映像版本控制**。 在開發和測試週期內，CI/CD 程序將會建立許多容器映像。 其中只有一些映像是發行候選項目，然而只有其中一些發行候選項目會推送到生產環境中。 您應該有明確的版本控制策略，好讓您知道哪些映像目前已部署至生產環境，而且可以視需要復原至先前的版本。

- **服務更新**。 當您將服務更新為新版本時，其不得中斷與其相依的其他服務。 如果您執行輪流更新，則會有一段時間執行混合的版本。

這些挑戰反映出主要壓力。 一方面，小組必須盡可能獨立運作。 另一方面則需要一些協調，以便單一人員執行一些工作，例如執行整合測試、將整個解決方案重新部署到新叢集，或復原錯誤的更新。

## <a name="cicd-approaches-for-microservices"></a>微服務的 CI/CD 方法

每個服務小組最好能將其建置環境容器化。 此容器應具有為其服務建立程式碼成品所需的所有建置工具。 您通常可以找到您語言和架構的正式 Docker 映像。 然後您可以使用 `docker run` 或 Docker Compose 來執行組建。

使用此方法時，設定新建置環境是件小事。 為您建立程式碼的開發人員並不需要安裝一組建置工具，只要執行容器映像即可。 可能更重要的是，您的組建伺服器可設定為執行相同的動作。 這樣一來，您就不需要將這些工具安裝到組建伺服器，或管理衝突的工具版本。

進行本機開發和測試時，可使用 Docker 在容器內執行服務。 在此程序中，您可能需要執行其他容器，因為這些容器具有本機測試所需的模擬服務或測試資料庫。 您可以使用 Docker Compose 來協調這些容器，或使用 Minikube 在本機執行 Kubernetes。

備妥程式碼時，發起提取要求並且併入主檔中。 這會在組建伺服器上啟動一項作業：

1. 建置程式碼資產。
2. 對程式碼執行單元測試。
3. 建置容器映像。
4. 在執行中的容器上執行功能測試，以測試容器映像。 此步驟可以攔截 Docker 檔案中的錯誤，例如錯誤的進入點。
5. 將映像推送至容器登錄。
6. 使用新的映像來更新測試叢集，以執行整合測試。

當映像準備好移入生產環境時，請視需要更新部署檔案，以指定最新的映像，包括任何 Kubernetes 設定檔。 然後將更新套用到生產叢集。

以下是讓部署更可靠的一些建議：

- 為部署到叢集 (Pod、服務等等) 的資源，定義容器標籤、版本控制和命名慣例的組織通用慣例。 這可讓您更輕鬆地診斷部署問題。

- 建立兩個不同的容器登錄，一個用於開發/測試，一個用於生產。 在您準備好將映像部署到生產環境之前，請勿將它推送到生產登錄。 如果您結合這種做法與容器映像的語意版本控制，就能盡量避免意外部署到未獲准發行的版本。

## <a name="updating-services"></a>更新服務

有各種策略可用來更新已在生產環境中的服務。 我們在此討論三個常見的選項：輪流更新、藍綠色部署和 Canary 版本。

### <a name="rolling-update"></a>輪流更新

在輪流更新中，您會部署新的服務執行個體，而新的執行個體會立刻開始接收要求。 隨著新執行個體的出現，系統會移除先前的執行個體。

當您更新部署的 pod 規格時，輪流更新是 Kubernetes 中的預設行為。 部署控制器會為已更新的 pod 建立新的 ReplicaSet。 然後它會相應增加新的 ReplicaSet，同時相應減少舊的 ReplicaSet，以維持所需的複本計數。 在新的 pod 備妥之前，舊的 pod 不會遭到刪除。 Kubernetes 會保存更新歷程記錄，因此您可以視需要使用 kubectl 來復原更新。

如果您的服務執行長時間的啟動工作，您可以定義整備探查。 當容器準備好開始接收流量時，就會回報整備探查。 在探查回報成功之前，Kubernetes 不會將流量傳送至 pod。

輪流更新的其中一項挑戰就是在更新過程中，新舊版本會混合執行及接收流量。 在這段期間，所有要求會路由傳送至任一個版本。 根據兩個版本之間的變動範圍而定，這或許可能會造成問題。

### <a name="blue-green-deployment"></a>藍綠部署

在藍綠色部署中，您可以一起部署新版本與前一個版本。 在您驗證新版本之後，立刻將所有流量從前一個版本切換到新版本。 切換之後，您可監視應用程式是否有任何問題。 如果發生錯誤，您可以換回舊版本。 假設沒有任何問題，您可以刪除舊版本。

使用更傳統的單體式或多層式架構應用程式，藍綠部署通常是指佈建兩個相同的環境。 您會將新版本部署到預備環境，然後將用戶端流量重新導向至預備環境 &mdash; 例如，藉由交換 VIP 位址。

在 Kubernetes 中，您不需佈建個別的叢集來進行藍綠部署。 您反而可以利用選取器。 利用新的 pod 規格和一組不同的標籤，建立新的部署資源。 建立此部署，而不需刪除先前的部署，或修改指向它的服務。 當新的 pod 執行時，您可以更新服務的選取器，以符合新的部署。

藍綠部署的優點是服務可同時切換所有 pod。 更新此服務後，所有新的要求都會路由傳送至新的版本。 但有一個缺點，在更新期間您會對服務執行兩倍的 pod 數目 (目前和下一個)。 如果 pod 需要大量 CPU 或記憶體資源，您可能需要暫時相應放大叢集，以處理資源耗用。

### <a name="canary-release"></a>Canary 版本

在 Canary 版本中，您會向少數用戶端推出更新的版本。 然後您會先監視新服務的行為，然後再向所有的用戶端推出該服務。 這可讓您以控制方式進行緩慢推出、觀察實際資料，以及在所有客戶受影響之前找出問題。

Canary 版本的管理比藍綠或輪流更新更複雜，因為您必須動態將要求路由傳送到不同的服務版本。 在 Kubernetes 中，您可以將服務設定為橫跨兩個複本集 (每個版本各一個) 並手動調整複本計數。 不過，此方法會因為 Kubernetes 在 pod 間進行平衡負載的方式而顯得相當粗糙。 例如，如果總計有十個複本，您只可透過 10% 的增量轉換流量。 如果您使用服務網格，則可以使用服務網格路由規則，實作更精緻的 Canary 版本策略。 以下是一些可能有所幫助的資源：

- 沒有服務網格的 Kubernetes：[Canary 部署](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)
- Linkerd：[動態要求路由](https://linkerd.io/features/routing/)
- Istio：[使用 Istio 的 Canary 部署](https://istio.io/blog/canary-deployments-using-istio.html)

## <a name="conclusion"></a>結論

近年來，產業經歷大幅變動，從建置「記錄系統」移向建置「協作系統」。

記錄系統是傳統的後台資料管理應用程式。 這些系統的核心通常有 RDBMS，而這是單一資料來源。 「協作系統」一詞出自 Geoffrey Moore 在其 2011 年發表的 Systems of Engagement and the Future of Enterprise IT 論文中。 協作系統是著重於溝通和共同作業的應用程式。 這類系統可即時聯繫人員。 必須全天候可供使用。 定期引進新功能，且應用程式不需離線。 因此，使用者的期望更高，且對於非預期的延遲或停機更沒有耐心。

在取用者領域中，較佳的使用者體驗可能帶來可衡量的商務價值。 使用者使用應用程式的時間量可能會直接轉換成營收。 而且在商務系統的領域中，使用者的期望已改變。 如果這些系統致力於促進溝通和共同作業，則必須從取用者面向的應用程式取得其提示。

微服務回應了此不斷變動的情勢。 將單體式應用程式分解成鬆散偶合的服務群組，我們可以控制每項服務的發行週期，並能夠頻繁更新，而不需要停機或重大變更。 微服務也有助於延展性、失敗隔離和復原。 同時，雲端平台可自動佈建計算資源、容器即服務，以及事件驅動的無伺服器環境，讓您更輕鬆地建置和執行微服務。

但如我們所見，微服務架構也具有許多挑戰。 若要成功，您必須從堅實的設計著手。 您必須在分析網域、選擇技術、建立資料模型、設計 API，以及建立成熟的 DevOps 文化特性時深思熟慮。 我們希望這份指南以及隨附的[參考實作](https://github.com/mspnp/microservices-reference-implementation)，已協助您順利完成旅程。
