---
title: Azure IoT 參考架構
description: 使用 PaaS (平台即服務) 元件在 Azure 上建議的 IoT 應用程式架構
titleSuffix: Azure Reference Architectures
author: MikeWasson
ms.date: 01/09/2019
ms.openlocfilehash: 5a4b104044f3e64ffdce98e3952201d397d41f33
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58344575"
---
# <a name="azure-iot-reference-architecture"></a>Azure IoT 參考架構

此參考架構展示使用 PaaS (平台即服務) 元件在 Azure 上建議的 IoT 應用程式架構。

![架構圖](./_images/iot.png)

IoT 應用程式可以描述為**事項** (裝置)，傳送產生**深入解析**的資料。 這些深入解析會產生**動作**，以改善商務或流程。 一個例子是引擎 (事項) 傳送溫度資料。 這項資料用於評估引擎是否如預期般執行 (深入解析)。 深入解析用於主動排定引擎維修排程的優先順序 (動作)。

此參考架構使用 Azure PaaS (平台即服務) 元件。 在 Azure 上建置 IoT 解決方案的其他選項，包括：

- [Azure IoT Central](/azure/iot-central/)。 IoT Central 是完全受控的 SaaS (軟體即服務) 解決方案。 它會擷取技術選擇，讓您獨佔地專注於您的解決方案。 以 PaaS 為基礎的解決方案相比，這樣的簡單性會降低其可自訂性。
- 使用 OSS 元件，例如 SMACK堆疊 (Spark、Mesos、Akka、Cassandra、Kafka) 部署在 Azure VM 上。 這種方法提供了很多控制項，但是加複雜。

概括而言，有兩種方式可處理遙測資料、最忙碌路徑和非經常性路徑。 差異與對延遲和資料存取的要求有關。

- **最忙碌路徑**在到達時，會分析近乎即時的資料。 在最忙碌路徑中，必須以非常低的延遲處理遙測。 最忙碌路徑通常是使用串流處理引擎來實作。 輸出可能會觸發警示，或寫入可以使用分析工具查詢結構化的格式。
- **非經常性路徑**以較長的時間間隔 (每小時或每日) 執行批次處理。 非經常性路徑通常會運行大量資料，但結果不需要像最忙碌路徑一樣及時。 在非經常性路徑中，擷取未經處理的遙測，然後傳送至批次程序。

## <a name="architecture"></a>架構

此架構由下列元件組成。 有些應用程式可能不需要此處所列的每個元件。

**IoT 裝置**。 裝置可以安全地向雲端註冊，而且可以連線至雲端，以傳送和接收資料。 某些裝置可能是**邊緣裝置**，其在裝置本身或現場閘道中執行一些資料處理。 我們建議使用 [Azure IoT Edge](/azure/iot-edge/) 進行邊緣處理。

**雲端閘道**。 雲端閘道為裝置提供了一個雲端中樞，以便安全地連線到雲端並傳送資料。 它也會提供裝置管理和功能，包括裝置的命令與控制項。 對於雲端閘道，我們建議使用 [IoT 中樞](/azure/iot-hub/)。 IoT 中樞是一種託管雲端服務，會從裝置擷取事件，作為裝置與後端服務之間的訊息代理人。 IoT 中樞提供安全的連線能力、事件擷取、雙向通訊，以及裝置管理。

**裝置佈建IoT**。 對於註冊和連接大量裝置，我們建議使用 [IoT 中樞裝置佈建服務](/azure/iot-dps/) (DPS)。 DPS 可讓您大規模地將裝置指派和註冊至特定 Azure IoT 中樞端點。

**串流處理**。 串流處理分析大量資料記錄，並評估這些串流的規則。 對於串流處理，我們建議使用 [Azure 串流分析](/azure/stream-analytics/)。 串流分析可執行大規模的複雜分析、使用時間範圍函式、資料流彙總，以及外部資料來源聯結。 另一個選項是 [Azure Databricks](/azure/azure-databricks/) 上 Apache Spark。

機器學習允許在歷史遙測資料上執行預測演算法，以啟用如預測性維護等的案例。 對於機器學習，我們建議使用 [Azure Machine Learning 服務](/azure/machine-learning/service/)。

**經常性路徑儲存體**保存必須從裝置立即取得，以用於報告和視覺效果的資料。 對於經常性路徑儲存體，我們建議使用 [Cosmos DB](/azure/cosmos-db/introduction)。 Cosmos DB 是全域散發的多模型資料庫。

**非經常性路徑儲存體**保存長期保留的資料，並用於批次處理。 對於非經常性路徑儲存體，我們建議使用 [Azure Blob 儲存體](/azure/storage/blobs/storage-blobs-introduction)。 可以將資料無限期地以較低的成本封存在 Blob 儲存體中，並可以輕鬆存取以供批次處理。

**資料轉換**操縱或彙總遙測串流。 範例包括通訊協定轉換，例如將二進位資料轉換為 JSON，或結合資料點。 如果必須在到達 IoT 中樞之前轉換資料，我們建議使用[通訊協定閘道](/azure/iot-hub/iot-hub-protocol-gateway) (未顯示)。 否則，可以在到達 IoT 中樞之後再轉換資料。 在此情況下，我們建議使用 [Azure Functions](/azure/azure-functions/)。 Functions 已與 IoT 中樞、Cosmos DB 與 Blob 儲存體內建整合。

**企業處理整合**根據裝置資料的深入解析執行動作。 這可能包括儲存資訊訊息、引發警示、傳送電子郵件或簡訊，或與 CRM 整合。 我們建議使用 [Azure Logic Apps](/azure/logic-apps/logic-apps-overview) 進行企業處理整合。

**使用者管理**會限制哪些使用者或群組可以在裝置上執行動作，例如升級韌體。 它也會為應用程式中的使用者定義功能。 我們建議使用 [Azure Active Directory](/azure/active-directory/) 來驗證並授權使用者。

## <a name="scalability-considerations"></a>延展性考量

IoT 應用程式應建置為可獨立調整的離散服務。 請考慮下列延展性的點：

**IoTHub**。 對於 IoT 中樞，請考慮下列比例因素：

- IoT 中樞[每日配額](/azure/iot-hub/iot-hub-devguide-quotas-throttling)訊息的上限。
- IoT 中樞執行個體中已連線裝置的配額。
- 擷取輸送量 &mdash; IoT 中樞可以擷取訊息的速度。
- 處理輸送量 &mdash; 處理內送訊息的速度。

佈建每個 IoT 中樞時，都會為其佈建特定層級中的特定單位數。 層級和單位數會決定裝置每天可傳送至中樞的訊息配額上限。 如需詳細資訊，請參閱 IoT 中樞配額和節流。 您可以相應增加一個中樞，而不會中斷現有作業。

**串流分析**。 如果串流分析作業與串流分析管道 (從輸入到查詢再到輸出) 中的所有點為平行處理，則串流分析作業的擴展性最佳。 完全平行的作業允許串流分析橫跨多個計算節點來分割工作。 否則，串流分析必須將串流資料合併到一個地方。 如需詳細資訊，請參閱[利用 Azure 串流分析中的查詢平行化作業](/azure/stream-analytics/stream-analytics-parallelization)。

IoT 中樞根據裝置識別碼自動分割裝置訊息。 特定裝置的所有訊息一定會抵達相同的磁碟分割，但單一分割區將具有來自多個裝置的訊息。 因此，平行處理的單位是分割區識別碼。

**Functions**。 從事件中樞端點讀取時，每個事件中樞分割區最多有一個函式執行個體。 最快的處理速率取決於一個函式執行個體處理來自單一分割區事件的速度。 該函式應該批次處理訊息。

**Cosmos DB**。 若要擴充 Cosmos DB 集合，請使用分割區索引鍵建立集合，並在您寫入的每個文件中包含分割區索引鍵。 如需詳細資訊，請參閱[選擇分割區索引鍵時的最佳做法](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key)。

- 如果您為每個裝置儲存並更新單一文件時，裝置識別碼是很好的分割區索引鍵。 寫入資料已平均分散在索引鍵上。 嚴格限制每個分割區的大小，因為每個索引鍵的值都有一個文件。
- 如果您為每個裝置訊息儲存個別的文件，則使用裝置識別碼作為分割區索引鍵，會快速超過每個分割區 10 GB 的限制。 在這種情況下，訊息識別碼是更好的分割區索引鍵。 通常，您仍會在索引編製和查詢文件中包含裝置識別碼。

## <a name="security-considerations"></a>安全性考量

### <a name="trustworthy-and-secure-communication"></a>可信任和安全的通訊

從裝置接收和傳送的所有資訊都必須是可信任的。 除非裝置可支援下列密碼編譯功能，否則應限制為區域網路，並且所有網際網路通訊都應當透過現場閘道：

- 資料加密採用可證明安全、公開分析且廣泛實作的對稱金鑰加密演算法。
- 數位簽章採用可證明安全、公開分析且廣泛實作的對稱金鑰簽章演算法。
- 支援 TCP 的 TLS 1.2 或其他以資料流為基礎的通訊路徑，或 DTLS 1.2 以資料包為基礎的通訊路徑。 X.509 憑證處理的支援是選擇性的，可以替換為 TLS 的 的計算效率更高且網路效率預先共用金鑰模式，其可透過支援 AES 和 SHA-2 演算法來實作。
- 可更新的金鑰存放區和每一裝置索引鍵。 每個裝置必須有唯一的金鑰資料或權杖，以對系統識別該裝置。 裝置應將金鑰安全地儲存在裝置 (例如，使用安全金鑰存放區) 上。 裝置應能夠定期更新金鑰或權杖，或在緊急情況 (例如系統漏洞) 下進行反應。
- 必須允許裝置上的韌體和應用程式軟體進行更新，以便修復發現的安全性漏洞。

不過，許多裝置的限制太多而無法支援這些需求。 在此情況下，您應該使用現場閘道。 裝置透過區域網路安全地連線到現場閘道上，並且閘道可啟用與雲端的安全通訊。

### <a name="physical-tamper-proofing"></a>實體竄改校訂

強烈建議裝置設計納入防止實體操作嘗試的功能，以協助確保安全性完整性和整體系統的可信度。

例如︰

- 選擇提供安全的儲存體和使用密碼編譯金鑰內容的微控制器/微處理器或輔助硬體，例如信賴平台模組 (TPM) 整合。
- 保護開機載入器和軟體載入的安全，錨定在 TPM 中。
- 使用感應器偵測入侵嘗試，並嘗試透過裝置的警示和可能的「數位自我損毀」來操縱裝置環境。

如需額外的安全性考量，請參閱[物聯網 (IoT) 安全性架構](/azure/iot-fundamentals/iot-security-architecture)。

### <a name="monitoring-and-logging"></a>監視和記錄

記錄和監視系統是用來判斷解決方案是否正常運作，以及協助疑難排解問題。 監視和記錄系統可協助回答下列操作問題：

- 裝置或系統是否處於錯誤狀況？
- 是否已正確設定系統或裝置？
- 裝置或系統是否產生精確的資料？
- 系統是否滿足業務和最終客戶的期望？

記錄和監視工具通常包含下列四個元件：

- 系統效能與時間軸視覺效果工具，用來監視系統以及基本疑難排解。
- 緩衝資料擷取，以緩衝記錄資料。
- 持續性儲存區以儲存記錄資料。
- 搜尋和查詢功能，檢視記錄資料以用於詳細疑難排解。

監視系統會提供 IoT 解決方案的健康情況、安全性、穩定性和效能的深入解析。 這些系統也可以提供更詳細的檢視，記錄元件設定變更、提供可以呈現潛在安全性漏洞的擷取記錄資料、增強事件管理程序，並協助系統擁有者針對問題進行疑難排解。 完整的監視解決方案包含特定子系統或跨多個子系統彙總查詢資訊的能力。

監視系統開發應首先定義健全的作業、法規遵循和稽核要求。 收集的度量資訊可能包括：

- 實體裝置、邊緣裝置和基礎結構元件報表組態變更。
- 應用程式報表組態變更、安全性稽核記錄檔、要求率、回應時間、錯誤率和記憶體回收統計資料 (managed 語言)。
- 資料庫、持續性儲存區、快取報告查詢以及寫入效能、結構描述變更、安全性稽核記錄檔、鎖定或鎖死、索引效能、CPU、記憶體和磁碟使用量。
- 受管理的服務 (IaaS、PaaS、SaaS 及 FaaS) 報告影響相依系統健康情況和效能的健康情況度量與組態變更。

視覺效果的監視度量警示操作員系統不穩定並協助事件回應。

### <a name="tracing-telemetry"></a>追蹤遙測

追蹤遙測可讓操作員追蹤從建立到系統的遙測旅程。 追蹤對於偵錯和疑難排解很重要。 對於使用 Azure IoT 中樞的 IoT 解決方案和 [IoT 中樞裝置 SDK](/azure/iot-hub/iot-hub-devguide-sdks)，追蹤資料包可以產生為雲端到裝置訊息並包含在遙測資料流中。

### <a name="logging"></a>記錄

記錄系統是了解解決方案已執行哪些動作或活動、已發生失敗以及可提供協助修復這些失敗不可或缺的部分。 您可以分析記錄檔以協助了解和解決錯誤狀況、加強效能特性，並確保符合規範規則與規定。

雖然純文字記錄對前期開發成本的影響較小，但對於剖析/讀取機器來說更具挑戰性。 我們建議使用結構化記錄，因為收集的資訊是電腦可剖析和人類可讀取的資訊。 結構化記錄會將環境的內容和中繼資料加入至記錄資訊。 在結構化日誌記錄中，屬性是格式化為一對索引鍵/值的第一類公民，或具有固定的結構描述，以增強搜尋和查詢功能。

## <a name="next-steps"></a>後續步驟

- 如需建議的架構和實作選擇的詳細討論，請參閱 [Microsoft Azure IoT 參考架構](http://aka.ms/iotrefarchitecture) (PDF)。

- 如需各種 Azure IoT 服務的詳細文件，請參閱 [Azure IoT 基礎](/azure/iot-fundamentals/)。

- 範例 IoT 實作可以在 [GitHub](https://github.com/mspnp/iot-guidance) 上取得。
