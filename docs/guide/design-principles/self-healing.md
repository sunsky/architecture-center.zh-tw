---
title: 自我修復設計
titleSuffix: Azure Application Architecture Guide
description: 具有復原功能的應用程式無須手動介入即可從失敗中復原。
author: MikeWasson
ms.date: 08/30/2018
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seojan19
ms.openlocfilehash: 5e5af0be41fa892e490d556ef4286d5367144fd9
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58249503"
---
# <a name="design-for-self-healing"></a>自我修復設計

## <a name="design-your-application-to-be-self-healing-when-failures-occur"></a>將您的應用程式設計為可在發生失敗時自我修復

在分散式系統中，發生失敗在所難免。 硬體可能會失敗。 網路可能會暫時性失敗。 整個服務或區域很少會發生中斷，但即使如此仍必須加以規劃。

因此，請將應用程式設計為可在發生失敗時自我修復。 這種設計需要有蘊含三個面向的方法：

- 偵測失敗。
- 正常地回應失敗。
- 記錄和監視失敗，以提供作業方面的深入資訊。

該如何回應特定類型的失敗可能取決於您的應用程式可用性需求。 例如，如果您需要極高的可用性，您可以在發生區域性中斷的期間，自動容錯移轉到次要區域。 不過，這麼做的成本會比單一區域部署的成本高。

此外，請不要只是考慮重大事件 (例如區域性中斷)，這種事件一般很少發生。 您應該更加專注在處理當地的短期性失敗，例如網路連線失敗或資料庫連線失敗。

## <a name="recommendations"></a>建議

**重試失敗的作業**。 可能會因為暫時遺失網路連線、卸除資料庫連線或服務忙碌時的逾時而發生暫時性失敗。 請在應用程式中建置重試邏輯以處理暫時性失敗。 用戶端 SDK 會對許多 Azure 服務實作自動重試功能。 如需詳細資訊，請參閱[暫時性錯誤處理][transient-fault-handling]和[重試模式][retry]。

**保護失敗的遠端服務 (斷路器)**。 在發生暫時性失敗後進行重試是不錯的舉動，但如果失敗持續發生，最終的結果可能是會有無數的呼叫者不斷衝擊失敗的服務。 這可能會導致連鎖性失敗，因為要求會堵塞起來。 請使用[斷路器模式][circuit-breaker]，以在作業可能會失敗時快速檢錯 (而不進行遠端呼叫)。

**隔離重要的資源 (隔艙)**。 某個子系統發生失敗有時可能會產生連鎖反應。 如果失敗造成某些資源 (例如執行緒或通訊端) 無法即時釋出，而導致資源耗盡，就會發生這個情況。 為了避免這個問題，請將系統分割為隔離群組，讓一個分割區中的失敗不會使整個系統當機。

**執行負載調節**。 應用程式可能會突然出現流量尖峰，可能會在後端灌爆服務。 若要避免這個問題，請使用[佇列型負載調節模式][load-level]，將工作項目排入佇列進而以非同步方式執行。 佇列會作為消除負載尖峰的緩衝區。

**容錯移轉**。 如果有執行個體無法連線，請容錯移轉至其他執行個體。 對於無狀態的項目 (例如 Web 伺服器)，請在負載平衡器或流量管理員後面放置數個執行個體。 對於有儲存狀態的物件 (例如資料庫)，請使用複本並容錯移轉。 根據資料存放區和其複寫方式，這可能需要應用程式處理最終一致性。

**補償失敗的交易**。 一般來說，請避免分散式交易，因為這些交易會需要進行跨服務和資源的協調。 相反地，請撰寫從較小型的個別交易所進行的作業。 如果作業中途失敗，請使用[補償交易][compensating-transactions]來復原任何已完成的步驟。

**為長時間執行的交易設立檢查點**。 檢查點可以在長時間執行的作業失敗時提供復原功能。 當作業重新啟動時 (例如，有其他 VM 選擇了此作業)，它便可從最後一個檢查點繼續進行。

**正常降級**。 有時候您無法解決問題，但您可以提供仍然有用的精簡功能。 請考慮顯示書籍目錄的應用程式。 如果應用程式無法擷取封面的縮圖映像，它可能會顯示預留位置映像。 整個子系統對於應用程式來說可能不怎麼重要。 例如，在電子商務網站中，顯示產品建議可能就不如處理訂單來得重要。

**對用戶端節流**。 有時候一小撮的使用者會產生過大的負載，而讓您的應用程式提供給其他使用者的可用性變低。 在此情況下，請將該用戶端節流一段時間。 請參閱[節流模式][throttle]。

**封鎖不良執行者**。 對用戶端節流並不代表用戶端有惡意舉動。 這麼做只代表用戶端已超過其服務配額。 但是，如果用戶端持續超過其配額或另有不當行為，您可將其封鎖。 請定義頻外程序，以供使用者要求解除封鎖。

**使用選出領導者**。 當您需要協調工作時，請使用[選出領導者][leader-election]來選取協調器。 這樣一來，協調器就不會成為單一失敗點。 如果協調器失敗，系統會選取新的協調器。 請不要從頭開始實作選出領導者演算法，而是要考慮使用現成的解決方案，例如 Zookeeper。

**植入錯誤以進行測試**。 成功的路徑總是經過完善的測試，但失敗的路徑則不是。 系統可能會在生產環境中執行很久之後，才走到失敗的路徑。 請使用錯誤植入機制，以測試系統在遇到失敗時是否能復原，方法為觸發實際的失敗或模擬失敗。

**採用混沌工程**。 混沌工程延伸了錯誤植入的概念，它會在生產執行個體中隨機植入失敗或異常狀況。

如需有結構地讓您的應用程式能夠自我修復，請參閱[設計具有復原功能的 Azure 應用程式][resiliency-overview]。

<!-- links -->

[circuit-breaker]: ../../patterns/circuit-breaker.md
[compensating-transactions]: ../../patterns/compensating-transaction.md
[leader-election]: ../../patterns/leader-election.md
[load-level]: ../../patterns/queue-based-load-leveling.md
[resiliency-overview]: ../../resiliency/index.md
[retry]: ../../patterns/retry.md
[throttle]: ../../patterns/throttling.md
[transient-fault-handling]: ../../best-practices/transient-faults.md
