---
title: "同盟身分識別"
description: "將驗證委派給外部身分識別提供者。"
keywords: "設計模式"
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories: security
ms.openlocfilehash: a1edbdd080309383201d33e73602e2f18928c080
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/14/2017
---
# <a name="federated-identity-pattern"></a>同盟身分識別模式

[!INCLUDE [header](../_includes/header.md)]

將驗證委派給外部身分識別提供者。 這可以簡化開發流程、將使用者系統管理需求降到最低，以及改善使用者的應用程式體驗。

## <a name="context-and-problem"></a>內容和問題

使用者通常需要使用與他們有業務往來的不同組織所提供和裝載的應用程式。 系統可能會要求這些使用者針對每個應用程式使用特定 (且不同) 的認證。 這會：

- **造成使用者體驗不連貫**。 當使用者有許多不同的認證時，常常會忘記登入認證。

- **暴露安全性弱點**。 當使用者離職時，必須立即將其帳戶取消佈建。 在大型組織中很容易忽略這一點。

- **造成使用者管理複雜化**。 系統管理員必須管理所有使用者的認證並執行額外的工作，例如提供密碼提醒。

使用者通常偏好針對所有這些應用程式使用相同的認證。

## <a name="solution"></a>方案

實作可以使用同盟身分識別的驗證機制。 將使用者驗證與應用程式程式碼分開，然後將驗證委派給信任的身分識別提供者。 這可以簡化開發流程並可讓使用者使用更廣泛的身分識別提供者 (IdP) 來進行驗證，同時又可將系統管理額外負荷降到最低。 它也可讓您明確地將驗證與授權分離。

信任的身分識別提供者包括公司目錄、內部部署同盟服務、業務合作夥伴所提供的其他安全性權杖服務 (STS)，或是能夠驗證具有 Microsoft、Google、Yahoo! 或 Facebook 等帳戶之使用者的社交身分識別提供者。

下圖說明當用戶端應用程式需要存取要求驗證之服務時的「同盟身分識別」模式。 驗證會由與 STS 合作的 IdP 執行。 IdP 會簽發提供受驗證使用者相關資訊的安全性權杖。 這項資訊 (稱為宣告) 包含使用者的身分識別，也可能包含其他資訊，例如角色成員資格和更細微的存取權限。

![同盟驗證概觀](./_images/federated-identity-overview.png)


此模型通常稱為宣告型存取控制。 應用程式和服務會根據權杖所包含的宣告，授與對功能的存取權。 要求驗證的服務必須信任 IdP。 用戶端應用程式會聯繫執行驗證的 IdP。 如果驗證成功，IdP 就會傳回包含宣告的權杖，這些宣告可讓 STS (請注意，IdP 和 STS 可以是同一個服務) 識別使用者。 STS 可以根據預先定義的規則來轉換和擴大權杖中的宣告，然後再將權杖傳回給用戶端。 用戶端應用程式可以接著將此權杖傳遞給服務作為其身分識別的證明。

> 信任鏈結中可能會有其他 STS。 例如，在稍後提到的案例中，內部部署 STS 會信任另一個負責存取身分識別提供者以驗證使用者的 STS。 此方法在有內部部署 STS 和目錄的企業案例中相當常見。

同盟驗證提供一個跨各種網域簽發信任身分識別的標準型解決方案，並且可支援單一登入。 這在所有類型的應用程式中越來越常見，尤其是裝載於雲端的應用程式，因為它支援單一登入，而不需要透過網路直接連線到身分識別提供者。 使用者不需要針對每個應用程式輸入認證。 這可以提升安全性，因為無須建立存取許多不同應用程式所需的認證，同時也會向原始身分識別提供者以外的所有身分識別提供者隱藏使用者認證。 應用程式只會看到權杖內含的已驗證身分識別資訊。

同盟身分識別還有一項主要優點，就是由身分識別提供者負責管理身分識別和認證。 應用程式或服務不需要提供身分識別管理功能。 此外，在公司案例中，公司目錄如果信任身分識別提供者，就不需要知道使用者的相關資訊。 這可免除管理目錄內使用者身分識別的所有系統管理額外負荷。

## <a name="issues-and-considerations"></a>問題和考量

設計實作同盟驗證的應用程式時，請考量下列幾點：

- 驗證可能為單一失敗點。 如果您將應用程式部署至多個資料中心，請考慮將身分識別管理機制部署至相同的資料中心，以維持應用程式可靠性和可用性。

- 驗證工具可讓您根據驗證權杖內含的角色宣告來設定存取控制。 這通常稱為角色型存取控制 (RBAC)，可允許以更細微的方式控制對功能和資源的存取。

- 與公司目錄不同，使用社交身分識別提供者的宣告型驗證通常除了電子郵件地址及可能還有名稱之外，不提供受驗證使用者的相關資訊。 有些社交身分識別提供者 (例如 Microsoft 帳戶) 只提供唯一識別碼。 應用程式通常需要維護已註冊使用者的一些相關資訊，並且要能夠將此資訊與權杖中宣告內含的識別碼做比對。 一般而言，會在使用者第一次存取應用程式時，透過註冊執行此操作，然後在每次驗證後將資訊插入到權杖中作為額外的宣告。

- 如果為 STS 設定的身分識別提供者有多個，就必須偵測應該將使用者重新導向到哪一個身分識別提供者來進行驗證。 此程序稱為主領域探索。 STS 可能可以根據使用者提供的電子郵件地址或使用者名稱、使用者所存取之應用程式的子網域、使用者的 IP 位址範圍或儲存在使用者瀏覽器中的 Cookie 內容，自動執行此操作。 例如，如果使用者輸入 Microsoft 網域中的電子郵件地址 (例如 user@live.com)，STS 將會把使用者重新導向到 Microsoft 帳戶登入頁面。 在稍後瀏覽時，STS 可以使用 Cookie 來指出上次登入是使用 Microsoft 帳戶。 如果自動探索無法判斷主領域，STS 就會顯示主領域探索頁面，當中列出信任的身分識別提供者，使用者必須選取他們想要使用的身分識別提供者。

## <a name="when-to-use-this-pattern"></a>使用此模式的時機

此模式對於下列案例相當有用：

- **企業中的單一登入**。 在此案例中，您必須針對裝載在公司安全性界限外雲端中的公司應用程式驗證員工，而不要求他們每次瀏覽應用程式時都必須登入。 使用者體驗與使用內部部署應用程式時相同，其中使用者會在登入公司網路時進行驗證，之後便可存取所有相關的應用程式，而無須再次登入。

- **與多個合作夥伴搭配的同盟身分識別**。 在此案例中，您必須同時驗證公司員工和在公司目錄中沒有帳戶的業務合作夥伴。 這在企業對企業應用程式、與協力廠商服務整合的應用程式中，以及在擁有不同 IT 系統的公司具有合併或共用資源的情況中，都相當常見。

- **SaaS 應用程式中的同盟身分識別**。 在此案例中，獨立軟體廠商會為多個用戶端或租用戶提供一個已經可供使用的服務。 每個租用戶皆使用一個適當的身分識別提供者來進行驗證。 例如，企業用戶會使用其公司認證，而租用戶的取用者和用戶端則會使用其社交身分識別認證。

此模式在下列情況下可能不是很有用：

- 應用程式的所有使用者都可由一個身分識別提供者進行驗證，而無須使用任何其他身分識別提供者來進行驗證。 這在藉由 VPN 或 (在裝載於雲端的案例中) 透過內部部署目錄與應用程式之間的虛擬網路連線使用公司目錄 (可在應用程式內存取) 來進行驗證的商務應用程式中，是相當典型的情況。

- 應用程式原先是使用不同的驗證機制來建立的 (也許是使用自訂使用者存放區)，或無法處理宣告型技術所使用的交涉標準。 將宣告型驗證和存取控制整合至現有的應用程式中來加以改進可能相當複雜，而且可能不符合成本效益。

## <a name="example"></a>範例

組織將多租用戶的軟體即服務 (SaaS) 應用程式裝載於 Microsoft Azure 中。 此應用程式包含租用戶可用來針對自己的使用者管理應用程式的網站。 此應用程式可讓租用戶使用當使用者由該組織自己的 Active Directory 驗證時「Active Directory 同盟服務」(ADFS) 所產生的同盟身分識別來存取網站。

![大型企業訂閱者的使用者如何存取應用程式](./_images/federated-identity-multitenat.png)


下圖說明租用戶如何向自己的身分識別提供者 (在此案例中為 ADFS) 進行驗證 (步驟 1)。 成功驗證租用戶之後，ADFS 會簽發權杖。 用戶端瀏覽器會將此權杖轉送給 SaaS 應用程式的同盟提供者，此提供者會信任租用戶的 ADFS 所簽發的權杖，以取回一個對 SaaS 同盟提供者有效的權杖 (步驟 2)。 必要時，SaaS 同盟提供者會先將權杖中的宣告轉換成應用程式能夠辨識的宣告 (步驟 3)，然後才將新權杖傳回給用戶端瀏覽器。 應用程式會信任 SaaS 同盟提供者所簽發的權杖，然後使用權杖中的宣告來套用授權規則 (步驟 4)。

租用戶不須記住個別的認證即可存取應用程式，而租用戶公司的系統管理員則可以在自己的 ADFS 中設定可存取應用程式的使用者清單。

## <a name="related-guidance"></a>相關的指引

- [Microsoft Azure Active Directory](https://azure.microsoft.com/services/active-directory/)
- [Active Directory Domain Services](https://msdn.microsoft.com/library/bb897402.aspx)
- [Active Directory 同盟服務](https://msdn.microsoft.com/library/bb897402.aspx) \(英文\)
- [Microsoft Azure 中多租用戶應用程式的身分識別管理](https://azure.microsoft.com/documentation/articles/guidance-multitenant-identity/)
- [Azure 中的多租用戶應用程式](https://azure.microsoft.com/documentation/articles/dotnet-develop-multitenant-applications/)
