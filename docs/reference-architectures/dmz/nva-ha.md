---
title: 部署高可用性的網路虛擬設備
titleSuffix: Azure Reference Architectures
description: 部署具高可用性的網路虛擬設備。
author: telmosampaio
ms.date: 12/08/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seodec18, networking
ms.openlocfilehash: 18a8620d835488be7a3639e8fbde86f9f10f946c
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/20/2019
ms.locfileid: "58244989"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="3d670-103">部署高可用性的網路虛擬設備</span><span class="sxs-lookup"><span data-stu-id="3d670-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="3d670-104">本文會示範如何在 Azure 中部署一組網路虛擬設備 (NVA) 以取得高可用性。</span><span class="sxs-lookup"><span data-stu-id="3d670-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="3d670-105">NVA 通常是用來控制從周邊網路 (也稱為 DMZ) 流至其他網路或子網路之網路流量的流動。</span><span class="sxs-lookup"><span data-stu-id="3d670-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="3d670-106">若要了解如何在 Azure 中實作 DMZ，請參閱[Microsoft 雲端服務和網路安全性][cloud-security]。</span><span class="sxs-lookup"><span data-stu-id="3d670-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="3d670-107">本文包含「僅輸入」、「僅輸出」，以及「輸入和輸出」的範例架構。</span><span class="sxs-lookup"><span data-stu-id="3d670-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="3d670-108">**必要條件：** 本文假設您對 Azure 網路、[Azure 負載平衡器][lb-overview]，以及[使用者定義的路由][udr-overview] (UDR) 已具有基本的了解。</span><span class="sxs-lookup"><span data-stu-id="3d670-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="3d670-109">架構圖</span><span class="sxs-lookup"><span data-stu-id="3d670-109">Architecture diagrams</span></span>

<span data-ttu-id="3d670-110">NVA 可以部署到許多不同架構的 DMZ 中。</span><span class="sxs-lookup"><span data-stu-id="3d670-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="3d670-111">例如，下圖說明針對輸入使用[單一 NVA][nva-scenario] 的方式。</span><span class="sxs-lookup"><span data-stu-id="3d670-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="3d670-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="3d670-112">![[0]][0]</span></span>

<span data-ttu-id="3d670-113">在這種架構中，NVA 會檢查所有輸入和輸出的網路流量，並僅傳遞符合網路安全性規則的流量，藉此提供安全的網路界限。</span><span class="sxs-lookup"><span data-stu-id="3d670-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="3d670-114">不過，由於所有網路流量都必須通過 NVA，這也代表 NVA 會成為網路中的單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="3d670-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="3d670-115">如果 NVA 失敗，網路流量就沒有其他路徑，導致所有後端子網路都無法使用。</span><span class="sxs-lookup"><span data-stu-id="3d670-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="3d670-116">若要讓 NVA 具高可用性，請在可用性設定組中部署多個 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="3d670-117">下列架構描述高可用性 NVA 所需的資源和設定：</span><span class="sxs-lookup"><span data-stu-id="3d670-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

<!-- markdownlint-disable MD033 -->

| <span data-ttu-id="3d670-118">方案</span><span class="sxs-lookup"><span data-stu-id="3d670-118">Solution</span></span> | <span data-ttu-id="3d670-119">優點</span><span class="sxs-lookup"><span data-stu-id="3d670-119">Benefits</span></span> | <span data-ttu-id="3d670-120">考量</span><span class="sxs-lookup"><span data-stu-id="3d670-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3d670-121">[具第 7 層 NVA 的輸入][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="3d670-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="3d670-122">所有 NVA 節點都是作用中狀態</span><span class="sxs-lookup"><span data-stu-id="3d670-122">All NVA nodes are active</span></span> |<span data-ttu-id="3d670-123">需要可以終止連線並使用 SNAT 的 NVA</span><span class="sxs-lookup"><span data-stu-id="3d670-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="3d670-124">需要另外一組 NVA 以供來自網際網路與 Azure 流量使用</span><span class="sxs-lookup"><span data-stu-id="3d670-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="3d670-125">僅能用於源自於 Azure 外部的流量</span><span class="sxs-lookup"><span data-stu-id="3d670-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="3d670-126">[第 7 層 NVA 的輸出][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="3d670-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="3d670-127">所有 NVA 節點都是作用中狀態</span><span class="sxs-lookup"><span data-stu-id="3d670-127">All NVA nodes are active</span></span> | <span data-ttu-id="3d670-128">需要可以終止連線並實作來源網路位址轉譯 (SNAT) 的 NVA</span><span class="sxs-lookup"><span data-stu-id="3d670-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="3d670-129">[具第 7 層 NVA 的輸入-輸出][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="3d670-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="3d670-130">所有節點都是作用中狀態</span><span class="sxs-lookup"><span data-stu-id="3d670-130">All nodes are active</span></span><br/><span data-ttu-id="3d670-131">能夠處理來自 Azure 中的流量</span><span class="sxs-lookup"><span data-stu-id="3d670-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="3d670-132">需要可以終止連線並使用 SNAT 的 NVA</span><span class="sxs-lookup"><span data-stu-id="3d670-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="3d670-133">需要另外一組 NVA 以供來自網際網路與 Azure 流量使用</span><span class="sxs-lookup"><span data-stu-id="3d670-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="3d670-134">[PIP-UDR 切換][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="3d670-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="3d670-135">針對所有流量使用一組 NVA</span><span class="sxs-lookup"><span data-stu-id="3d670-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="3d670-136">可以處理所有流量 (連接埠規則沒有限制)</span><span class="sxs-lookup"><span data-stu-id="3d670-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="3d670-137">主動-被動</span><span class="sxs-lookup"><span data-stu-id="3d670-137">Active-passive</span></span><br/><span data-ttu-id="3d670-138">需要容錯移轉程序</span><span class="sxs-lookup"><span data-stu-id="3d670-138">Requires a failover process</span></span> |
| [<span data-ttu-id="3d670-139">沒有 SNAT 的 PIP-UDR</span><span class="sxs-lookup"><span data-stu-id="3d670-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="3d670-140">針對所有流量使用一組 NVA</span><span class="sxs-lookup"><span data-stu-id="3d670-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="3d670-141">可以處理所有流量 (連接埠規則沒有限制)</span><span class="sxs-lookup"><span data-stu-id="3d670-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="3d670-142">不需要對傳入要求設定 SNAT</span><span class="sxs-lookup"><span data-stu-id="3d670-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="3d670-143">主動-被動</span><span class="sxs-lookup"><span data-stu-id="3d670-143">Active-passive</span></span><br/><span data-ttu-id="3d670-144">需要容錯移轉程序</span><span class="sxs-lookup"><span data-stu-id="3d670-144">Requires a failover process</span></span><br/><span data-ttu-id="3d670-145">在虛擬網路外部執行探查和容錯移轉邏輯</span><span class="sxs-lookup"><span data-stu-id="3d670-145">Probing and failover logic run outside the virtual network</span></span> |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="3d670-146">具第 7 層 NVA 的輸入</span><span class="sxs-lookup"><span data-stu-id="3d670-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="3d670-147">下圖所示範的高可用性架構會在面向網際網路的負載平衡器後方實作輸入 DMZ。</span><span class="sxs-lookup"><span data-stu-id="3d670-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="3d670-148">此架構設計成可針對第 7 層流量 (例如 HTTP 或 HTTPS) 提供與 Azure 工作負載的連線：</span><span class="sxs-lookup"><span data-stu-id="3d670-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="3d670-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="3d670-149">![[1]][1]</span></span>

<span data-ttu-id="3d670-150">這個架構的優點是所有 NVA 都處於作用中狀態，而且如果其中一個失敗，負載平衡器就會將網路流量導向其他 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="3d670-151">兩個 NVA 都會將流量路由傳送到內部負載平衡器，因此只要有一個 NVA 處於作用中狀態，流量就會繼續流動。</span><span class="sxs-lookup"><span data-stu-id="3d670-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="3d670-152">需要這些 NVA 以終止適用於 Web 層 VM 的 SSL 流量。</span><span class="sxs-lookup"><span data-stu-id="3d670-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="3d670-153">您無法擴充這些 NVA 以處理內部部署流量，因為內部部署流量需要另一組具有個別網路路由的專用 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="3d670-154">此架構用於 [Azure 與內部部署資料中心之間的 DMZ][dmz-on-premises] 參考架構，以及 [Azure 與網際網路之間的 DMZ][dmz-internet] 參考架構。</span><span class="sxs-lookup"><span data-stu-id="3d670-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-premises] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="3d670-155">這兩個參考架構皆包含您可以使用的部署解決方案。</span><span class="sxs-lookup"><span data-stu-id="3d670-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="3d670-156">如需詳細資訊，請遵循上述連結。</span><span class="sxs-lookup"><span data-stu-id="3d670-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="3d670-157">具第 7 層 NVA 的輸出</span><span class="sxs-lookup"><span data-stu-id="3d670-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="3d670-158">您可以擴充上述的架構，以針對源自 Azure 工作負載的要求提供輸出 DMZ。</span><span class="sxs-lookup"><span data-stu-id="3d670-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="3d670-159">下方架構旨在能於 DMZ 中為第 7 層的流量 (如 HTTP 或 HTTPS) 提供 NVA 的高可用性：</span><span class="sxs-lookup"><span data-stu-id="3d670-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="3d670-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="3d670-160">![[2]][2]</span></span>

<span data-ttu-id="3d670-161">在此架構中，源自 Azure 中的所有流量都會路由傳送至內部負載平衡器。</span><span class="sxs-lookup"><span data-stu-id="3d670-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="3d670-162">負載平衡器會在一組 NVA 之間散發連出要求。</span><span class="sxs-lookup"><span data-stu-id="3d670-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="3d670-163">這些 NVA 會使用個別的公用 IP 位址，將流量導向網際網路。</span><span class="sxs-lookup"><span data-stu-id="3d670-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="3d670-164">此架構用於 [Azure 與內部部署資料中心之間的 DMZ][dmz-on-premises] 參考架構，以及 [Azure 與網際網路之間的 DMZ][dmz-internet] 參考架構。</span><span class="sxs-lookup"><span data-stu-id="3d670-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-premises] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="3d670-165">這兩個參考架構皆包含您可以使用的部署解決方案。</span><span class="sxs-lookup"><span data-stu-id="3d670-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="3d670-166">如需詳細資訊，請遵循上述連結。</span><span class="sxs-lookup"><span data-stu-id="3d670-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="3d670-167">具第 7 層 NVA 的輸入-輸出</span><span class="sxs-lookup"><span data-stu-id="3d670-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="3d670-168">在先前的兩個架構中，針對輸入和輸出皆具有個別的 DMZ。</span><span class="sxs-lookup"><span data-stu-id="3d670-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="3d670-169">下列架構會示範如何建立可同時用於針對第 7 層流量 (例如 HTTP 或 HTTPS) 之輸入和輸出的 DMZ：</span><span class="sxs-lookup"><span data-stu-id="3d670-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="3d670-171">在此架構中，NVA 會處理來自應用程式閘道的連入要求。</span><span class="sxs-lookup"><span data-stu-id="3d670-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="3d670-172">NVA 也會處理來自負載平衡器後端集區中之工作負載 VM 的連出要求。</span><span class="sxs-lookup"><span data-stu-id="3d670-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="3d670-173">因為連入流量會透過應用程式閘道進行路由傳送，而連出流量則會透過負載平衡器進行路由傳送，因此 NVA 會負責維護工作階段親和性。</span><span class="sxs-lookup"><span data-stu-id="3d670-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="3d670-174">亦即，應用程式閘道會維護傳入和傳出要求的對應，使它可以將正確的回應轉送到原始要求者。</span><span class="sxs-lookup"><span data-stu-id="3d670-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="3d670-175">不過，內部負載平衡器並無法存取應用程式閘道對應，並會使用自己的邏輯來將回應傳送到 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="3d670-176">負載平衡器有可能會將回應傳送給從未接收到來自應用程式閘道之要求的 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="3d670-177">在此情況下，NVA 必須彼此進行通訊並傳輸回應，使正確的 NVA 可以將回應轉送至應用程式閘道。</span><span class="sxs-lookup"><span data-stu-id="3d670-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="3d670-178">您也可以透過確保 NVA 執行輸入來源網路位址轉譯 (SNAT)，來解決非對稱的路由問題。</span><span class="sxs-lookup"><span data-stu-id="3d670-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="3d670-179">這會將要求者的原始來源 IP 取代為 NVA 用於輸入流量的其中一個 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3d670-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="3d670-180">如此可確保您能夠一次使用多個 NVA，同時保留路由對稱性。</span><span class="sxs-lookup"><span data-stu-id="3d670-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="3d670-181">具第 4 層 NVA 的 PIP-UDR 切換</span><span class="sxs-lookup"><span data-stu-id="3d670-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="3d670-182">下列架構示範具有一個主動 NVA 和一個被動 NVA 的架構。</span><span class="sxs-lookup"><span data-stu-id="3d670-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="3d670-183">此架構可同時處理第 4 層流量的輸入和輸出：</span><span class="sxs-lookup"><span data-stu-id="3d670-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="3d670-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="3d670-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="3d670-185">適用於此架構的完整解決方案可在 [GitHub][pnp-ha-nva] 上取得。</span><span class="sxs-lookup"><span data-stu-id="3d670-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="3d670-186">此架構與本文中所討論的第一個架構類似。</span><span class="sxs-lookup"><span data-stu-id="3d670-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="3d670-187">該架構包含會接受和篩選第 4 層連入要求的單一 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="3d670-188">此架構會新增另一個被動 NVA，以提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="3d670-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="3d670-189">如果主動 NVA 失敗，被動 NVA 就會變成主動狀態，且 UDR 與 PIP 會變更為指向新主動 NVA 的 NIC。</span><span class="sxs-lookup"><span data-stu-id="3d670-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="3d670-190">您可以手動完成 UDR 與 PIP 的變更，也可以使用自動化程序來完成。</span><span class="sxs-lookup"><span data-stu-id="3d670-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="3d670-191">自動化程序通常是在 Azure 中執行的精靈或其他監控服務。</span><span class="sxs-lookup"><span data-stu-id="3d670-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="3d670-192">它會查詢主動 NVA 上的健康情況探查，並在偵測到 NVA 失敗時，執行 UDR 與 PIP 的切換。</span><span class="sxs-lookup"><span data-stu-id="3d670-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="3d670-193">上圖顯示提供高可用性精靈的 [ZooKeeper][zookeeper] 叢集範例。</span><span class="sxs-lookup"><span data-stu-id="3d670-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="3d670-194">在 ZooKeeper 叢集內，節點仲裁會選出一個前置節點。</span><span class="sxs-lookup"><span data-stu-id="3d670-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="3d670-195">如果前置節點失敗，剩餘的節點會再次選出一個新的前置節點。</span><span class="sxs-lookup"><span data-stu-id="3d670-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="3d670-196">針對這個架構，前置節點會執行在 NVA 上查詢健康情況端點的精靈。</span><span class="sxs-lookup"><span data-stu-id="3d670-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="3d670-197">如果 NVA 無法回應健康情況探查，精靈就會啟動被動 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="3d670-198">接著，精靈會呼叫 Azure REST API，以將 PIP 從失敗的 NVA 移除，然後將其附加至新的主動 NVA。</span><span class="sxs-lookup"><span data-stu-id="3d670-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="3d670-199">之後，精靈會將 UDR 修改為指向新主動 NVA 的內部 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3d670-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="3d670-200">請不要將 ZooKeeper 節點包含在僅能使用包含 NVA 的路由進行存取的子網路中。</span><span class="sxs-lookup"><span data-stu-id="3d670-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="3d670-201">否則，如果 NVA 失敗，就無法存取 ZooKeeper 節點。</span><span class="sxs-lookup"><span data-stu-id="3d670-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="3d670-202">如果精靈因為任何原因而失敗，您將無法存取任何 ZooKeeper 節點來診斷問題。</span><span class="sxs-lookup"><span data-stu-id="3d670-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="3d670-203">若要查看包括程式碼範例的完整解決方案，請參閱 [GitHub 存放庫][pnp-ha-nva]中的檔案。</span><span class="sxs-lookup"><span data-stu-id="3d670-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="3d670-204">沒有 SNAT 的 PIP-UDR NVA</span><span class="sxs-lookup"><span data-stu-id="3d670-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="3d670-205">此架構使用兩個 Azure 虛擬機器來裝載採主動-被動組態且支援自動容錯移轉的 NVA 防火牆，但不需要來源網路位址轉譯 (SNAT)。</span><span class="sxs-lookup"><span data-stu-id="3d670-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![沒有 SNAT 的 PIP-UDR NVA 架構](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="3d670-207">適用於此架構的完整解決方案可在 [GitHub][ha-nva-fo] 上取得。</span><span class="sxs-lookup"><span data-stu-id="3d670-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="3d670-208">此解決方案適用於無法在其 NVA 防火牆上為輸入要求設定 SNAT 的 Azure 客戶。</span><span class="sxs-lookup"><span data-stu-id="3d670-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="3d670-209">SNAT 會隱藏原始的來源用戶端 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3d670-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="3d670-210">如果您必須記錄原始 IP，或在 NVA 後方的其他多層式安全性元件中使用原始 IP，此解決方案會提供基本方法。</span><span class="sxs-lookup"><span data-stu-id="3d670-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="3d670-211">UDR 資料表項目的容錯移轉會由下一個躍點位址自動執行，此位址會設定為使用中 NVA 防火牆虛擬機器上一個介面的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3d670-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="3d670-212">自動容錯移轉邏輯會由您使用 [Azure Functions](/azure/azure-functions/) 建立的函式應用程式來主控。</span><span class="sxs-lookup"><span data-stu-id="3d670-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="3d670-213">在 Azure Functions 中，容錯移轉程式碼會以無伺服器函式的形式執行。</span><span class="sxs-lookup"><span data-stu-id="3d670-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="3d670-214">維護及自訂部署既方便又符合成本效益，而且相當容易。</span><span class="sxs-lookup"><span data-stu-id="3d670-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="3d670-215">此外，函式應用程式託管在 Azure Functions 內，因此在虛擬網路上沒有相依性。</span><span class="sxs-lookup"><span data-stu-id="3d670-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="3d670-216">如果虛擬網路的變更影響到 NVA 防火牆，函式應用程式會繼續獨立執行。</span><span class="sxs-lookup"><span data-stu-id="3d670-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="3d670-217">測試也會更精確，因為測試會使用與輸入用戶端要求相同的路由在虛擬網路外部進行。</span><span class="sxs-lookup"><span data-stu-id="3d670-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="3d670-218">若要檢查 NVA 防火牆的可用性，函式應用程式的程式碼會以下列其中一種方式探查該防火牆：</span><span class="sxs-lookup"><span data-stu-id="3d670-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="3d670-219">監視裝載 NVA 防火牆的 Azure 虛擬機器狀態。</span><span class="sxs-lookup"><span data-stu-id="3d670-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="3d670-220">測試是否有開啟的連接埠可穿過防火牆連線到後端 Web 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3d670-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="3d670-221">針對此選項，NVA 必須透過 PIP 公開通訊端，才能讓函式應用程式的程式碼進行測試。</span><span class="sxs-lookup"><span data-stu-id="3d670-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="3d670-222">您可以在設定函式應用程式時選擇要使用的探查類型。</span><span class="sxs-lookup"><span data-stu-id="3d670-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="3d670-223">若要查看包括程式碼範例的完整解決方案，請參閱 [GitHub 存放庫][ha-nva-fo]中的檔案。</span><span class="sxs-lookup"><span data-stu-id="3d670-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="3d670-224">後續步驟</span><span class="sxs-lookup"><span data-stu-id="3d670-224">Next steps</span></span>

- <span data-ttu-id="3d670-225">了解如何使用第 7 層 NVA [在 Azure 與內部部署資料中心之間實作 DMZ][dmz-on-premises]。</span><span class="sxs-lookup"><span data-stu-id="3d670-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-premises] using layer-7 NVAs.</span></span>
- <span data-ttu-id="3d670-226">了解如何使用第 7 層 NVA [在 Azure 與網際網路之間實作 DMZ][dmz-internet]。</span><span class="sxs-lookup"><span data-stu-id="3d670-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="3d670-227">針對 Azure 中的網路虛擬設備問題進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="3d670-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-premises]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "單一 NVA 架構"
[1]: ./images/nva-ha/l7-ingress.png "第 7 層輸入"
[2]: ./images/nva-ha/l7-ingress-egress.png "第 7 層輸出"
[3]: ./images/nva-ha/active-passive.png "主動-被動叢集"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
